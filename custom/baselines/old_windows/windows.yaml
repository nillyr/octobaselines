- id: 1
  name: Low level
  checkpoints:
    - id: 1
      title: Low level
      description: Checking the boot options and other security settings
      collection_cmd: >
        bcdedit.exe /enum | Out-File -Encoding utf8 -Append -FilePath boot_options.txt;
        msinfo32.exe /report msinfo32_report.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: Secure Boot is enabled
          description:
            Secure Boot is a standard that ensures systems boot only to a
            trusted operating system. Secure Boot is required to support additional
            security features in Windows 10, including Virtualization Based Security
            and Credential Guard. If Secure Boot is turned off, these security features
            will not function.
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Confirm-SecureBootUEFI -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: true
          verification_type: CHECK_EXACT
          severity: low
          level: minimal
          recommendation_on_failed: Enable Secure Boot in the system firmware.
        - id: 2
          title: Data Execution Prevention (DEP)
          description:
            Data Execution Prevention (DEP) prevents harmful code from running
            in protected memory locations reserved for Windows and other programs.
          type: AUDIT_POWERSHELL
          cmd: bcdedit.exe /enum "{current}" | Select-string "nx"
          expected: nx[\s]*(OptOut|AlwaysOn)
          verification_type: CHECK_REGEX
          severity: high
          level: minimal
          recommendation_on_failed: >
            Configure Data Execution Prevention (DEP) to at least "OptOut" (better: "AlwaysOn").

            BitLocker must be suspended before making changed to the DEP configuration.

            <x>bcdedit.exe /set {current} nx OptOut</x>
        - id: 3
          title: Registry - Kernel DMA Protection is enabled (N/A si présent dans msinfo32)
          description: >
            Kernel DMA Protection to protect PCs against drive-by Direct Memory Access (DMA) attacks using PCI hot plug devices connected to thunderbolt 3 ports. Drive-by DMA attacks can lead to disclosure of sensitive information residing on a PC, or even injection of malware that allows attackers to bypass the lock screen or control PCs remotely.
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\Software\Policies\Microsoft\Windows\Kernel DMA Protection" -Name "DeviceEnumerationPolicy" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 0
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for <x>Computer Configuration >> Administrative Templates >> System >> Kernel DMA Protection >> "Enumeration policy for external devices incompatible with Kernel DMA Protection" to "Enabled" with "Enumeration Policy" set to "Block All"</x>.
        - id: 4
          title: MSINFO32 - Kernel DMA Protection is enabled
          description: >
            Kernel DMA Protection to protect PCs against drive-by Direct Memory Access (DMA) attacks using PCI hot plug devices connected to thunderbolt 3 ports. Drive-by DMA attacks can lead to disclosure of sensitive information residing on a PC, or even injection of malware that allows attackers to bypass the lock screen or control PCs remotely.
          type: AUDIT_POWERSHELL
          cmd: $( try { Wait-Process -Name msinfo32 -ErrorAction Silent; $lang = (Get-ItemPropertyValue -Path "HKLM:\SYSTEM\ControlSet001\Control\Nls\Language" -Name "InstallLanguage"); $dma_pattern = "Kernel DMA Protection"; If ($lang -eq "040C") { $dma_pattern = "Protection DMA du noyau"}; Select-String -Path $basedir\Low_level\msinfo32_report.txt -Pattern $dma_pattern } catch { echo $Error[0] } )
          expected: (Protection\s+DMA\s+du\s+noyau|Kernel\s+DMA\s+Protection)\s*(Activé|On)
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for <x>Computer Configuration >> Administrative Templates >> System >> Kernel DMA Protection >> "Enumeration policy for external devices incompatible with Kernel DMA Protection" to "Enabled" with "Enumeration Policy" set to "Block All"</x>.
        - id: 5
          title: Credential Guard is running on domain-joined systems
          description: >
            <x>FIXME_AUDITOR THIS IS N/A FOR VDI</x>

            Credential Guard uses virtualization based security to protect information that could be used in credential theft attacks if compromised. This authentication information, which was stored in the Local Security Authority (LSA) in previous versions of Windows, is isolated from the rest of operating system and can only be accessed by privileged system software.
          type: AUDIT_POWERSHELL
          cmd: (Get-CimInstance -ClassName Win32_DeviceGuard -Namespace root\Microsoft\Windows\DeviceGuard).RequiredSecurityProperties
          expected: 1
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for <x>Computer Configuration >> Administrative Templates >> System >> Device Guard >> "Turn On Virtualization Based Security" to "Enabled" with "Enabled with UEFI lock" selected for "Credential Guard Configuration:"</x>.
    - id: 2
      title: Structured Exception Handling Overwrite Protection (SEHOP)
      description: >
        Attackers are constantly looking for vulnerabilities in systems and applications. Structured Exception Handling Overwrite Protection (SEHOP) blocks exploits that use the Structured Exception Handling overwrite technique, a common buffer overflow attack.
      collection_cmd: $(try { $value = (Get-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\kernel" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath sehop.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: SEHOP is turned on
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\kernel" -Name "DisableExceptionChainValidation" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 0
          verification_type: CHECK_EXACT
          severity: high
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for <x>Computer Configuration >> Administrative Templates >> MS Security Guide >> "Enable Structured Exception Handling Overwrite Protection (SEHOP)" to "Enabled"</x>.
    - id: 3
      title: Bitlocker status
      description: Checking the status of Bitlocker
      collection_cmd: $(If (Test-CommandExists manage-bde) {manage-bde -status } Else { "Command not found" }) | Out-File -Encoding utf8 -Append -FilePath bitlocker_status.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: All disks encrypted
          description: >
            <x>FIXME_AUDITOR CHECK FOR ANOTHER TOOLS IF FAILED (CRYHOD/ETC.)</x>

            If data at rest is unencrypted, it is vulnerable to disclosure. Even if the operating system enforces permissions on data access, an adversary can remove non-volatile memory and read it directly, thereby circumventing operating system controls. Encrypting the data ensures that confidentiality is protected even when the operating system is not running.
          type: AUDIT_POWERSHELL
          cmd: $( try { $volumes = (Get-BitLockerVolume -ErrorAction Stop); If ($volumes | Where {$_.ProtectionStatus -ne 'On'}) { 'Fail' } Else { 'Success' } } catch { echo $Error[0] } )
          expected: Success
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            Enable full disk encryption on all information systems using BitLocker. BitLocker, included in Windows, can be enabled in the Control Panel under "BitLocker Drive Encryption" as well as other management tools.
    - id: 4
      title: Bitlocker configuration
      description: >
        Verify disk encryption
        Voir aussi :
        * https://learn.microsoft.com/en-us/windows/security/information-protection/bitlocker/bitlocker-countermeasures
      collection_cmd: $(try { $value = (Get-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\FVE" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath bitlocker_conf.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: Bitlocker PIN for pre-boot authentication (UseAdvancedStartup)
          description: >
            If data at rest is unencrypted, it is vulnerable to disclosure. Even if the operating system enforces permissions on data access, an adversary can remove non-volatile memory and read it directly, thereby circumventing operating system controls. Encrypting the data ensures that confidentiality is protected even when the operating system is not running. Pre-boot authentication prevents unauthorized users from accessing encrypted drives.
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\SOFTWARE\Policies\Microsoft\FVE" -Name "UseAdvancedStartup" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 1
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for <x>Computer Configuration >> Administrative Templates >> Windows Components >> BitLocker Drive Encryption >> Operating System Drives "Require additional authentication at startup"</x> to </x>"Enabled"</x> with <x>"Configure TPM Startup PIN:"</x> set to <x>"Require startup PIN with TPM"</x> or with <x>"Configure TPM startup key and PIN:"</x> set to <x>"Require startup key and PIN with TPM"</x>.
        - id: 2
          title: Bitlocker PIN for pre-boot authentication (UseTPMPIN)
          description: >
            If data at rest is unencrypted, it is vulnerable to disclosure. Even if the operating system enforces permissions on data access, an adversary can remove non-volatile memory and read it directly, thereby circumventing operating system controls. Encrypting the data ensures that confidentiality is protected even when the operating system is not running. Pre-boot authentication prevents unauthorized users from accessing encrypted drives.
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\SOFTWARE\Policies\Microsoft\FVE" -Name "UseTPMPIN" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: ^\s*(1|2)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for <x>Computer Configuration >> Administrative Templates >> Windows Components >> BitLocker Drive Encryption >> Operating System Drives "Require additional authentication at startup"</x> to </x>"Enabled"</x> with <x>"Configure TPM Startup PIN:"</x> set to <x>"Require startup PIN with TPM"</x> or with <x>"Configure TPM startup key and PIN:"</x> set to <x>"Require startup key and PIN with TPM"</x>.
        - id: 3
          title: Bitlocker PIN for pre-boot authentication (UseTPMKeyPIN)
          description: >
            If data at rest is unencrypted, it is vulnerable to disclosure. Even if the operating system enforces permissions on data access, an adversary can remove non-volatile memory and read it directly, thereby circumventing operating system controls. Encrypting the data ensures that confidentiality is protected even when the operating system is not running. Pre-boot authentication prevents unauthorized users from accessing encrypted drives.
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\SOFTWARE\Policies\Microsoft\FVE" -Name "UseTPMKeyPIN" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: ^\s*(1|2)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for <x>Computer Configuration >> Administrative Templates >> Windows Components >> BitLocker Drive Encryption >> Operating System Drives "Require additional authentication at startup"</x> to </x>"Enabled"</x> with <x>"Configure TPM Startup PIN:"</x> set to <x>"Require startup PIN with TPM"</x> or with <x>"Configure TPM startup key and PIN:"</x> set to <x>"Require startup key and PIN with TPM"</x>.
        - id: 4
          title: Lenght of Bitlocker PIN (MinimumPIN)
          description: >
            If data at rest is unencrypted, it is vulnerable to disclosure. Even if the operating system enforces permissions on data access, an adversary can remove non-volatile memory and read it directly, thereby circumventing operating system controls. Encrypting the data ensures that confidentiality is protected even when the operating system is not running. Pre-boot authentication prevents unauthorized users from accessing encrypted drives. Increasing the pin length requires a greater number of guesses for an attacker.
          type: AUDIT_POWERSHELL
          cmd: reg.exe query "HKLM\SOFTWARE\Policies\Microsoft\FVE" /v "MinimumPIN" 2>$null
          expected: \s*MinimumPIN\s*REG_DWORD\s*0x((?!0-5)$|([6-9]|[a-fA-F]|[1-9][0-9a-fA-F]+))
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for <x>Computer Configuration >> Administrative Templates >> Windows Components >> BitLocker Drive Encryption >> Operating System Drives "Configure minimum PIN length for startup"</x> to <x>"Enabled"</x> with <x>"Minimum characters:"</x> set to "6" or greater.
    - id: 5
      title: Early Launch Antimalware
      description: >
        Ensure that Early Launch Antimalware - Boot-Start Driver Initialization policy is set to enforce "Good, unknown and bad but critical" (preventing "bad").
      collection_cmd: $(try { $value = (Get-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Policies\EarlyLaunch" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath early_launch.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: Driver load policy
          description: >
            By being launched first by the kernel, ELAM (Early Launch Antimalware) is ensured to be launched before any third-party software, and is therefore able to detect malware in the boot process and prevent it from initializing.
          type: AUDIT_POWERSHELL
          cmd: $(try { $status_if_missing = "Success"; $value = (Get-ItemPropertyValue -Path "HKLM:\SYSTEM\CurrentControlSet\Policies\EarlyLaunch" -Name "DriverLoadPolicy" -ErrorAction Stop); echo $value } catch { echo $success_if_missing })
          expected: ^\s*(1|3|8|Success)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            Ensure that Early Launch Antimalware - Boot-Start Driver Initialization policy is set to enforce "Good, unknown and bad but critical" (preventing "bad").
- id: 2
  name: System
  checkpoints:
    - id: 1
      title: Version management
      description: >
        This checkpoint verifies the use of an up-to-date and maintained version of Windows.
      collection_cmd: >
        systeminfo.exe | Out-File -Encoding utf8 -Append -FilePath systeminfo.txt;
        Get-CimInstance SoftwareLicensingProduct -Filter "Name like 'Windows%'" | Where-Object { $_.PartialProductKey } | Format-List | Out-File -Encoding utf8 -Append -FilePath license_information.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: Utilisation d'une version supportée de Windows
          description: Using a version supported by Microsoft allows to get system security updates.
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\Software\Microsoft\Windows Nt\Currentversion" -Name "ProductName" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: Windows\s10
          verification_type: CHECK_REGEX
          severity: high
          level: minimal
          recommendation_on_failed: >
            We recommand using a supported version of Windows 10 Enterprise.
        - id: 2
          title: Use of the enterprise version
          description: >
            The Enterprise version of Windows 10 allows the activation of many security features.
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\Software\Microsoft\Windows Nt\Currentversion" -Name "ProductName" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: (Enterprise|Entreprise)
          verification_type: CHECK_REGEX
          severity: high
          level: minimal
          recommendation_on_failed: We recommend using the Enterprise version of Windows 10.
        - id: 3
          title: La license de Windows est activée
          description: La version de windows doit être activée
          type: AUDIT_POWERSHELL
          cmd: Get-CimInstance SoftwareLicensingProduct -Filter "Name like 'Windows%'" | Where-Object { $_.PartialProductKey } | Select-Object LicenseStatus | Format-List
          expected: LicenseStatus\s*\:\s*1
          verification_type: CHECK_REGEX
          severity: high
          level: minimal
          recommendation_on_failed: >
            Activer la license Windows.
    - id: 2
      title: Gestion des mises à jour
      description: Verification of the installation of security updates
      collection_cmd: >
        $(try { $value = (Get-ItemProperty -Path "HKLM:\Software\Policies\Microsoft\Windows\WindowsUpdate" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath updates_registry_options.txt;
        $(try { $value = (Get-ItemProperty -Path "HKLM:\Software\Policies\Microsoft\Windows\WindowsUpdate\AU" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath updates_registry_options.txt;
        Get-Hotfix | Select-Object -Property Description,HotFixID,InstalledOn | Where-Object { $_.Description -eq "Security Update"} | Out-File -Encoding utf8 -Append -FilePath security_updates.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: Utilisation d'un serveur de mise à jour maîtrisé
          description: >
            FIXME Lien ANSSI admin sécu
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU" -Name "UseWUServer" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 1
          verification_type: CHECK_EXACT
          severity: high
          level: minimal
          recommendation_on_failed: >
            We recommend to force WSUS deployments to use a secured HTTPS channel.
          see_also: https://techcommunity.microsoft.com/t5/windows-it-pro-blog/security-best-practices-for-windows-server-update-services-wsus/ba-p/1587536
        - id: 2
          title: Utilisation d'un canal de communication sécurisé
          description: >
            When using an update server, it is important to ensure the security of the exchanges. Otherwise, an attacker could install a malicious program that will be installed with SYSTEM rights.
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\Software\Policies\Microsoft\Windows\WindowsUpdate" -Name "WUServer" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: https://
          verification_type: CHECK_REGEX
          severity: high
          level: minimal
          recommendation_on_failed: >
            We recommend to force WSUS deployments to use a secured HTTPS channel.
          see_also: https://techcommunity.microsoft.com/t5/windows-it-pro-blog/security-best-practices-for-windows-server-update-services-wsus/ba-p/1587536
    - id: 3
      title: Inclusion in the domain
      description: Verifies that the workstation is included in the domain so that it can be managed globally.
      collection_cmd: $(try { $value = (Get-ItemProperty -Path "HKLM:\System\CurrentControlSet\Services\Tcpip\Parameters" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath domaine_tcpip.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: The workstation is included in a domain
          description: The inclusion of a machine in the domain allows to manage it (deployment of group policies, security maintenance, etc.).
          type: AUDIT_POWERSHELL
          cmd: (Get-WmiObject -Class Win32_ComputerSystem).PartOfDomain
          expected: true
          verification_type: CHECK_EXACT
          severity: info
          level: minimal
          recommendation_on_failed: We recommend adding the machine to the domain.
- id: 3
  name: Peripherals
  checkpoints:
    - id: 1
      title: Logical volumes
      description: Local volumes must be formatted using NTFS.
      collection_cmd: Get-WmiObject -Namespace root\cimv2 -Class Win32_LogicalDisk | Select-Object -Property * | Out-File -Encoding utf8 -Append -FilePath logical_disk.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: All disks are formatted using NTFS
          description: >
            In order to maintain security and proper access control, the ability to set access permissions and auditing is critical. To support that,
            the volumes must be formatted using the NTFS file system.
          type: AUDIT_POWERSHELL
          cmd: $($volumes = Get-WmiObject -Namespace root\cimv2 -Class Win32_LogicalDisk | Select-Object -Property MediaType, FileSystem; If ($volumes | Where {$_.MediaType -eq '12' -And $_.FileSystem -ne 'NTFS'}) { 'Fail' } Else { 'Success' })
          expected: Success
          verification_type: CHECK_EXACT
          severity: high
          level: minimal
          recommendation_on_failed: We recommand formatting every local volume using NTFS file system.
    - id: 2
      title: Peripherals Policy
      description: AutoPlay must be disabled
      collection_cmd: $(try { $value = (Get-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\policies\Explorer" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath peripheral_policy.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: AutoPlay is disabled for all drives
          description: >
            Allowing <x>autoplay</x> to execute may introduce malicious code to a system. <x>Autoplay</x> begins reading from a drive as soon as you insert media in the drive. As a result, the setup file of programs or music on audio media may start. By default, <x>autoplay</x> is disabled on removable drives, such as the floppy disk drive (but not the CD-ROM drive) and on network drives.
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\policies\Explorer" -Name "NoDriveTypeAutoRun" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 255
          verification_type: CHECK_EXACT
          severity: high
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for <x>Computer Configuration >> Administrative Templates >> Windows Components >> AutoPlay Policies >> "Turn off AutoPlay"</x> to <x>"Enabled:All Drives"</x>.
        - id: 2
          title: AutoPlay is disabled for non-volume devices
          description: >
            FIXME
            Voir aussi :
            * https://stigviewer.com/stig/microsoft_windows_server_2019/2022-03-01/finding/V-205804
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\policies\Explorer" -Name "NoAutoplayfornonVolume" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 1
          verification_type: CHECK_EXACT
          severity: high
          level: minimal
          recommendation_on_failed: >
            FIXME
    - id: 3
      title: Périphériques externes
      description: >
        Vérification de la configuration des périphériques USB
        Voir aussi :
        * http://woshub.com/how-to-disable-usb-drives-using-group-policy/
      collection_cmd: >
        $(try { $value0 = (Get-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\services\USBSTOR" -ErrorAction SilentlyContinue); $value1 = (Get-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Enum\USBSTOR\*\*" -ErrorAction SilentlyContinue | Select FriendlyName) } catch { echo $Error[0] }; echo $value0 "----------------" $value1) | Out-File -Encoding utf8 -Append -FilePath usbstor.txt;
        $(try { $value0 = (Get-ItemProperty -Path "HKCU:\SOFTWARE\Policies\Microsoft\Windows\RemovableStorageDevices" -ErrorAction SilentlyContinue); $value1 = (Get-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\RemovableStorageDevices" -ErrorAction SilentlyContinue) } catch { echo $Error[0] }; echo $value0 "----------------" $value1) | Out-File -Encoding utf8 -Append -FilePath removable_storage_devices.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: L'utilisation de clés USB est bloquée
          description: >
            Impossible d'utiliser des clés USB.
            Voir aussi :
            * https://support.microsoft.com/en-us/topic/how-can-i-prevent-users-from-connecting-to-a-usb-storage-device-460ef516-8ac8-07af-e90b-0d9ac55bcd4d
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\SYSTEM\CurrentControlSet\services\USBSTOR" -Name "Start" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 4
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 2
          title: L'installation de nouveaux drivers est bloquée (manuel)
          description: Impossibilité pour tout utilisateur d'installer de nouveaux drivers.
          type: AUDIT_POWERSHELL
          cmd: $(try { $acls = (Get-Acl -Path $env:systemroot\INF\usbstor.* -ErrorAction SilentlyContinue); ForEach ($acl in $acls) { echo ""; echo $acl.Path; ConvertFrom-SddlString -Sddl $acl.Sddl | ForEach-Object { $_.DiscretionaryAcl } } } catch { echo $Error[0] })
          expected: ""
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
- id: 4
  name: Local Users
  checkpoints:
    - id: 1
      title: Utilisateurs locaux
      description: List local users of the workstation
      collection_cmd: Get-WmiObject -Namespace root\cimv2 -Class Win32_UserAccount -Filter "LocalAccount='True'" | Select-Object -Property * | Out-File -Encoding utf8 -Append -FilePath local_users.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: Accounts must be configured to require password expiration
          description: Passwords that do not expire increase exposure with a greater probability of being discovered or cracked.
          type: AUDIT_POWERSHELL
          cmd: $($users = Get-WmiObject -Namespace root\cimv2 -Query "SELECT * FROM Win32_UserAccount WHERE LocalAccount='True' AND Disabled='False' AND PasswordExpires='False'" | Measure-Object | Select-Object -Property Count; If ($users | Where { $_.Count -ne '0'}) { 'Failed' } Else { 'Success' })
          expected: Success
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            We recommend configuring all passwords to expire.

            Run <x>"Computer Management"</x>.

            Navigate to <x>System Tools >> Local Users and Groups >> Users</x>.

            Double click each active account.

            Ensure <x>"Password never expires"</x> is not checked on all active accounts.
        - id: 2
          title: Local administrator account is disabled or renamed
          description: >
            The local administration account (RID 500) must be disabled after the machine is enrolled in the active directory.
          type: AUDIT_POWERSHELL
          cmd: $($adm = Get-WmiObject -Namespace root\cimv2 -Query "SELECT * FROM Win32_UserAccount WHERE LocalAccount='True' AND SID LIKE '%500'"; If ($adm | Where { $_.Disabled -eq 'True' -or ( $_.Name -ne "Administrator" -and $_.Name -ne "Administrateur" )}) { 'Success' } Else { 'Failed' })
          expected: Success
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            We recommend disabling the local administrator account (RID 500). In the event the access to the recovery console or boot in Safe Mode is needed, the account must be manually re-enabled for the session only with the following command:

            <x>net user administrator /active:yes</x>

            It is important to note that disabling this account may have availability impacts in some cases.

            If this account could not be disabled, we recommend renaming it. Renaming this account to an unidentified name improves the protection of this account and the system. In addition, it makes it more difficult for brute force attacks to be attempted and thus for the account to be locked out.

            However, it is important to note that in case the hash of the account is compromised (lateral propagation). The RID of the latter being invariable (RID 500), the recovery of the name is doable.
        - id: 3
          title: Guest account is disabled
          description: >
            A system faces an increased vulnerability threat if the built-in guest account is not disabled.  This account is a known account that exists on all Windows systems and cannot be deleted.  This account is initialized during the installation of the operating system with no password assigned.
          type: AUDIT_POWERSHELL
          cmd:
            $($guest = Get-WmiObject -Namespace root\cimv2 -Query "SELECT * FROM
            Win32_UserAccount WHERE LocalAccount='True' AND SID LIKE '%501'"; If ($guest | Where { $_.Disabled -eq 'True' }) { 'Success' } Else { 'Failed' })
          expected: Success
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            We recommend disabling the built-in guest account.

            Configure the policy value for <x>Computer Configuration >> Windows Settings >> Security Settings >> Local Policies >> Security Options >> "Accounts: Guest account status"</x> to <x>"Disabled"</x>.
    - id: 2
      title: Local groups
      description: List local groups of the workstation
      collection_cmd: Get-WmiObject -Namespace root\cimv2 -Class Win32_Group -Filter "LocalAccount='True'" | Select-Object -Property * | Out-File -Encoding utf8 -Append -FilePath local_groups.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: true
    - id: 3
      title: Administrator local groups
      description: Evaluation of the legitimacy of the accounts in the local group of administrators
      collection_cmd: $(try { $value = (Get-LocalGroupMember -SID "S-1-5-32-544" -ErrorAction Stop); echo $value} catch { echo $Error[0]; $lang = (Get-ItemPropertyValue -Path "HKLM:\SYSTEM\ControlSet001\Control\Nls\Language" -Name "InstallLanguage"); $grp_name = "Administrators"; If ($lang -eq "040C") { $grp_name = "Administrateurs"}; net localgroup $grp_name }) | Out-File -Encoding utf8 -Append -FilePath admin_local_group_members.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: Standard user accounts must not be members of the local administrators group
          description: >
            For domain-joined workstations, administrators must belong to a domain workstation administrator group. Restricting highly privileged accounts from the Local Administrators group helps mitigate the risk of privilege escalation resulting from credential theft attacks.

            Standard user accounts must not be members of the local administrators group.
          type: AUDIT_POWERSHELL
          cmd: $($lang = (Get-ItemPropertyValue -Path "HKLM:\SYSTEM\ControlSet001\Control\Nls\Language" -Name "InstallLanguage"); $grp_name = "Administrators"; If ($lang -eq "040C") { $grp_name = "Administrateurs"}; $admins = Get-WmiObject -Namespace root\cimv2 -Query "SELECT * FROM Win32_GroupUser WHERE GroupComponent=`"Win32_Group.Domain='$env:COMPUTERNAME',Name='$grp_name'`""; $admins | Where { $_.PartComponent -like '*Win32_UserAccount.Domain="'+$env:userdomain+'"*' } | Select-Object -Property PartComponent)
          expected: ""
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            Configure the system to include only administrator groups or accounts that are responsible for the system in the local Administrators group.

            For domain-joined workstations, the Domain Admins group must be replaced by a domain workstation administrator group.

            Remove any standard user accounts.
    - id: 4
      title: Presence of inactive local accounts
      description: >
        The presence of accounts that were last logged in more than 35 days ago may indicate a problem in the management of user accounts and may represent a security risk.
      collection_cmd: ([ADSI]('WinNT://{0}' -f $env:computername)).Children | Where { $_.SchemaClassName -eq 'user' } | ForEach {$user = ([ADSI]$_.Path); $lastLogin = $user.Properties.LastLogin.Value; $enabled = ($user.Properties.UserFlags.Value -band 0x2) -ne 0x2; If ($lastLogin -eq $null) {$lastLogin = 'Never logged'}; Write-Host $user.Name $lastLogin $enabled;} 6> inactive_local_accounts.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: true
- id: 5
  name: User session
  checkpoints:
    - id: 1
      title: Battery power setting
      description: Checking the power parameters
      collection_cmd: >
        powercfg.exe -q | Out-File -Encoding utf8 -Append -FilePath powercfg.txt;
        $(try { $value = (Get-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Power\PowerSettings\0e796bdb-100d-47d6-a2d5-f7d2daa51f51" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath powercfg_reg.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: Users must be prompted for a password on resume from sleep (on battery)
          description: >
            Authentication must always be required when accessing a system. This setting ensures the user is prompted for a password on resume from sleep (on battery).
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\SOFTWARE\Policies\Microsoft\Power\PowerSettings\0e796bdb-100d-47d6-a2d5-f7d2daa51f51" -Name "DCSettingIndex" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 1
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for Computer Configuration >> Administrative Templates >> System >> Power Management >> Sleep Settings >> "Require a password when a computer wakes (on battery)" to "Enabled".
        - id: 2
          title: The user must be prompted for a password on resume from sleep (plugged in)
          description: >
            Authentication must always be required when accessing a system. This setting ensures the user is prompted for a password on resume from sleep (plugged in).
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\SOFTWARE\Policies\Microsoft\Power\PowerSettings\0e796bdb-100d-47d6-a2d5-f7d2daa51f51" -Name "ACSettingIndex" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 1
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for Computer Configuration >> Administrative Templates >> System >> Power Management >> Sleep Settings >> "Require a password when a computer wakes (plugged in)" to "Enabled".
    - id: 2
      title: Restart
      description: Vérification de la possibilité de se connecter avec le compte précédent le redémarrage.
      collection_cmd: $(try { $value = (Get-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath restart_signon.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: Automatically signing in the last interactive user after a system-initiated restart must be disabled
          description: >
            Windows can be configured to automatically sign the user back in after a Windows Update restart. Some protections are in place to help ensure this is done in a secure fashion; however, disabling this will prevent the caching of credentials for this purpose and also ensure the user is aware of the restart.
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -Name "DisableAutomaticRestartSignOn" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 1
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for Computer Configuration >> Administrative Templates >> Windows Components >> Windows Logon Options >> "Sign-in last interactive user automatically after a system-initiated restart" to "Disabled".
    - id: 3
      title: Lock screen personalization
      description: Checking the lock screen personalization
      collection_cmd: $(try { $value = (Get-ItemProperty -Path "HKLM:\Software\Policies\Microsoft\Windows\Personalization" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath lock_screen_personalization.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: Display of slide shows on the lock screen
          description: >
            Slide shows that are displayed on the lock screen could display sensitive information to unauthorized personnel. Turning off this feature will limit access to the information to a logged on user.
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\Software\Policies\Microsoft\Windows\Personalization" -Name "NoLockScreenSlideshow" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 1
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            We recommand to prevent the display of slide shows that could contain sensitive information to unauthorized personnel.

            Configure the policy value for <x>Computer Configuration >> Administrative Templates >> Control Panel >> Personalization >> "Prevent enabling lock screen slide show"</x> to <x>"Enabled"</x>.
        - id: 2
          title: Camera access from the lock screen is disabled
          description: >
            <x>FIXME_AUDITOR : if the workstation does not have a camera this is N/A</x>

            Enabling camera access from the lock screen could allow for unauthorized use. Requiring logon will ensure the device is only used by authorized personnel.
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\Software\Policies\Microsoft\Windows\Personalization" -Name "NoLockScreenCamera" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 1
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            We recommend not to enabling camera access from the lock screen.

            Configure the policy value for <x>Computer Configuration >> Administrative Templates >> Control Panel >> Personalization >> "Prevent enabling lock screen camera"</x> to <x>"Enabled"</x>.
    - id: 4
      title: The machine inactivity limit must be set to 15 minutes
      description: Unattended systems are susceptible to unauthorized use and should be locked when unattended.
      collection_cmd: $(try { $value = (Get-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath lock_screen.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: Registre - Le temps d'inactivité est limité à 15 min
          description: >
            Unattended systems are susceptible to unauthorized use and should be locked when unattended. The screen saver should be set at a maximum of 15 minutes and be password protected. This protects critical and sensitive data from exposure to unauthorized personnel with physical access to the computer.

            Note : cette valeur peut également être présente dans le temps de veille (PDT).
          type: AUDIT_POWERSHELL
          cmd: reg.exe query "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" /v "InactivityTimeoutSecs" 2>$null
          expected: \s*InactivityTimeoutSecs\s*REG_DWORD\s*0x([1-9]|[1-8]\d{1,2}|900)\b"
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for <x>Computer Configuration >> Windows Settings >> Security Settings >> Local Policies >> Security Options >> "Interactive logon: Machine inactivity limit"</x> to "900 seconds" or less, excluding "0" which is effectively disabled.
    - id: 5
      title: Cached logon session
      description: Caching of logon credentials must be limited
      collection_cmd: $(try { $value = (Get-ItemProperty -Path "HKLM:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath winlogon.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: Number of cached logon sessions
          description: >
            The default Windows configuration caches the last logon credentials for users who log on interactively to a system. This feature is provided for system availability reasons, such as the user's machine being disconnected from the network or domain controllers being unavailable. Even though the credential cache is well-protected, if a system is attacked, an unauthorized individual may isolate the password to a domain user account using a password-cracking program and gain access to the domain.
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon" -Name "CachedLogonsCount" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: ^\s*[0-2]\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            We recommand setting the number of cached logons credentials to at most 2.

            Configure the policy value for <x>Computer Configuration >> Windows Settings >> Security Settings >> Local Policies >> Security Options >> "Interactive logon: Number of previous logons to cache (in case domain controller is not available)"</x> to 2 or less.
- id: 6
  name: Policies
  checkpoints:
    - id: 1
      title: GPO
      description: >
        Retrieving Group Policy Objects for analysis
      collection_cmd: >
        gpresult.exe /Scope computer /H gpo_computer_only.html;
        gpresult.exe /H gpo_global.html
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: true
    - id: 2
      title: Security policies
      description: Retrieving security policies for analysis
      collection_cmd: secedit.exe /export /cfg security_policies.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: Reversible password encryption is disabled
          description: >
            Storing passwords using reversible encryption is essentially the same as storing clear-text versions of the passwords. For this reason, this policy must never be enabled.
          type: AUDIT_POWERSHELL
          cmd: Select-String -Path $basedir\Policies\security_policies.txt -Pattern "ClearTextPassword"
          expected: .*ClearTextPassword\s=\s0
          verification_type: CHECK_REGEX
          severity: high
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for <x>Computer Configuration >> Windows Settings >> Security Settings >> Account Policies >> Password Policy >> "Store passwords using reversible encryption"</x> to <x>"Disabled"</x>.
        - id: 2
          title: The Debug programs user right is only assigned to the Administrators group
          description: >
            Inappropriate granting of user rights can provide system, administrative, and other high level capabilities. Accounts with the "Debug Programs" user right can attach a debugger to any process or to the kernel, providing complete access to sensitive and critical operating system components. This right is given to Administrators in the default configuration.
          type: AUDIT_POWERSHELL
          cmd: Select-String -Path $basedir\Policies\security_policies.txt -Pattern "SeDebugPrivilege"
          expected: .*SeDebugPrivilege\s=\s.*\-544
          verification_type: CHECK_REGEX
          severity: high
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for <x>Computer Configuration >> Windows Settings >> Security Settings >> Local Policies >> User Rights Assignment >> "Debug programs"</x> to only include the following groups or accounts: Administrators.
        - id: 3
          title: The Create a token object user right must not be assigned to any groups or accounts
          description: >
            Inappropriate granting of user rights can provide system, administrative, and other high level capabilities. The "Create a token object" user right allows a process to create an access token. This could be used to provide elevated rights and compromise a system.
          type: AUDIT_POWERSHELL
          cmd: Select-String -Path $basedir\Policies\security_policies.txt -Pattern "SeCreateTokenPrivilege"
          expected: ""
          verification_type: CHECK_EXACT
          severity: high
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for <x>Computer Configuration >> Windows Settings >> Security Settings >> Local Policies >> User Rights Assignment >> "Create a token object"</x> to be defined but containing no entries (blank).
        - id: 4
          title: The <x>Act as part of the operating system</x> user right must not be assigned to any groups or accounts
          description: >
            Inappropriate granting of user rights can provide system, administrative, and other high level capabilities.

            Accounts with the <x>"Act as part of the operating system"</x> user right can assume the identity of any user and gain access to resources that user is authorized to access.  Any accounts with this right can take complete control of a system.
          type: AUDIT_POWERSHELL
          cmd: Select-String -Path $basedir\Policies\security_policies.txt -Pattern "SeTcbPrivilege"
          expected: ""
          verification_type: CHECK_EXACT
          severity: high
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for <x>Computer Configuration >> Windows Settings >> Security Settings >> Local Policies >> User Rights Assignment >> "Act as part of the operating system"</x> to be defined but containing no entries (blank).
- id: 7
  name: Passwords
  checkpoints:
    - id: 1
      title: Password policy
      description: Local and domain password policy
      collection_cmd: >
        net accounts | Out-File -Encoding utf8 -Append -FilePath local_passpol.txt;
        $(If ((Get-WmiObject -Class Win32_ComputerSystem).PartOfDomain) { net accounts /domain } Else { echo "Not part of domain" }) | Out-File -Encoding utf8 -Append -FilePath domain_passpol.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: true
    - id: 2
      title: LAPS
      description: Verifies that LAPS is installed on the workstation
      collection_cmd: $(try { $value = (Get-ChildItem "C:\Program Files\LAPS\CSE\Admpwd.dll" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath laps.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: true
    - id: 3
      title: WDigest Authentication
      description: >
        When the WDigest Authentication protocol is enabled, plain text passwords are stored in the Local Security Authority Subsystem Service (LSASS).
      collection_cmd: $(try { $value = (Get-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\Wdigest" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath wdigest.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: WDigest Authentication is disabled
          description: >
            When the WDigest Authentication protocol is enabled, plain text passwords are stored in the Local Security Authority Subsystem Service (LSASS) exposing them to theft. WDigest is disabled by default in Windows 10.
          type: AUDIT_POWERSHELL
          cmd: $(try { $default_value_if_missing = 0; $value = (Get-ItemPropertyValue -Path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\Wdigest" -Name "UseLogonCredential" -ErrorAction Stop); echo $value } catch { echo $default_value_if_missing })
          expected: 0
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            We recommend enforcing this setting.

            Configure the policy value for <x>Computer Configuration >> Administrative Templates >> MS Security Guide >> "WDigest Authentication"</x> to <x>"Disabled"</x>.
    - id: 4
      title: LM and NTLM hash
      description: Verification of the feasibility of a cryptanalysis of password fingerprints.
      collection_cmd: $(try { $value = (Get-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath lsa.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: Storage of the LAN Manager hash of passwords is prevented
          description: >
            The LAN Manager hash uses a weak encryption algorithm and there are several tools available that use this hash to retrieve account passwords.

            This setting controls whether or not a LAN Manager hash of the password is stored in the SAM the next time the password is changed.
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa" -Name "NoLMHash" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 1
          verification_type: CHECK_EXACT
          severity: high
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for <x>Computer Configuration >> Windows Settings >> Security Settings >> Local Policies >> Security Options >> "Network security: Do not store LAN Manager hash value on next password change"</x> to <x>"Enabled"</x>.
        - id: 2
          title: Niveau d’authentification LAN Manager
          description: >
            The Kerberos v5 authentication protocol is the default for authentication of users who are logging on to domain accounts. NTLM, which is less secure, is retained in later Windows versions for compatibility with clients and servers that are running earlier versions of Windows or applications that still use it. It is also used to authenticate logons to stand-alone computers that are running later versions.

            La valeur par défaut est à adapter en fonction du type d'équipement.

            Voir aussi :
            * https://learn.microsoft.com/fr-fr/windows/security/threat-protection/security-policy-settings/network-security-lan-manager-authentication-level
          type: AUDIT_POWERSHELL
          cmd: $(try { $default_value_if_missing = 5; $value = (Get-ItemPropertyValue -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa" -Name "LmCompatibilityLevel" -ErrorAction Stop); echo $value } catch { echo $default_value_if_missing })
          expected: 5
          verification_type: CHECK_EXACT
          severity: high
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for <x>Computer Configuration >> Windows Settings >> Security Settings >> Local Policies >> Security Options >> "Network security: LAN Manager authentication level"</x> to <x>"Send NTLMv2 response only. Refuse LM & NTLM"</x>.
    - id: 5
      title: Outgoing secure channel traffic
      description: >
        Requests sent on the secure channel are authenticated, and sensitive information (such as passwords) is encrypted, but not all information is encrypted.
      collection_cmd: $(try { $value = (Get-ItemProperty -Path "HKLM:\System\CurrentControlSet\Services\Netlogon\Parameters" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath secure_channel.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: Outgoing secure channel traffic must be encrypted when possible
          description: >
            Requests sent on the secure channel are authenticated, and sensitive information (such as passwords) is encrypted, but not all information is encrypted. If this policy is enabled, outgoing secure channel traffic will be encrypted.
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\System\CurrentControlSet\Services\Netlogon\Parameters" -Name "SealSecureChannel" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 1
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for <x>Computer Configuration >> Windows Settings >> Security Settings >> Local Policies >> Security Options >> "Domain member: Digitally encrypt secure channel data (when possible)"</x> to <x>"Enabled"</x>.
        - id: 2
          title: Outgoing secure channel traffic must be encrypted or signed
          description: >
            Requests sent on the secure channel are authenticated, and sensitive information (such as passwords) is encrypted, but not all information is encrypted. If this policy is enabled, outgoing secure channel traffic will be encrypted and signed.
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\System\CurrentControlSet\Services\Netlogon\Parameters" -Name "RequireSignOrSeal" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 1
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for <x>Computer Configuration >> Windows Settings >> Security Settings >> Local Policies >> Security Options >> "Domain member: Digitally encrypt or sign secure channel data (always)"</x> to <x>"Enabled"</x>.
- id: 8
  name: Permissions
  checkpoints:
    - id: 1
      title: Anonymous permissions
      description: Verification of user and share enumeration rights by anonymous users.
      collection_cmd: $(try { $value = (Get-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath lsa.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: Anonymous enumeration of SAM accounts is not allowed
          description: >
            Anonymous enumeration of SAM accounts allows anonymous log on users (null session connections) to list all accounts names, thus providing a list of potential points to attack the system.
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa" -Name "RestrictAnonymousSAM" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 1
          verification_type: CHECK_EXACT
          severity: high
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for <x>Computer Configuration >> Windows Settings >> Security Settings >> Local Policies >> Security Options >> "Network access: Do not allow anonymous enumeration of SAM accounts"</x> to <x>"Enabled"</x>.
        - id: 2
          title: Anonymous enumeration of shares is restricted
          description: Allowing anonymous logon users (null session connections) to list all account names and enumerate all shared resources can provide a map of potential points to attack the system.
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa" -Name "RestrictAnonymous" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 1
          verification_type: CHECK_EXACT
          severity: high
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for <x>Computer Configuration >> Windows Settings >> Security Settings >> Local Policies >> Security Options >> "Network access: Do not allow anonymous enumeration of SAM accounts and shares"</x> to <x>"Enabled"</x>.
        - id: 3
          title: Anonymous users do not have the same rights as the Everyone group
          description: >
            Access by anonymous users must be restricted. If this setting is enabled, then anonymous users have the same rights and permissions as the built-in Everyone group. Anonymous users must not have these permissions or rights.
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa" -Name "EveryoneIncludesAnonymous" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 0
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for <x>Computer Configuration >> Windows Settings >> Security Settings >> Local Policies >> Security Options >> "Network access: Let Everyone permissions apply to anonymous users"</x> to <x>"Disabled"</x>.
    - id: 2
      title: Application Logs permissions
      description: Checking the permissions of the Application.evtx file.
      collection_cmd: $($f = $env:systemroot + '\System32\winevt\Logs\Application.evtx'; icacls $f) | Out-File -Encoding utf8 -Append -FilePath application-log-file-perm.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: The Application event log must prevent access by non-privileged accounts
          description: >
            Maintaining an audit trail of system activity logs can help identify configuration errors, troubleshoot service disruptions, and analyze compromises that have occurred, as well as detect attacks. Audit logs are necessary to provide a trail of evidence in case the system or network is compromised. The Application event log may be susceptible to tampering if proper permissions are not applied.
          type: AUDIT_POWERSHELL
          cmd: $($f=$env:systemroot + '\System32\winevt\Logs\Application.evtx'; $acls = (icacls $f); $status = 'Passed'; ForEach ($acl in $acls) { If(!$acl) { continue } ElseIf ($acl -like '*NT AUTHORITY\SYSTEM:*(F)' -Or $acl -like '*AUTORITE NT\Syst*me:*(F)') { continue } ElseIf ($acl -like '*BUILTIN\Administrators:*(F)' -Or $acl -like '*BUILTIN\Administrateurs:*(F)') { continue } ElseIf ($acl -like '*NT SERVICE\EventLog:*(F)') { continue } ElseIf ($acl -like 'Successfully processed*' -Or $acl -like '*fichiers correctement*') { continue } $status = 'FAILED' }; $acls; '' ; $status)
          expected: Passed
          verification_type: CHECK_REGEX
          severity: high
          level: minimal
          recommendation_on_failed: >
            Ensure the permissions on the Application event log (Application.evtx) are configured to prevent standard user accounts or groups from having access. The following permissions satisfy this requirement:
            * Eventlog - Full Control (F)
            * SYSTEM - Full Control (F)
            * Administrators - Full Control (F)
    - id: 3
      title: Security Logs permissions
      description: Checking the permissions of the Security.evtx file.
      collection_cmd: $($f = $env:systemroot + '\System32\winevt\Logs\Security.evtx'; icacls $f) | Out-File -Encoding utf8 -Append -FilePath security-log-file-perm.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: The Security event log must prevent access by non-privileged accounts
          description: >
            Maintaining an audit trail of system activity logs can help identify configuration errors, troubleshoot service disruptions, and analyze compromises that have occurred, as well as detect attacks. Audit logs are necessary to provide a trail of evidence in case the system or network is compromised. The Security event log may disclose sensitive information or be susceptible to tampering if proper permissions are not applied.
          type: AUDIT_POWERSHELL
          cmd: $($f=$env:systemroot + '\System32\winevt\Logs\Security.evtx'; $acls = (icacls $f); $status = 'Passed'; ForEach ($acl in $acls) { If(!$acl) { continue } ElseIf ($acl -like '*NT AUTHORITY\SYSTEM:*(F)' -Or $acl -like '*AUTORITE NT\Syst*me:*(F)') { continue } ElseIf ($acl -like '*BUILTIN\Administrators:*(F)' -Or $acl -like '*BUILTIN\Administrateurs:*(F)') { continue } ElseIf ($acl -like '*NT SERVICE\EventLog:*(F)') { continue } ElseIf ($acl -like 'Successfully processed*' -Or $acl -like '*fichiers correctement*') { continue } $status = 'FAILED' }; $acls; '' ; $status)
          expected: Passed
          verification_type: CHECK_REGEX
          severity: high
          level: minimal
          recommendation_on_failed: >
            Ensure the permissions on the Security event log (Security.evtx) are configured to prevent standard user accounts or groups from having access. The following permissions satisfy this requirement:
            * Eventlog - Full Control (F)
            * SYSTEM - Full Control (F)
            * Administrators - Full Control (F)
    - id: 4
      title: System Logs permissions
      description: Checking the permissions of the System.evtx file.
      collection_cmd: $($f = $env:systemroot + '\System32\winevt\Logs\System.evtx'; icacls $f) | Out-File -Encoding utf8 -Append -FilePath system-log-file-perm.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: The System event log must prevent access by non-privileged accounts
          description: >
            Maintaining an audit trail of system activity logs can help identify configuration errors, troubleshoot service disruptions, and analyze compromises that have occurred, as well as detect attacks. Audit logs are necessary to provide a trail of evidence in case the system or network is compromised. The System event log may be susceptible to tampering if proper permissions are not applied.
          type: AUDIT_POWERSHELL
          cmd: $($f=$env:systemroot + '\System32\winevt\Logs\System.evtx'; $acls = (icacls $f); $status = 'Passed'; ForEach ($acl in $acls) { If(!$acl) { continue } ElseIf ($acl -like '*NT AUTHORITY\SYSTEM:*(F)' -Or $acl -like '*AUTORITE NT\Syst*me:*(F)') { continue } ElseIf ($acl -like '*BUILTIN\Administrators:*(F)' -Or $acl -like '*BUILTIN\Administrateurs:*(F)') { continue } ElseIf ($acl -like '*NT SERVICE\EventLog:*(F)') { continue } ElseIf ($acl -like 'Successfully processed*' -Or $acl -like '*fichiers correctement*') { continue } $status = 'FAILED' }; $acls; '' ; $status)
          expected: Passed
          verification_type: CHECK_REGEX
          severity: high
          level: minimal
          recommendation_on_failed: >
            Ensure the permissions on the System event log (System.evtx) are configured to prevent standard user accounts or groups from having access. The following permissions satisfy this requirement:
            * Eventlog - Full Control (F)
            * SYSTEM - Full Control (F)
            * Administrators - Full Control (F)
    - id: 5
      title: Eventvwr permissions
      description: >
        Checking the permissions of the Eventvwr executable.
        Voir aussi :
        * https://stigviewer.com/stig/microsoft_windows_server_2019/2022-03-01/finding/V-205731
      collection_cmd: $($f = $env:systemroot + '\System32\Eventvwr.exe'; icacls $f) | Out-File -Encoding utf8 -Append -FilePath eventvwr-perm.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: true
    - id: 6
      title: <x>HiveNightmare CVE-2021-36934</x>
      description: Since <x>Windows 10 build 1809</x>, the Access Control Lists (ACLs) for <x>%windir%\System32\config</x> have been granting read access to non-admin users.
      collection_cmd: $($base = $env:systemroot + '\System32\config\'; $sam = $base + 'SAM'; $security = $base + 'SECURITY'; $system = $base + 'SYSTEM'; icacls $sam; icacls $security; icacls $system) | Out-File -Encoding utf8 -Append -FilePath hivenightmare.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: <x>HiveNightmare (SAM)</x>
          description: >
            Since <x>Windows 10 build 1809</x>, the Access Control Lists (ACLs) for <x>%windir%\System32\config</x> have been granting read access
            to non-admin users.

            An attacker with the ability to execute code on a target host could exploit this vulnerability to elevate their privileges to SYSTEM.
          type: AUDIT_POWERSHELL
          cmd: $($f=$env:systemroot + '\System32\config\SAM'; $acls = (icacls $f); $status = 'Passed'; ForEach ($acl in $acls) { If(!$acl) { continue } ElseIf ($acl -like '*NT AUTHORITY\SYSTEM:*(F)' -Or $acl -like '*AUTORITE NT\Syst*me:*(F)') { continue } ElseIf ($acl -like '*BUILTIN\Administrators:*(F)' -Or $acl -like '*BUILTIN\Administrateurs:*(F)') { continue } ElseIf ($acl -like 'Successfully processed*' -Or $acl -like '*fichiers correctement*') { continue } $status = 'FAILED' }; $acls; '' ; $status)
          expected: Passed
          verification_type: CHECK_REGEX
          severity: high
          level: minimal
          recommendation_on_failed: >
            We recommend installing the security patch and manually deleting all snapshots of system files, including the SAM database.

            It is important to note that installing the security patch alone is not
            sufficient.
          see_also: https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-36934
        - id: 2
          title: <x>HiveNightmare (SECURITY)</x>
          description: >
            Since <x>Windows 10 build 1809</x>, the Access Control Lists (ACLs) for <x>%windir%\System32\config</x> have been granting read access
            to non-admin users.

            An attacker with the ability to execute code on a target host could exploit this vulnerability to elevate their privileges to SYSTEM.
          type: AUDIT_POWERSHELL
          cmd: $($f=$env:systemroot + '\System32\config\SECURITY'; $acls = (icacls $f); $status = 'Passed'; ForEach ($acl in $acls) { If(!$acl) { continue } ElseIf ($acl -like '*NT AUTHORITY\SYSTEM:*(F)' -Or $acl -like '*AUTORITE NT\Syst*me:*(F)') { continue } ElseIf ($acl -like '*BUILTIN\Administrators:*(F)' -Or $acl -like '*BUILTIN\Administrateurs:*(F)') { continue } ElseIf ($acl -like 'Successfully processed*' -Or $acl -like '*fichiers correctement*') { continue } $status = 'FAILED' }; $acls; '' ; $status)
          expected: Passed
          verification_type: CHECK_REGEX
          severity: high
          level: minimal
          recommendation_on_failed: >
            We recommend installing the security patch and manually deleting all snapshots of system files, including the SAM database.

            It is important to note that installing the security patch alone is not
            sufficient.
          see_also: https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-36934
        - id: 3
          title: <x>HiveNightmare (SYSTEM)</x>
          description: >
            Since <x>Windows 10 build 1809</x>, the Access Control Lists (ACLs) for <x>%windir%\System32\config</x> have been granting read access
            to non-admin users.

            An attacker with the ability to execute code on a target host could exploit this vulnerability to elevate their privileges to SYSTEM.
          type: AUDIT_POWERSHELL
          cmd: $($f=$env:systemroot + '\System32\config\SYSTEM'; $acls = (icacls $f); $status = 'Passed'; ForEach ($acl in $acls) { If(!$acl) { continue } ElseIf ($acl -like '*NT AUTHORITY\SYSTEM:*(F)' -Or $acl -like '*AUTORITE NT\Syst*me:*(F)') { continue } ElseIf ($acl -like '*BUILTIN\Administrators:*(F)' -Or $acl -like '*BUILTIN\Administrateurs:*(F)') { continue } ElseIf ($acl -like 'Successfully processed*' -Or $acl -like '*fichiers correctement*') { continue } $status = 'FAILED' }; $acls; '' ; $status)
          expected: Passed
          verification_type: CHECK_REGEX
          severity: high
          level: minimal
          recommendation_on_failed: >
            We recommend installing the security patch and manually deleting all snapshots of system files, including the SAM database.

            It is important to note that installing the security patch alone is not sufficient.
          see_also: https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-36934
    - id: 7
      title: <x>PrintNightmare</x>
      description: >
        Check PointAndPrint keys to assess the workstation's vulnerability to PrintNightmare (CVE-2021-34527).

        Either the updates of August and later are installed. In which case, the <x>RestrictDriverInstallationToAdministrators</x> key must be set to 1 or not set.

        Or they are not installed and the keys <x>NoWarningNoElevationOnInstall</x> and <x>UpdatePromptSettings</x> must be set to 0 or not defined. The July update must also be present and no changes in GPOs must be present (<x>Point And Print Restrictions</x>).
      collection_cmd: $(try { $value = (Get-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath point_and_print.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: true
    - id: 8
      title: Windows Installer Always install with elevated privileges
      description: Standard user accounts must not be granted elevated privileges.
      collection_cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\Installer" -Name "AlwaysInstallElevated" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath always_install_elevated.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: AlwaysInstallElevated is not enabled
          description: >
            Standard user accounts must not be granted elevated privileges.

            Enabling Windows Installer to elevate privileges when installing applications can allow malicious persons and applications to gain full control of a system.
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\Installer" -Name "AlwaysInstallElevated" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 0
          verification_type: CHECK_EXACT
          severity: high
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for <x>Computer Configuration >> Administrative Templates >> Windows Components >> Windows Installer >> "Always install with elevated privileges"</x> to <x>"Disabled"</x>.
    - id: 9
      title: <x>Services ACLs</x>
      description: >
        Verification of the Services ACLs.
        Voir aussi :
        * https://medium.com/r3d-buck3t/abuse-service-registry-acls-windows-privesc-f88079140509
      collection_cmd: $(try { $acl = (Get-Acl -Path "HKLM:\SYSTEM\CurrentControlSet\Services" -ErrorAction Stop); ConvertFrom-SddlString -Sddl $acl.Sddl | ForEach-Object { $_.DiscretionaryAcl } } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath services_discretionary_acl.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: true
    - id: 10
      title: Contrôle de compte d’utilisateur (UAC)
      description: >
        Verification du contrôle de compte d’utilisateur (UAC).
        Voir aussi :
        * https://github.com/tobor88/PowerShell-Red-Team/blob/master/Test-PrivEsc.ps1
        * https://learn.microsoft.com/en-us/windows/security/identity-protection/user-account-control/user-account-control-group-policy-and-registry-key-settings
      collection_cmd: $(try { $value = (Get-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath uac.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: UAC activé
          description: >
            Voir aussi :
            * https://learn.microsoft.com/fr-fr/windows/security/identity-protection/user-account-control/how-user-account-control-works
            * https://learn.microsoft.com/fr-fr/windows-hardware/customize/desktop/unattend/microsoft-windows-lua-settings-enablelua
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -Name "EnableLUA" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 1
          verification_type: CHECK_EXACT
          severity: high
          level: minimal
          recommendation_on_failed: >
            Activer l'UAC
        - id: 2
          title: La demande de consentement est systématique et authentifiée
          description: >
            Configuration renforcée nécessitant une authentification en tant qu'administrateur (secure desktop) pour toute demande d'élévation de privilèges.
            Voir aussi :
            * https://learn.microsoft.com/fr-fr/windows/security/identity-protection/user-account-control/how-user-account-control-works
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -Name "ConsentPromptBehaviorAdmin" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: ^\s*(1|2)\s*$
          verification_type: CHECK_REGEX
          severity: high
          level: minimal
          recommendation_on_failed: >
            Activer l'UAC
        - id: 3
          title: Le consentement est requis uniquement pour les binaires non Windows (N/A si renforcé)
          description: >
            Il s'agit de la valeur par défaut.
            Voir aussi :
            * https://learn.microsoft.com/fr-fr/windows/security/identity-protection/user-account-control/how-user-account-control-works
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -Name "ConsentPromptBehaviorAdmin" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 5
          verification_type: CHECK_EXACT
          severity: high
          level: minimal
          recommendation_on_failed: >
            Activer l'UAC
- id: 9
  name: Software - Services - Tasks
  checkpoints:
    - id: 1
      title: Installed products
      description: Verification of the legitimacy of the installed programs as well as the presence of known vulnerability in the versions used.
      collection_cmd: >
        $(try { $value = (Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*" -ErrorAction Stop | Select-Object -Property DisplayName,DisplayVersion,Publisher | Format-Table -AutoSize); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath installed_programs.txt;
        wmic.exe product list full /format:htable | Out-File -Encoding utf8 -Append -FilePath installed_products_wmic.html
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: Un anti-virus est installé (manuel)
          description: >
            Une solution antivirale doit être installée et active
          type: AUDIT_POWERSHELL
          cmd: Get-service | where {$_.DisplayName -Like "*Microsoft Defender*" -or $_.DisplayName -Like "*mcafee*" -or $_.DisplayName -Like "*symantec*" -or $_.DisplayName -Like "*kaspersky*" -or $_.DisplayName -Like "*bitdefender*"} | Select Status,DisplayName
          expected: \s*Running.*
          verification_type: CHECK_REGEX
          severity: high
          level: minimal
          recommendation_on_failed: >
            Installer et configurer une solution antivirale sur le système.
    - id: 2
      title: Services
      description: Verification of the legitimacy of active services in relation to business needs.
      collection_cmd: Get-WmiObject -Namespace root\cimv2 -Class Win32_service | Select-Object -Property * | Out-File -Encoding utf8 -Append -FilePath all_services.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: true
    - id: 3
      title: Running Services
      description: Verification of the legitimacy of active services in relation to business needs.
      collection_cmd: Get-Service | Where-Object { $_.Status -eq "Running" } | Format-Table -AutoSize | Out-File -Encoding utf8 -Append -FilePath running_services_list.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: true
    - id: 4
      title: Tasks list
      description: Verification of the legitimacy of active processes in relation to business needs.
      collection_cmd: tasklist.exe /v /fo csv | Out-File -Encoding utf8 -Append -FilePath tasklist.csv
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: true
    - id: 5
      title: Scheduled tasks
      description: >
        Verification of the legitimacy of active scheduled tasks in relation to business needs.
      collection_cmd: >
        schtasks.exe /query /V /FO CSV | ConvertFrom-Csv | Where-Object { $_.Auteur -ne "Auteur" } | Export-CSV -NoTypeInformation -Encoding utf8 -Path scheduled_task_fr_system.csv;
        schtasks.exe /query /V /FO CSV | ConvertFrom-Csv | Where-Object { $_.TaskName -ne "TaskName" } | Select-Object @{ label = "Name"; expression = { Split-Path $_.TaskName -Leaf } }, Author, @{ label = "User"; expression = { $_."run as user" }}, @{ label = "Task"; expression = { $_."task to run" } } | Export-CSV -NoTypeInformation -Encoding utf8 -Path scheduled_task_en_system.csv
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: true
- id: 10
  name: Network
  checkpoints:
    - id: 1
      title: Network configuration
      description: Displays all current TCP/IP network configuration values
      collection_cmd: ipconfig.exe /all | Out-File -Encoding utf8 -Append -FilePath ipconfig.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: NetBIOS est désactivé pour toutes les interfaces
          description: >
            NetBIOS est une technique utilisée par Responder.
            https://adsecurity.org/?p=3299
          type: AUDIT_POWERSHELL
          cmd: $(try { $ifaces = (Get-ItemPropertyValue -Path "HKLM:\SYSTEM\CurrentControlSet\Services\NetBT\Parameters\Interfaces\Tcpip_*" -Name "NetbiosOptions" -ErrorAction Stop); $status = "Success"; ForEach ($iface in $ifaces) { If ($iface -ne 2) { $status = "Failure" } }; echo $status } catch { echo $Error[0] })
          expected: Success
          verification_type: CHECK_EXACT
          severity: high
          level: minimal
          recommendation_on_failed: >
            Mettre la clé EnableMulticast à 0.
    - id: 2
      title: Network shares
      description: List network shares
      collection_cmd: $(try { $value = (Get-SmbShare -ErrorAction Stop | Format-List *); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath share.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: true
    - id: 3
      title: Network shares permissions
      description: List network shares permissions
      collection_cmd: $(try { $shares = (Get-SmbShare -ErrorAction Stop | Select-Object -Property Name); ForEach ($share in $shares) { Get-SmbShareAccess -Name $share.Name } } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath share_permissions.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: true
    - id: 4
      title: Network connections
      description: Listening Processes
      collection_cmd: Get-NetTCPConnection -State Listen | Select-Object -Property LocalAddress,LocalPort,@{'Name' = 'ProcessName';'Expression'={(Get-Process -Id $_.OwningProcess).Name}} | Out-File -Encoding utf8 -Append -FilePath listening_processes.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: true
    - id: 5
      title: NTP
      description: >
        Displays the NTP configuration
        Les valeurs définies par la stratégie de groupe remplacent celles qui préexistaient dans la section du service de temps Windows du Registre.
        Voir aussi :
        * https://learn.microsoft.com/fr-fr/windows-server/networking/windows-time-service/windows-time-service-tools-and-settings
      collection_cmd: >
        $(try { $value = (Get-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\W32Time\Parameters" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath ntp_params_gpo.txt;
        $(try { $value = (Get-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\W32Time\Config" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath ntp_config_gpo.txt;
        $(try { $value = (Get-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\W32Time\TimeProviders\NtpClient" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath ntp_client_gpo.txt;
        $(try { $value = (Get-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\W32Time\TimeProviders\NtpServer" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath ntp_server_gpo.txt;
        $(try { $value = (Get-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\W32Time\Parameters" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath ntp_params_ccs.txt;
        $(try { $value = (Get-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\W32Time\Config" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath ntp_config_ccs.txt;
        $(try { $value = (Get-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\NTPClient" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath ntp_client_ccs.txt;
        $(try { $value = (Get-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\NTPServer" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath ntp_server_ccs.txt;
        w32tm.exe /query /status | Out-File -Encoding utf8 -Append -FilePath ntp_running_conf.txt;
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: true
    - id: 6
      title: Proxy settings
      description: >
        Displays the proxy configuration
        Voir aussi :
        * https://learn.microsoft.com/fr-fr/troubleshoot/windows-server/networking/configure-proxy-server-settings
        * https://bobcares.com/blog/configure-proxy-settings-on-windows-using-group-policy/
        * https://theitbros.com/config-internet-explorer-11-proxy-settings-gpo/
      collection_cmd: >
        $(try { $value = (Get-ItemProperty -Path "HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Internet Settings" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath proxy_hkcu.txt;
        $(try { $value = (Get-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\CurrentVersion\Internet Settings" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath proxy_hklm.txt;
        $(try { $value = (Get-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Internet Settings\Connections" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath proxy_winhttp.txt;
        $(try { $value = (Get-ItemProperty -Path "HKCU:\SOFTWARE\Policies\Microsoft\Internet Explorer\Control Panel" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath proxy_control_panel_edit_restriction.txt;
        $(try { $value = (Get-ItemProperty -Path "HKCU:\SOFTWARE\Policies\Microsoft\Internet Explorer\Restrictions" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath proxy_browser_edit_restriction.txt;
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: true
    - id: 7
      title: Web Proxy Auto-Discovery Protocol (WPAD)
      description: Displays the WPAD configuration
      collection_cmd: $(try { $value = (Get-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Wpad" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath proxy_wpad.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: WPAD est désactivé
          description: >
            WPAD est une technique utilisée par Responder.
            https://adsecurity.org/?p=3299
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Wpad" -Name "WpadOverride" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 1
          verification_type: CHECK_EXACT
          severity: high
          level: minimal
          recommendation_on_failed: >
            Mettre la clé WpadOverride à 1.
    - id: 8
      title: Link-Local Multicast Name Resolution (LLMNR)
      description: Displays the LLMNR configuration
      collection_cmd: $(try { $value = (Get-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\DNSClient" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath llmnr.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: LLMNR est désactivé
          description: >
            LLMNR est une technique utilisée par Responder.
            https://adsecurity.org/?p=3299
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\DNSClient" -Name "EnableMulticast" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 0
          verification_type: CHECK_EXACT
          severity: high
          level: minimal
          recommendation_on_failed: >
            Mettre la clé EnableMulticast à 0.
    - id: 9
      title: SMB Client
      description: Displays the SMB configuration - Client side
      collection_cmd: $(try { $value = (Get-ItemProperty -Path "HKLM:\System\Currentcontrolset\Services\Lanmanworkstation\Parameters" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath smb_client.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: The Windows SMB client perform SMB packet signing
          description: >
            The server message block (SMB) protocol provides the basis for many network operations. Digitally signed SMB packets aid in preventing man-in-the-middle attacks. If this policy is enabled, the SMB client will only communicate with an SMB server that performs SMB packet signing.
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\System\Currentcontrolset\Services\Lanmanworkstation\Parameters" -Name "RequireSecuritySignature" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 1
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for <x>Computer Configuration >> Windows Settings >> Security Settings >> Local Policies >> Security Options >> "Microsoft network client: Digitally sign communications (always)"</x> to <x>"Enabled"</x>.
        - id: 2
          title: Unencrypted passwords are not sent to third-party SMB Servers
          description: >
            Some non-Microsoft SMB servers only support unencrypted (plaintext) password authentication. Sending plain text passwords across the network, when authenticating to an SMB server, reduces the overall security of the environment. Check with the vendor of the SMB server to see if there is a way to support encrypted password authentication.
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\System\Currentcontrolset\Services\Lanmanworkstation\Parameters" -Name "EnablePlainTextPassword" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 0
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for <x>Computer Configuration >> Windows Settings >> Security Settings >> Local Policies >> Security Options >> "Microsoft network client: Send unencrypted password to third-party SMB servers"</x> to <x>"Disabled"</x>.
        - id: 3
          title: SMBv1 protocol is disabled on the system
          description: >
            SMBv1 is a legacy protocol that uses the MD5 algorithm as part of SMB. MD5 is known to be vulnerable to a number of attacks such as collision and preimage attacks as well as not being FIPS compliant.
          type: AUDIT_POWERSHELL
          cmd: Get-WindowsOptionalFeature -Online -FeatureName SMB1Protocol
          expected: State\s+:\s+Disabled
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            Disable the SMBv1 protocol.

            Run 'Windows PowerShell' with elevated privileges (run as administrator).

            Enter the following:
            <x>Disable-WindowsOptionalFeature -Online -FeatureName SMB1Protocol</x>

            Note: Disabling SMBv1 support may prevent access to file or print sharing resources with systems or devices that only support SMBv1. File shares and print services hosted on Windows Server 2003 are an example, however Windows Server 2003 is no longer a supported operating system. Some older Network Attached Storage (NAS) devices may only support SMBv1.
        - id: 4
          title: SMBv1 protocol is disabled on the SMB client (N/A si désactivé globalement)
          description: >
            SMBv1 is a legacy protocol that uses the MD5 algorithm as part of SMB. MD5 is known to be vulnerable to a number of attacks such as collision and preimage attacks as well as not being FIPS compliant.

            N/A si le check précédent passe.
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\System\Currentcontrolset\Services\Mrxsmb10" -Name "Start" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 4
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            We recommend disabling SMBv1 support.

            Note: Disabling SMBv1 support may prevent access to file or print sharing resources with systems or devices that only support SMBv1. File shares and print services hosted on Windows Server 2003 are an example, however Windows Server 2003 is no longer a supported operating system. Some older Network Attached Storage (NAS) devices may only support SMBv1.
    - id: 10
      title: SMB Server
      description: Displays the SMB configuration - Server side
      collection_cmd: >
        $(try { $value = (Get-ItemProperty -Path "HKLM:\System\Currentcontrolset\Services\LanmanServer\Parameters" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath smb_server.txt;
        Get-SmbServerConfiguration | Out-File -Encoding utf8 -Append -FilePath smb_server_configuration.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: The Windows SMB server perform SMB packet signing
          description: >
            The server message block (SMB) protocol provides the basis for many network operations.  Digitally signed SMB packets aid in preventing man-in-the-middle attacks. If this policy is enabled, the SMB server will only communicate with an SMB client that performs SMB packet signing.
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\System\Currentcontrolset\Services\LanmanServer\Parameters" -Name "RequireSecuritySignature" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 1
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for <x>Computer Configuration >> Windows Settings >> Security Settings >> Local Policies >> Security Options >> "Microsoft network server: Digitally sign communications (always)"</x>
            to <x>"Enabled"</x>.
        - id: 2
          title: Anonymous access to Named Pipes and Shares is restricted
          description: >
            Allowing anonymous access to named pipes or shares provides the potential for unauthorized system access. This setting restricts access to those defined in "Network access: Named Pipes that can be accessed anonymously" and "Network access: Shares that can be accessed anonymously", both of which must be blank under other requirements.
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\System\Currentcontrolset\Services\LanmanServer\Parameters" -Name "RestrictNullSessAccess" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 1
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for <x>Computer Configuration >> Windows Settings >> Security Settings >> Local Policies >> Security Options >> "Network access: Restrict anonymous access to Named Pipes and Shares"</x> to <x>"Enabled"</x>.
        - id: 3
          title: SMBv1 protocol is disabled (N/A si désactivé globalement)
          description: >
            SMBv1 is a legacy protocol that uses the MD5 algorithm as part of SMB. MD5 is known to be vulnerable to a number of attacks such as collision and preimage attacks as well as not being FIPS compliant.
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\System\Currentcontrolset\Services\LanmanServer\Parameters" -Name "SMB1" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 0
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for <x>Computer Configuration >> Administrative Templates >> MS Security Guide >> "Configure SMBv1 Server"</x> to <x>"Disabled"</x>.

            Note: Disabling SMBv1 support may prevent access to file or print sharing resources with systems or devices that only support SMBv1. File shares and print services hosted on Windows Server 2003 are an example, however Windows Server 2003 is no longer a supported operating system. Some older network attached devices may only support SMBv1.
    - id: 11
      title: Supported CipherSuite
      description: Displays the supported CipherSuite
      collection_cmd: (Get-TlsCipherSuite).Name | Format-Table -AutoSize -Property CipherSuite,Name | Out-File -Encoding utf8 -Append -FilePath supported_ciphersuite.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: true
    - id: 12
      title: Transport Layer Security (TLS) registry settings
      description: Displays Transport Layer Security (TLS) registry settings
      collection_cmd: $($key = @(Get-ChildItem -Path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL" -Recurse); $key += Get-Item -Path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL"; ForEach($subkey in $key) { echo $subkey }) | Out-File -Encoding utf8 -Append -FilePath tls_settings.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: true
    - id: 13
      title: FIPS 140-2
      description: FIXME
      collection_cmd: $(try { $value = (Get-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\FIPSAlgorithmPolicy" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath fips.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: Utilisation d'algorithmes cryptographique conformes au FIPS
          description: >
            FIXME
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\FIPSAlgorithmPolicy" -Name "Enabled" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 1
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
    - id: 14
      title: Algorithmes cryptographiques supportés par Kerberos
      description: >
        FIXME
        Voir aussi :
        * https://stigviewer.com/stig/microsoft_windows_server_2019/2022-03-01/finding/V-205708
      collection_cmd: $(try { $value = (Get-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\Kerberos\Parameters" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath kerberos_crypto_algo.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: Désactivation du support de RC4 et DES
          description: >
            FIXME
            Cela revient à obtenir :
            * AES128_HMAC_SHA1
            * AES256_HMAC_SHA1
            * Future encryption types

            Note : il est possible d'avoir cela dans les GPO
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\Kerberos\Parameters" -Name "SupportedEncryptionTypes" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 2147483640
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
    - id: 15
      title: Configuration Wi-Fi
      description: >
        Check Wi-Fi configuration
        Si l'authentification WPA2/3 est utilisée, la clé doit être suffisament robuste pour ne pas tomber en un temps raisonnable avec hashcat
        Si l'authentification WPA2-Enterprise est utilisée, il doit y avoir une configuration trustedCA correspondant uniquement à l'IGC de l'entreprise
        Voir aussi :
        * ProductType : https://learn.microsoft.com/fr-fr/windows/win32/cimwin32prov/win32-operatingsystem?redirectedfrom=MSDN
        * TrustedRootCA : https://learn.microsoft.com/en-us/windows/win32/eaphost/eaptlsconnectionpropertiesv1schema-trustedrootca-servervalidationparameters-element
      collection_cmd: >
        Get-Childitem Cert:\LocalMachine\Root\* | Format-Table -AutoSize | Out-File -Encoding utf8 -Append -FilePath trusted_ca_full.txt;
        $p_type = (Get-CimInstance -ClassName Win32_OperatingSystem).ProductType; If ($p_type -eq 1) { netsh wlan export profile key=clear folder=$basedir\$category }
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: true
- id: 11
  name: Firewall
  checkpoints:
    - id: 1
      title: Firewall is enabled
      description: Checks that the system firewall is active
      collection_cmd: netsh.exe advfirewall show allprofiles | Out-File -Encoding utf8 -Append -FilePath firewall_profile.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: All profiles are enabled
          description: >
            An operating system without a firewall is more exposed to attacks from the local network.
          type: AUDIT_POWERSHELL
          cmd: $($profiles = Get-NetFirewallProfile | Select Enabled; If ($profiles | where {$_.Enabled -eq 'False'}) { 'False' } Else { 'True' })
          expected: true
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            We recommend enabling the operating system firewall.

            Even when compartmentalization is defined (use of <x>VLANs</x>, filtering rules, etc.), the use of a local firewall allows to limit the exposure of the system to attacks coming from the same subnet.
    - id: 2
      title: Inbound Rules
      description: Dumps the active inbound rules for analyzis
      collection_cmd: Get-NetFirewallRule | where-object {$_.direction -eq 'Inbound' -And $_.enabled -eq 'True'} | Out-File -Encoding utf8 -Append -FilePath inbound_rules.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: true
- id: 12
  name: Journalisation
  checkpoints:
    - id: 1
      title: Politique d'audit
      description: >
        Dumps the audit policy for analyzis
        Voir aussi :
        * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
        * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
        * https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-gpac/77878370-0712-47cd-997d-b07053429f6d
      collection_cmd: >
        Get-EventLog -List | Format-Table -AutoSize | Out-File -Encoding utf8 -Append -FilePath eventlog_list.txt;
        auditpol.exe /get /category:* | Out-File -Encoding utf8 -Append -FilePath audit_policy.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: Connexion de compte - Validation des informations d'identification
          description: >
            Note : L'utilisation du paramètre "Succès et échec" n'est pas recommandé pour un contrôleur de domaine.
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE923F-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Validation\s+des\s+informations\s+d'identification|Credential\s+Validation)\s*(Succ.s\s+et\s+.chec|Success\s+and\s+Failure|Échec|Failure)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 2
          title: Connexion de compte - Service d'authentification Kerberos
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE9242-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Service\s+d'authentification\s+Kerberos|Kerberos\s+Authentication\s+Service)\s*(Succ.s\s+et\s+.chec|Success\s+and\s+Failure)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 3
          title: Connexion de compte - Opérations de ticket du service Kerberos
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE9240-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Op.rations\s+de\s+ticket\s+du\s+service\s+Kerberos|Kerberos\s+Service\s+Ticket\s+Operations)\s*(Succ.s\s+et\s+.chec|Success\s+and\s+Failure)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 4
          title: Connexion de compte - Autres événements d'ouverture de session
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE9241-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Autres\s+.v.nements\s+d'ouverture\s+de\s+session|Other\s+Account\s+Logon\s+Events)\s*(Succ.s\s+et\s+.chec|Success\s+and\s+Failure)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 5
          title: Gestion des comptes - Gestion des groupes d'applications
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE9239-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Gestion\s+des\s+groupes\s+d'applications|Application\s+Group\s+Management)\s*(Pas\s+d'audit|No\s+Auditing)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 6
          title: Gestion des comptes - Gestion des comptes d'ordinateur
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE9236-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Gestion\s+des\s+comptes\s+d'ordinateur|Computer\s+Account\s+Management)\s*(Succ.s\s+et\s+.chec|Success\s+and\s+Failure)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 7
          title: Gestion des comptes - Gestion des groupes de distribution
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE9238-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Gestion\s+des\s+groupes\s+de\s+distribution|Distribution\s+Group\s+Management)\s*(Pas\s+d'audit|No\s+Auditing)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 8
          title: Gestion des comptes - Autres événements de gestion des comptes
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE923A-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Autres\s+.v.nements\s+de\s+gestion\s+des\s+comptes|Other\s+Account\s+Management\s+Events)\s*(Succ.s\s+et\s+.chec|Success\s+and\s+Failure)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 9
          title: Gestion des comptes - Gestion des groupes de sécurité
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE9237-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Gestion\s+des\s+groupes\s+de\s+s.curit.|Security\s+Group\s+Management)\s*(Succ.s\s+et\s+.chec|Success\s+and\s+Failure)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 10
          title: Gestion des comptes - Gestion des comptes d'utilisateur
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE9235-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Gestion\s+des\s+comptes\s+d'utilisateur|User\s+Account\s+Management)\s*(Succ.s\s+et\s+.chec|Success\s+and\s+Failure)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 11
          title: Suivi détaillé - Activité DPAPI
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE922D-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Activit.\s+DPAPI|DPAPI\s+Activity)\s*(Succ.s\s+et\s+.chec|Success\s+and\s+Failure)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 12
          title: Suivi détaillé - Événements Plug-and-Play
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE9248-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(.v.nements\s+Plug-and-Play|Plug\s+and\s+Play\s+Events)\s*(R.ussite|Success)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 13
          title: Suivi détaillé - Création du processus
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE922B-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Cr.ation\s+du\s+processus|Process\s+Creation)\s*(Succ.s\s+et\s+.chec|Success\s+and\s+Failure)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 14
          title: Suivi détaillé - Fin du processus
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE922C-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Fin\s+du\s+processus|Process\s+Termination)\s*(Pas\s+d'audit|No\s+Auditing)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 15
          title: Suivi détaillé - Événements RPC
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE922E-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(.v.nements\s+RPC|RPC\s+Events)\s*(Pas\s+d'audit|No\s+Auditing)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 16
          title: Suivi détaillé - Événements de jeton ajustés à droite
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE924A-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(.v.nements\s+de\s+jeton\s+ajust.s\s+.\s+droite|Token\s+Right\s+Adjusted\s+Events)\s*(Pas\s+d'audit|No\s+Auditing)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 17
          title: Accès DS - Réplication du service d'annuaire détaillé
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE923E-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(R.plication\s+du\s+service\s+d'annuaire\s+d.taill.|Detailed\s+Directory\s+Service\s+Replication)\s*(Succ.s\s+et\s+.chec|Success\s+and\s+Failure)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 18
          title: Accès DS - Accès au service d'annuaire
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE923B-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Acc.s\s+au\s+service\s+d'annuaire|Directory\s+Service\s+Access)\s*(Succ.s\s+et\s+.chec|Success\s+and\s+Failure)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 19
          title: Accès DS - Modification du service d'annuaire
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE923C-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Modification\s+du\s+service\s+d'annuaire|Directory\s+Service\s+Changes)\s*(Succ.s\s+et\s+.chec|Success\s+and\s+Failure)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 20
          title: Accès DS - Réplication du service d'annuaire
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE923D-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(R.plication\s+du\s+service\s+d'annuaire|Directory\s+Service\s+Replication)\s*(Succ.s\s+et\s+.chec|Success\s+and\s+Failure)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 21
          title: Ouverture/Fermeture de session - Verrouillage du compte
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE9217-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Verrouillage\s+du\s+compte|Account\s+Lockout)\s*(Succ.s\s+et\s+.chec|Success\s+and\s+Failure)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 22
          title: Ouverture/Fermeture de session - Revendications utilisateur/de périphérique
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE9247-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Revendications\s+utilisateur/de\s+p.riph.rique|User\s*/\s*Device\s+Claims)\s*(Pas\s+d'audit|No\s+Auditing)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 23
          title: Ouverture/Fermeture de session - Mode étendu IPsec
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE921A-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Mode\s+.tendu\s+IPsec|IPsec\s+Extended\s+Mode)\s*(Pas\s+d'audit|No\s+Auditing)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 24
          title: Ouverture/Fermeture de session - Appartenance à un groupe
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE9249-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Appartenance\s+.\s+un\s+groupe|Group\s+Membership)\s*(Pas\s+d'audit|No\s+Auditing)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 25
          title: Ouverture/Fermeture de session - Mode principal IPsec
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE9218-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Mode\s+principal\s+IPsec|IPsec\s+Main\s+Mode)\s*(Pas\s+d'audit|No\s+Auditing)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 26
          title: Ouverture/Fermeture de session - Mode rapide IPsec
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE9219-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Mode\s+rapide\s+IPsec|IPsec\s+Quick\s+Mode)\s*(Pas\s+d'audit|No\s+Auditing)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 27
          title: Ouverture/Fermeture de session - Fermer la session
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE9216-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Fermer\s+la\s+session|Logoff)\s*(R.ussite|Success)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 28
          title: Ouverture/Fermeture de session - Ouvrir la session
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE9215-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Ouvrir\s+la\s+session|Logon)\s*(Succ.s\s+et\s+.chec|Success\s+and\s+Failure)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 29
          title: Ouverture/Fermeture de session - Serveur NPS
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE9243-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Serveur\s+NPS|Network\s+Policy\s+Server)\s*(Succ.s\s+et\s+.chec|Success\s+and\s+Failure)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 30
          title: Ouverture/Fermeture de session - Autres événements d'ouverture/fermeture de session
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE921C-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Autres\s+.v.nements\s+d'ouverture/fermeture\s+de\s+session|Other\s+Logon/Logoff\s+Events)\s*(Succ.s\s+et\s+.chec|Success\s+and\s+Failure)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 31
          title: Ouverture/Fermeture de session - Ouverture de session spéciale
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE921B-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Ouverture\s+de\s+session\s+sp.ciale|Special\s+Logon)\s*(R.ussite|Success)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 32
          title: Accès aux objets - Généré par application
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE9222-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(G.n.r.\s+par\s+application|Application\s+Generated)\s*(Pas\s+d'audit|No\s+Auditing)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 33
          title: Accès aux objets - Services de certification
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE9221-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Services\s+de\s+certification|Certification\s+Services)\s*(Succ.s\s+et\s+.chec|Success\s+and\s+Failure)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 34
          title: Accès aux objets - Partage de fichiers détaillé
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE9244-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Partage\s+de\s+fichiers\s+d.taill.|Detailed\s+File\s+Share)\s*(R.ussite|Success)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 35
          title: Accès aux objets - Partage de fichiers
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE9224-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Partage\s+de\s+fichiers|File\s+Share)\s*(Succ.s\s+et\s+.chec|Success\s+and\s+Failure)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 36
          title: Accès aux objets - Système de fichiers
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE921D-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Syst.me\s+de\s+fichiers|File\s+System)\s*(.chec|Failure)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 37
          title: Accès aux objets - Connexion de la plateforme de filtrage
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE9226-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Connexion\s+de\s+la\s+plateforme\s+de\s+filtrage|Filtering\s+Platform\s+Connection)\s*(.chec|Failure)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 38
          title: Accès aux objets - Rejet de paquet par la plateforme de filtrage
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE9225-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Rejet\s+de\s+paquet\s+par\s+la\s+plateforme\s+de\s+filtrage|Filtering\s+Platform\s+Packet\s+Drop)\s*(Pas\s+d'audit|No\s+Auditing)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 39
          title: Accès aux objets - Manipulation de handle
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE9223-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Manipulation\s+de\s+handle|Handle\s+Manipulation)\s*(Pas\s+d'audit|No\s+Auditing)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 40
          title: Accès aux objets - Objet de noyau
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE921F-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Objet\s+de\s+noyau|Kernel\s+Object)\s*(Pas\s+d'audit|No\s+Auditing)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 41
          title: Accès aux objets - Autres événements d'accès à l'objet
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE9227-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Autres\s+.v.nements\s+d'acc.s\s+.\s+l'objet|Other\s+Object\s+Access\s+Events)\s*(Succ.s\s+et\s+.chec|Success\s+and\s+Failure)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 42
          title: Accès aux objets - Registre
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE921E-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Registre|Registry)\s*(Pas\s+d'audit|No\s+Auditing)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 43
          title: Accès aux objets - Stockage amovible
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE9245-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Stockage\s+amovible|Removable\s+Storage)\s*(Succ.s\s+et\s+.chec|Success\s+and\s+Failure)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 44
          title: Accès aux objets - SAM
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE9220-69AE-11D9-BED3-505054503030}"
          expected: ^\s*SAM\s*(Pas\s+d'audit|No\s+Auditing)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 45
          title: Accès aux objets - Stratégie centralisée intermédiaire
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE9246-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Strat.gie\s+centralis.e\s+interm.diaire|Central\s+(Access\s+)?Policy\s+Staging)\s*(Pas\s+d'audit|No\s+Auditing)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 46
          title: Changement de stratégie - Modification de la stratégie d'audit
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE922F-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Modification\s+de\s+la\s+strat.gie\s+d'audit|Audit\s+Policy\s+Change)\s*(Succ.s\s+et\s+.chec|Success\s+and\s+Failure)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 47
          title: Changement de stratégie - Modification de la stratégie d'authentification
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE9230-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Modification\s+de\s+la\s+strat.gie\s+d'authentification|Authentication\s+Policy\s+Change)\s*(Succ.s\s+et\s+.chec|Success\s+and\s+Failure)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 48
          title: Changement de stratégie - Modification de la stratégie d'autorisation
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE9231-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Modification\s+de\s+la\s+strat.gie\s+d'autorisation|Authorization\s+Policy\s+Change)\s*(Succ.s\s+et\s+.chec|Success\s+and\s+Failure)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 49
          title: Changement de stratégie - Modification de la stratégie de plateforme de filtrage
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE9233-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Modification\s+de\s+la\s+strat.gie\s+de\s+plateforme\s+de\s+filtrage|Filtering\s+Platform\s+Policy\s+Change)\s*(Succ.s\s+et\s+.chec|Success\s+and\s+Failure)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 50
          title: Changement de stratégie - Modification de la stratégie de niveau règle MPSSVC
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE9232-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Modification\s+de\s+la\s+strat.gie\s+de\s+niveau\s+r.gle\s+MPSSVC|MPSSVC\s+Rule-Level\s+Policy\s+Change)\s*(.chec|Failure)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 51
          title: Changement de stratégie - Autres événements de modification de stratégie
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE9234-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Autres\s+.v.nements\s+de\s+modification\s+de\s+strat.gie|Other\s+Policy\s+Change\s+Events)\s*(Pas\s+d'audit|No\s+Auditing)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 52
          title: Utilisation de privilège - Utilisation de privilèges non sensibles
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE9229-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Utilisation\s+de\s+privil.ges\s+non\s+sensibles|Non\s+Sensitive\s+Privilege\s+Use)\s*(Pas\s+d'audit|No\s+Auditing)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 53
          title: Utilisation de privilège - Utilisation de privilèges sensibles
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE9228-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Utilisation\s+de\s+privil.ges\s+sensibles|Sensitive\s+Privilege\s+Use)\s*(Pas\s+d'audit|No\s+Auditing)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 54
          title: Utilisation de privilège - Autres événements d'utilisation de privilèges
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE922A-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Autres\s+.v.nements\s+d'utilisation\s+de\s+privil.ges|Other\s+Privilege\s+Use\s+Events)\s*(Succ.s\s+et\s+.chec|Success\s+and\s+Failure)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 55
          title: Système - Pilote IPSEC
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE9213-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Pilote\s+IPSEC|IPsec\s+Driver)\s*(Succ.s\s+et\s+.chec|Success\s+and\s+Failure)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 56
          title: Système - Autres événements système
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE9214-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Autres\s+.v.nements\s+syst.me|Other\s+System\s+Events)\s*(Succ.s\s+et\s+.chec|Success\s+and\s+Failure)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 57
          title: Système - Modification de l'état de la sécurité
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE9210-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Modification\s+de\s+l'.tat\s+de\s+la\s+s.curit.|Security\s+State\s+Change)\s*(R.ussite|Success)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 58
          title: Système - Extension système de sécurité
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE9211-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Extension\s+syst.me\s+de\s+s.curit.|Security\s+System\s+Extension)\s*(Succ.s\s+et\s+.chec|Success\s+and\s+Failure)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 59
          title: Système - Intégrité du système
          description: >
            Voir aussi :
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.8
            * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.D.2
          type: AUDIT_POWERSHELL
          cmd: auditpol.exe /get /subcategory:"{0CCE9212-69AE-11D9-BED3-505054503030}"
          expected: ^\s*(Int.grit.\s+du\s+syst.me|System\s+Integrity)\s*(Succ.s\s+et\s+.chec|Success\s+and\s+Failure)\s*$
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
    - id: 2
      title: Sysmon Configuration
      description: >
        Dumps the sysmon configuration for analyzis
        Voir aussi :
        * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section*.9
        * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#cite.SYSMON-SwiftOnSecurity
        * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#cite.SYSMON-Hartong
      collection_cmd: $(If (Test-CommandExists Sysmon64.exe) { Sysmon64.exe -c } Else { echo "Command not found"}) | Out-File -Encoding utf8 -Append -FilePath sysmon_conf.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: true
    - id: 3
      title: PowerShell Transcript Configuration
      description: >
        Dumps the powershell transcript configuration for analyzis
        Voir aussi :
        * https://devblogs.microsoft.com/powershell/powershell-the-blue-team/
      collection_cmd: $(try { $value = (Get-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\Transcription" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath powershell_transcription.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: Activation de la transcription PowerShell
          description: >
            Voir aussi :
            * https://devblogs.microsoft.com/powershell/powershell-the-blue-team/
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\Transcription" -Name "EnableTranscripting" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 1
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
    - id: 4
      title: PowerShell Script Block Logging Configuration
      description: Dumps the powershell Script Block Logging configuration for analyzis
      collection_cmd: $(try { $value = (Get-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath powershell_scriptblocklogging.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: Activation de la journalisation des blocks PowerShell
          description: >
            Voir aussi :
            * https://devblogs.microsoft.com/powershell/powershell-the-blue-team/
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging" -Name "EnableScriptBlockLogging" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 1
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
    - id: 5
      title: Chiffrement des journaux
      description: >
        Activation du chiffrement des journaux
        Note : seul PowerShell semble le prendre en compte
        Voir aussi :
            * https://devblogs.microsoft.com/powershell/powershell-the-blue-team/
      collection_cmd: $(try { $value = (Get-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\EventLog\ProtectedEvent" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath protected_event.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: Activation du chiffrement des évènements
          description: >
            Voir aussi :
            * https://devblogs.microsoft.com/powershell/powershell-the-blue-team/
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\EventLog\ProtectedEvent" -Name "EnableProtectedEventLogging" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 1
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
    - id: 6
      title: Application event log
      description: >
        Dumps the application event log for analyzis
        Note : wevtutil.exe exprime l'argument ms (maxsize) en octets (!) Il faut donc penser à le convertir vers les Mo/Go.
        Voir aussi :
        * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#section.C.2
        * https://www.ecommerce-pro.com/tutoriel/convertisseur_octets.php
      collection_cmd: wevtutil.exe get-log Application | Out-File -Encoding utf8 -Append -FilePath log_application.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: Application event log size
          description: >
            <x>FIXME_AUDITOR: If the system is configured to send audit records directly to an audit server, this is NA</x>

            Inadequate log size will cause the log to fill up quickly. This may prevent audit events from being recorded properly and require frequent attention by administrative personnel.
          type: AUDIT_POWERSHELL
          cmd: reg.exe query "HKLM\SOFTWARE\Policies\Microsoft\Windows\EventLog\Application" /v "MaxSize" 2>$null
          expected: \s*MaxSize\s*REG_DWORD\s*(?![0-3][0-2][0-7][0-6][0-7]$)([0-9]{5,11})
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for <x>Computer Configuration >> Administrative Templates >> Windows Components >> Event Log Service >> Application >> "Specify the maximum log file size (KB)"</x> to <x>"Enabled"</x> with a <x>"Maximum Log Size (KB)"</x> of "32768" or greater.
    - id: 7
      title: Security event log
      description: Dumps the application event log for analyzis
      collection_cmd: wevtutil.exe get-log Security | Out-File -Encoding utf8 -Append -FilePath log_security.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: Security event log size
          description: >
            <x>FIXME_AUDITOR: If the system is configured to send audit records directly to an audit server, this is NA</x>

            Inadequate log size will cause the log to fill up quickly.  This may prevent audit events from being recorded properly and require frequent attention by administrative personnel.
          type: AUDIT_POWERSHELL
          cmd: reg.exe query "HKLM\SOFTWARE\Policies\Microsoft\Windows\EventLog\Security" /v "MaxSize" 2>$null
          expected: \s*MaxSize\s*REG_DWORD\s*(?![0-1]0[0-2][0-3][0-9]{3}$)([0-9]{7,11})
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for <x>Computer Configuration >> Administrative Templates >> Windows Components >> Event Log Service >> Security >> "Specify the maximum log file size (KB)"</x> to <x>"Enabled"</x> with a <x>"Maximum Log Size (KB)"</x> of "1024000" or greater.
    - id: 8
      title: System event log
      description: Dumps the application event log for analyzis
      collection_cmd: wevtutil.exe get-log System | Out-File -Encoding utf8 -Append -FilePath log_system.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: System event log size
          description: >
            <x>FIXME_AUDITOR: If the system is configured to send audit records directly to an audit server, this is NA</x>

            Inadequate log size will cause the log to fill up quickly.  This may prevent audit events from being recorded properly and require frequent attention by administrative personnel.
          type: AUDIT_POWERSHELL
          cmd: reg.exe query "HKLM\SOFTWARE\Policies\Microsoft\Windows\EventLog\System" /v "MaxSize" 2>$null
          expected: \s*MaxSize\s*REG_DWORD\s*(?![0-3][0-2][0-7][0-6][0-7]$)([0-9]{5,11})
          verification_type: CHECK_REGEX
          severity: medium
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for <x>Computer Configuration >> Administrative Templates >> Windows Components >> Event Log Service >> System >> "Specify the maximum log file size (KB)"</x> to <x>"Enabled"</x> with a <x>"Maximum Log Size (KB)"</x> of "32768" or greater.
    - id: 9
      title: Journalisation des commandes
      description: >
        FIXME
        Voir aussi :
        * https://stigviewer.com/stig/microsoft_windows_server_2019/2022-03-01/finding/V-205638
        * https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/component-updates/command-line-process-auditing
        * https://www.itprotoday.com/strategy/understanding-and-enabling-command-line-auditing
      collection_cmd: $(try { $value = (Get-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\Audit" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath log_cmdline.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: Command line data must be included in process creation events
          description: >
            FIXME
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\Audit" -Name "ProcessCreationIncludeCmdLine_Enabled" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 1
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
    - id: 10
      title: Splunk Universal Forwarder (manuel)
      description: >
        FIXME
        Voir aussi :
        * https://docs.splunk.com/Documentation/Forwarder/
      collection_cmd: >
        $(try { $files = (Get-ChildItem -Path "C:\Program Files\SplunkUniversalForwarder\etc\" -Recurse -File -ErrorAction Stop); ForEach ($file in $files) { If ($file.Extension -eq ".conf") { echo $file.FullName; Get-Content $file.FullName }} } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath splunk_universal_forwarder_conf.txt;
        $($cmd = "C:\Program Files\SplunkUniversalForwarder\bin\splunk.exe"; If (Test-CommandExists $cmd) { & "C:\Program Files\SplunkUniversalForwarder\bin\splunk.exe" btool inputs list --debug } Else { echo "Command not found" }) | Out-File -Encoding utf8 -Append -FilePath splunk_universal_forwarder_inputs_running_conf.txt;
        $($cmd = "C:\Program Files\SplunkUniversalForwarder\bin\splunk.exe"; If (Test-CommandExists $cmd) { & "C:\Program Files\SplunkUniversalForwarder\bin\splunk.exe" btool outputs list --debug } Else { echo "Command not found" }) | Out-File -Encoding utf8 -Append -FilePath splunk_universal_forwarder_outputs_running_conf.txt;
        $($cmd = "C:\Program Files\SplunkUniversalForwarder\bin\splunk.exe"; If (Test-CommandExists $cmd) { & "C:\Program Files\SplunkUniversalForwarder\bin\splunk.exe" btool server list --debug } Else { echo "Command not found" }) | Out-File -Encoding utf8 -Append -FilePath splunk_universal_forwarder_server_running_conf.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: true
- id: 13
  name: Software configuration
  checkpoints:
    - id: 1
      title: Client WinRM
      description: >
        Displays the WinRM configuration - Client side
        Voir aussi :
        * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#subsection.G.2.1
      collection_cmd: $(try { $value = (Get-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\WinRM\Client" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath client_winrm.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: WinRM client do not use Basic authentication
          description: Basic authentication uses plain text passwords that could be used to compromise a system.
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\WinRM\Client" -Name "AllowBasic" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 0
          verification_type: CHECK_EXACT
          severity: high
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for <x>Computer Configuration >> Administrative Templates >> Windows Components >> Windows Remote Management (WinRM) >> WinRM Client >> "Allow Basic authentication"</x> to <x>"Disabled"</x>.
        - id: 2
          title: WinRM client must not use Digest authentication
          description: Digest authentication is not as strong as other options and may be subject to man-in-the-middle attacks. Disallowing Digest authentication will reduce this potential.
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\WinRM\Client" -Name "AllowDigest" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 0
          verification_type: CHECK_EXACT
          severity: high
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for Computer Configuration >> Administrative Templates >> Windows Components >> Windows Remote Management (WinRM) >> WinRM Client >> "Disallow Digest authentication" to "Enabled".
        - id: 3
          title: WinRM client must not allow unencrypted traffic
          description: Unencrypted remote access to a system can allow sensitive information to be compromised. Windows remote management connections must be encrypted to prevent this.
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\WinRM\Client" -Name "AllowUnencryptedTraffic" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 0
          verification_type: CHECK_EXACT
          severity: high
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for Computer Configuration >> Administrative Templates >> Windows Components >> Windows Remote Management (WinRM) >> WinRM Client >> "Allow unencrypted traffic" to "Disabled".
    - id: 2
      title: Service WinRM
      description: >
        Displays the WinRM configuration - Service side
        Voir aussi :
        * https://www.ssi.gouv.fr/uploads/2022/01/anssi-guide-recommandations_securite_journalisation_systemes_microsoft_windows_environnement_active_directory.pdf#subsubsection.G.1.3.1
      collection_cmd: $(try { $value = (Get-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\WinRM\Service" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath service_winrm.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: WinRM service do not use Basic authentication
          description: >
            Basic authentication uses plain text passwords that could be
            used to compromise a system.
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\WinRM\Service" -Name "AllowBasic" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 0
          verification_type: CHECK_EXACT
          severity: high
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for <x>Computer Configuration >> Administrative Templates >> Windows Components >> Windows Remote Management (WinRM) >> WinRM Service >> "Allow Basic authentication"</x> to <x>"Disabled"</x>.
        - id: 2
          title: WinRM service must not store RunAs credentials
          description: >
            Storage of administrative credentials could allow unauthorized access. Disallowing the storage of RunAs credentials for Windows Remote Management will prevent them from being used with plug-ins
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\WinRM\Service" -Name "DisableRunAs" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 1
          verification_type: CHECK_EXACT
          severity: high
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for Computer Configuration >> Administrative Templates >> Windows Components >> Windows Remote Management (WinRM) >> WinRM Service >> "Disallow WinRM from storing RunAs credentials" to "Enabled".
        - id: 3
          title: WinRM service must not allow unencrypted traffic
          description: >
            Unencrypted remote access to a system can allow sensitive information to be compromised. Windows remote management connections must be encrypted to prevent this.
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\WinRM\Service" -Name "AllowUnencryptedTraffic" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 0
          verification_type: CHECK_EXACT
          severity: high
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for Computer Configuration >> Administrative Templates >> Windows Components >> Windows Remote Management (WinRM) >> WinRM Service >> "Allow unencrypted traffic" to "Disabled".
    - id: 3
      title: Remote Desktop Service
      description: Displays the Remote Desktop configuration
      collection_cmd: $(try { $value = (Get-ItemProperty -Path "HKLM:\Software\Policies\Microsoft\Windows Nt\Terminal Services" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath remote_desktop.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: Solicited Remote Assistance is not allowed
          description: >
            Remote assistance allows another user to view or take control of the local session of a user. Solicited assistance is help that is specifically requested by the local user. This may allow unauthorized parties access to the resources on the computer.
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\Software\Policies\Microsoft\Windows Nt\Terminal Services" -Name "fAllowToGetHelp" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 0
          verification_type: CHECK_EXACT
          severity: high
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for <x>Computer Configuration >> Administrative Templates >> System >> Remote Assistance >> "Configure
            Solicited Remote Assistance"</x> to <x>"Disabled"</x>.
        - id: 2
          title: Passwords are not saved in the Remote Desktop Client
          description: >
            Saving passwords in the Remote Desktop Client could allow an unauthorized user to establish a remote desktop session to another system.

            The system must be configured to prevent users from saving passwords in the Remote Desktop Client.
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\Software\Policies\Microsoft\Windows Nt\Terminal Services" -Name "DisablePasswordSaving" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 1
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for <x>Computer Configuration >> Administrative Templates >> Windows Components >> Remote Desktop Services >> Remote Desktop Connection Client >> "Do not allow passwords to be saved"</x> to <x>"Enabled"</x>.
        - id: 3
          title: Local drives are prevented from sharing with Remote Desktop Session Hosts
          description: >
            Preventing users from sharing the local drives on their client computers to Remote Session Hosts that they access helps reduce possible exposure of sensitive data.
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\Software\Policies\Microsoft\Windows Nt\Terminal Services" -Name "fDisableCdm" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 1
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for <x>Computer Configuration >> Administrative Templates >> Windows Components >> Remote Desktop Services >> Remote Desktop Session Host >> Device and Resource Redirection >> "Do not allow drive redirection"</x> to <x>"Enabled"</x>.
        - id: 4
          title: Remote Desktop Services always prompt a client for passwords upon connection
          description: >
            This setting controls the ability of users to supply passwords automatically as part of their remote desktop connection. Disabling this setting would allow anyone to use the stored credentials in a connection item to connect to the terminal server.
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\Software\Policies\Microsoft\Windows Nt\Terminal Services" -Name "fPromptForPassword" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 1
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for <x>Computer Configuration >> Administrative Templates >> Windows Components >> Remote Desktop Services >> Remote Desktop Session Host >> Security >> "Always prompt for password upon connection"</x> to <x>"Enabled"</x>.
        - id: 5
          title: The Remote Desktop Session Host require secure RPC communications
          description: >
            Allowing unsecure RPC communication exposes the system to man in the middle attacks and data disclosure attacks. A man in the middle attack occurs when an intruder captures packets between a client and server and modifies them before allowing the packets to be exchanged. Usually the attacker will modify the information in the packets in an attempt to cause either the client or server to reveal sensitive information.
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\Software\Policies\Microsoft\Windows Nt\Terminal Services" -Name "fEncryptRPCTraffic" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 1
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for <x>Computer Configuration >> Administrative Templates >> Windows Components >> Remote Desktop Services >> Remote Desktop Session Host >> Security "Require secure RPC communication"</x> to <x>"Enabled"</x>.
        - id: 6
          title: Remote Desktop Services is configured with the client connection encryption set to the required level
          description: >
            Remote connections must be encrypted to prevent interception of data or sensitive information. Selecting "High Level" will ensure encryption of Remote Desktop Services sessions in both directions.
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKLM:\Software\Policies\Microsoft\Windows Nt\Terminal Services" -Name "MinEncryptionLevel" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 3
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            Configure the policy value for <x>Computer Configuration >> Administrative Templates >> Windows Components >> Remote Desktop Services >> Remote Desktop Session Host >> Security >> "Set client connection encryption level" to "Enabled"</x> and <x>"High Level"</x>.
        - id: 7
          title: NLA is enabled
          description: >
            La fonction de sécurité de RDP 'Network Level Authentication' permet d'autoriser la connexion uniquement lorsque le client est déjà authentifié. Cette fonction de sécurité permet notamment de complexifier l'exploitation de la vulnérabilité BlueKeep.
          type: AUDIT_POWERSHELL
          cmd: (Get-WmiObject -class "Win32_TSGeneralSetting" -Namespace root\cimv2\terminalservices -Filter "TerminalName='RDP-tcp'").UserAuthenticationRequired
          expected: 1
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            UserAuthentication -> 1
    - id: 4
      title: Exploit Protection mitigations
      description: >
        Exploit protection in Windows 10 provides a means of enabling additional mitigations against potential threats at the system and application level. Without these additional application protections, Windows 10 may be subject to various exploits.
      collection_cmd: Get-ProcessMitigation | Out-File -Encoding utf8 -Append -FilePath process_mitigation.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: true
    - id: 5
      title: The Windows Explorer Preview pane must be disabled
      description: >
        A known vulnerability in Windows 10 could allow the execution of malicious code by either opening a compromised document or viewing it in the Windows Preview pane. Organizations must disable the Windows Preview pane and Windows Detail pane.
      collection_cmd: $(try { $value = (Get-ItemProperty -Path "HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Explorer" -ErrorAction Stop); echo $value } catch { echo $Error[0] }) | Out-File -Encoding utf8 -Append -FilePath explorer.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: The Windows Explorer Preview pane must be disabled (NoPreviewPane)
          description: >
            A known vulnerability in Windows 10 could allow the execution of malicious code by either opening a compromised document or viewing it in the Windows Preview pane. Organizations must disable the Windows Preview pane and Windows Detail pane.
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Explorer" -Name "NoPreviewPane" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 1
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            Ensure the following settings are configured for Windows 10 locally or applied through group policy.

            Configure the policy value for <x>User Configuration >> Administrative Templates >> Windows Components >> File Explorer >> Explorer Frame Pane "Turn off Preview Pane"</x> to <x>"Enabled"</x>.
        - id: 2
          title: The Windows Explorer Preview pane must be disabled (NoReadingPane)
          description: >
            A known vulnerability in Windows 10 could allow the execution of malicious code by either opening a compromised document or viewing it in the Windows Preview pane. Organizations must disable the Windows Preview pane and Windows Detail pane.
          type: AUDIT_POWERSHELL
          cmd: $(try { $value = (Get-ItemPropertyValue -Path "HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Explorer" -Name "NoReadingPane" -ErrorAction Stop); echo $value } catch { echo $Error[0] })
          expected: 1
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            Ensure the following settings are configured for Windows 10 locally or applied through group policy.

            Configure the policy value for <x>User Configuration >> Administrative Templates >> Windows Components >> File Explorer >> Explorer Frame Pane "Turn on or off details pane"</x> to <x>"Enabled"</x> and <x>"Configure details pane"</x> to <x>"Always hide"</x>.
    - id: 6
      title: Illegitimate services are not installed
      description: >
        Il ne doit pas y avoir FTP et Telnet
      collection_cmd: Get-WindowsOptionalFeature -online | Out-File -Encoding utf8 -Append -FilePath windows_optional_feature.txt
      collection_cmd_type: AUDIT_POWERSHELL
      collect_only: false
      checks:
        - id: 1
          title: Telnet is not installed
          description: >
            FIXME
          type: AUDIT_POWERSHELL
          cmd: Get-WindowsOptionalFeature -online | where {$_.FeatureName -eq "Telnet-Client" -and $_.State -eq "Enabled"} | Format-List
          expected: ""
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 2
          title: FTP is not installed
          description: >
            FIXME
          type: AUDIT_POWERSHELL
          cmd: Get-WindowsOptionalFeature -online | where {$_.FeatureName -eq "Web-Ftp-Service" -and $_.State -eq "Enabled"} | Format-List
          expected: ""
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 3
          title: TFTP is not installed
          description: >
            FIXME
          type: AUDIT_POWERSHELL
          cmd: Get-WindowsOptionalFeature -online | where {$_.FeatureName -eq "TFTP-Client" -and $_.State -eq "Enabled"} | Format-List
          expected: ""
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 4
          title: FAX Server role is not present
          description: >
            FIXME
          type: AUDIT_POWERSHELL
          cmd: Get-WindowsOptionalFeature -online | where {$_.FeatureName -eq "Fax" -and $_.State -eq "Enabled"} | Format-List
          expected: ""
          verification_type: CHECK_EXACT
          severity: medium
          level: minimal
          recommendation_on_failed: >
            FIXME
        - id: 5
          title: Internet Information System (IIS) or its subcomponents is not installed
          description: >
            Installation of Internet Information System (IIS) may allow unauthorized internet services to be hosted. Websites must only be hosted on servers that have been designed for that purpose and can be adequately secured.
          type: AUDIT_POWERSHELL
          cmd: Get-WindowsOptionalFeature -online | where {$_.FeatureName -eq "IIS-WebServer" -and $_.State -eq "Enabled"} | Format-List
          expected: ""
          verification_type: CHECK_EXACT
          severity: high
          level: minimal
          recommendation_on_failed: >
            Uninstall <x>"Internet Information Services"</x> or <x>"Internet Information Services Hostable Web Core"</x> from the system.
