- id: 1
  name: Configuration réseau
  checkpoints:
  - id: 1
    title: Configuration des interfaces (manuel)
    description: >
      Récupération de la configuration actuelle des interfaces réseau pour une analyse manuelle complémentaire.
    collection_cmd: >
      find /etc/netplan/ -type f \( -name *.yaml -o -name *.yml \) -exec ls -ailL {} \; -exec cat {} \; > netplan.txt;
      cat /etc/network/interfaces > network_interfaces.txt;
      find /etc/systemd/network/ -type f -exec ls -ailL {} \; -exec cat {} \; > systemd_network_conf.txt;
      ip a > ip_a.txt;
      nmcli general status > network_manager_general_status.txt;
      nmcli connection show > network_manager_connection.txt;
      iwconfig > iwconfig.txt;
      rfkill > bluetooth_rfkill.txt
    collection_cmd_type: CMD_EXEC
    collect_only: true
  - id: 2
    title: Désactivation de la pile IPv6
    description: >
      Si non utilisée, la pile IPv6 doit être désactivée. Cela vient en complément des tests de la section sysctl.
    collect_only: false
    checks:
    - id: 1
      title: La pile IPv6 est désactivée
      description: >
        FIXME
      type: CMD_EXEC
      cmd: '[ -e /boot/grub2/grub.cfg ] && GRUB_CONFIG_FILE=/boot/grub2/grub.cfg || GRUB_CONFIG_FILE=/boot/grub/grub.cfg; PASSING=0; grep -Eq "^\s*linux\s+.*ipv6\.disable=1" "${GRUB_CONFIG_FILE}" && PASSING=1; echo $PASSING'
      expected: 1
      verification_type: CHECK_EXACT
      level: minimal
      recommendation_on_failed: >
        FIXME
      see_also: >
        https://www.ssi.gouv.fr/uploads/2016/01/linux_configuration-fr-v1.2.pdf#section*.2
        https://www.ssi.gouv.fr/uploads/2016/01/linux_configuration-fr-v1.2.pdf#section*.22
  - id: 3
    title: Configuration DNS (manuel)
    description: >
      La résolution de noms doit être réalisée à partir de serveurs de confiance en interne.
    collection_cmd: >
      cat /etc/resolv.conf > resolv_conf.txt;
      cat /etc/systemd/resolved.conf > systemd_resolved.txt;
      resolvectl status > resolvectl_status.txt
    collection_cmd_type: CMD_EXEC
    collect_only: true
  - id: 4
    title: Synchronisation NTP - systemd-timesyncd
    description: >
      Pour de nombreuses raisons, l'équipement doit être synchronisé avec une source de temps fiable. Cela est d'autant plus utile lors de la corrélation des évènements. La synchronisation peut être effectuée via les services (liste non exhaustive) :
      * systemd-timesyncd
      * chrony
      * ntp
    collection_cmd: >
      timedatectl status > systemd_timesyncd_status.txt;
      cat /etc/systemd/timesyncd.conf > systemd_timesyncd_conf.txt
    collection_cmd_type: CMD_EXEC
    collect_only: false
    checks:
    - id: 1
      title: Service systemd-timesyncd actif
      description: >
        FIXME
      type: CMD_EXEC
      cmd: PASSING=0; systemctl show systemd-timesyncd.service -p UnitFileState | grep -q enabled && PASSING=1; echo $PASSING
      expected: 1
      verification_type: CHECK_EXACT
      level: minimal
      recommendation_on_failed: >
        FIXME
      see_also: >
        FIXME
    - id: 2
      title: Les serveurs NTP sont définis
      description: >
        FIXME
      type: CMD_EXEC
      cmd: 'PASSING=0; grep -Eq "^NTP=.*$" /etc/systemd/timesyncd.conf && PASSING=1; echo $PASSING'
      expected: 1
      verification_type: CHECK_EXACT
      level: minimal
      recommendation_on_failed: >
        FIXME
      see_also: >
        FIXME
    - id: 3
      title: Les serveurs NTP en fallback sont définis
      description: >
        FIXME
      type: CMD_EXEC
      cmd: 'PASSING=0; grep -Eq "^FallbackNTP=.*$" /etc/systemd/timesyncd.conf && PASSING=1; echo $PASSING'
      expected: 1
      verification_type: CHECK_EXACT
      level: minimal
      recommendation_on_failed: >
        FIXME
      see_also: >
        FIXME
  - id: 5
    title: Synchronisation NTP - chrony
    description: >
      Pour de nombreuses raisons, l'équipement doit être synchronisé avec une source de temps fiable. Cela est d'autant plus utile lors de la corrélation des évènements. La synchronisation peut être effectuée via les services (liste non exhaustive) :
      * systemd-timesyncd
      * chrony
      * ntp
    collection_cmd: cat /etc/chrony/chrony.conf > chrony_conf.txt
    collection_cmd_type: CMD_EXEC
    collect_only: false
    checks:
    - id: 1
      title: Service chrony actif
      description: >
        FIXME
      type: CMD_EXEC
      cmd: PASSING=0; systemctl show chronyd.service -p UnitFileState | grep -q enabled && PASSING=1; echo $PASSING
      expected: 1
      verification_type: CHECK_EXACT
      level: minimal
      recommendation_on_failed: >
        FIXME
      see_also: >
        FIXME
    - id: 2
      title: Les serveurs NTP sont définis
      description: >
        FIXME
      type: CMD_EXEC
      cmd: 'PASSING=0; grep -Eq "^(server|pool)\s+.*$" /etc/chrony/chrony.conf && PASSING=1; echo $PASSING'
      expected: 1
      verification_type: CHECK_EXACT
      level: minimal
      recommendation_on_failed: >
        FIXME
      see_also: >
        FIXME
  - id: 6
    title: Synchronisation NTP - ntp
    description: >
      Pour de nombreuses raisons, l'équipement doit être synchronisé avec une source de temps fiable. Cela est d'autant plus utile lors de la corrélation des évènements. La synchronisation peut être effectuée via les services (liste non exhaustive) :
      * systemd-timesyncd
      * chrony
      * ntp
    collection_cmd: cat /etc/ntp.conf > ntp_conf.txt
    collection_cmd_type: CMD_EXEC
    collect_only: false
    checks:
    - id: 1
      title: Service ntp actif
      description: >
        FIXME
      type: CMD_EXEC
      cmd: PASSING=0; systemctl show ntp.service -p UnitFileState | grep -q enabled && PASSING=1; echo $PASSING
      expected: 1
      verification_type: CHECK_EXACT
      level: minimal
      recommendation_on_failed: >
        FIXME
      see_also: >
        FIXME
    - id: 2
      title: Les serveurs NTP sont définis
      description: >
        FIXME
      type: CMD_EXEC
      cmd: 'PASSING=0; grep -Eq "^(server|pool)\s+.*$" /etc/ntp.conf && PASSING=1; echo $PASSING'
      expected: 1
      verification_type: CHECK_EXACT
      level: minimal
      recommendation_on_failed: >
        FIXME
      see_also: >
        FIXME
- id: 2
  name: Configuration de ufw
  checkpoints:
  - id: 1
    title: Activation du service
    description: >
      Le service doit être actif afin d'être efficace.
    collect_only: false
    checks:
    - id: 1
      title: Le pare-feu ufw est installé
      description: >
        FIXME
      type: CMD_EXEC
      cmd: PASSING=0; dpkg -s ufw 2>/dev/null | grep -Eq "Status:\sinstall\sok\sinstalled" && PASSING=1; echo $PASSING
      expected: 1
      verification_type: CHECK_EXACT
      level: minimal
      recommendation_on_failed: >
        FIXME
      see_also: >
        FIXME
    - id: 2
      title: Le pare-feu ufw est actif
      description: >
        FIXME
      type: CMD_EXEC
      cmd: PASSING=0; systemctl show ufw.service -p UnitFileState | grep -q enabled && PASSING=1; echo $PASSING
      expected: 1
      verification_type: CHECK_EXACT
      level: minimal
      recommendation_on_failed: >
        FIXME
      see_also: >
        FIXME
  - id: 2
    title: Politique par défaut
    description: >
      FIXME
    collection_cmd: ufw status verbose > fw_ufw.txt
    collection_cmd_type: CMD_EXEC
    collect_only: false
    checks:
    - id: 1
      title: La politique par défaut est à DENY ou REJECT - incoming
      description: >
        FIXME
      type: CMD_EXEC
      cmd: PASSING=0; ufw status verbose | grep -Eq "^Default:\s+(deny|reject)\s+\(incoming\),\s+\S+\s+\(outgoing\),\s+\S+\s+\(routed\)\s*$" && PASSING=1; echo $PASSING
      expected: 1
      verification_type: CHECK_EXACT
      level: minimal
      recommendation_on_failed: >
        FIXME
      see_also: >
        FIXME
    - id: 2
      title: La politique par défaut est à DENY ou REJECT - outgoing
      description: >
        FIXME
      type: CMD_EXEC
      cmd: PASSING=0; ufw status verbose | grep -Eq "^Default:\s+\S+\s+\(incoming\),\s+(deny|reject)\s+\(outgoing\),\s+\S+\s+\(routed\)\s*$" && PASSING=1; echo $PASSING
      expected: 1
      verification_type: CHECK_EXACT
      level: minimal
      recommendation_on_failed: >
        FIXME
      see_also: >
        FIXME
    - id: 3
      title: La politique par défaut est à DENY ou REJECT - routed
      description: >
        FIXME
      type: CMD_EXEC
      cmd: PASSING=0; ufw status verbose | grep -Eq "^Default:\s+\S+\s+\(incoming\),\s+\S+\s+\(outgoing\),\s+(deny|reject)\s+\(routed\)\s*$" && PASSING=1; echo $PASSING
      expected: 1
      verification_type: CHECK_EXACT
      level: minimal
      recommendation_on_failed: >
        FIXME
      see_also: >
        FIXME
  - id: 3
    title: Boucle locale configurée
    description: >
      FIXME
    collect_only: false
    checks:
    - id: 1
      title: IPv4 - La boucle locale accepte le trafic - incoming
      description: >
        FIXME
      type: CMD_EXEC
      cmd: PASSING=0; ufw status verbose | grep -Eq "^Anywhere\s+on\s+lo\s+ALLOW\s+IN\s+Anywhere\s*$" && PASSING=1; echo $PASSING
      expected: 1
      verification_type: CHECK_EXACT
      level: minimal
      recommendation_on_failed: >
        FIXME
      see_also: >
        FIXME
    - id: 2
      title: IPv4 - La boucle locale accepte le trafic - outgoing
      description: >
        FIXME
      type: CMD_EXEC
      cmd: PASSING=0; ufw status verbose | grep -Eq "^Anywhere\s+ALLOW\s+OUT\s+Anywhere\s+on\s+lo\s*$" && PASSING=1; echo $PASSING
      expected: 1
      verification_type: CHECK_EXACT
      level: minimal
      recommendation_on_failed: >
        FIXME
      see_also: >
        FIXME
    - id: 3
      title: IPv4 - Tout trafic venant d'autres interfaces est refusé
      description: >
        FIXME
      type: CMD_EXEC
      cmd: PASSING=0; ufw status verbose | grep -Eq "^Anywhere\s+DENY\s+IN\s+127\.0\.0\.0/8\s*$" && PASSING=1; echo $PASSING
      expected: 1
      verification_type: CHECK_EXACT
      level: minimal
      recommendation_on_failed: >
        FIXME
      see_also: >
        FIXME
    - id: 4
      title: IPv6 - La boucle locale accepte le trafc - incoming
      description: >
        FIXME
      type: CMD_EXEC
      cmd: PASSING=0; ufw status verbose | grep -Eq "^Anywhere\s+\(v6\)\s+on\s+lo\s+ALLOW\s+IN\s+Anywhere\s+\(v6\)\s*$" && PASSING=1; echo $PASSING
      expected: 1
      verification_type: CHECK_EXACT
      level: minimal
      recommendation_on_failed: >
        FIXME
      see_also: >
        FIXME
    - id: 5
      title: IPv6 - La boucle locale accepte le trafic - outgoing
      description: >
        FIXME
      type: CMD_EXEC
      cmd: PASSING=0; ufw status verbose | grep -Eq "^Anywhere\s+\(v6\)\s+ALLOW\s+OUT\s+Anywhere\s+\(v6\)\s+on\s+lo\s*$" && PASSING=1; echo $PASSING
      expected: 1
      verification_type: CHECK_EXACT
      level: minimal
      recommendation_on_failed: >
        FIXME
      see_also: >
        FIXME
    - id: 6
      title: IPv6 - Tout trafic venant d'autres interfaces est refusé
      description: >
        FIXME
      type: CMD_EXEC
      cmd: PASSING=0; ufw status verbose | grep -Eq "^Anywhere\s+\(v6\)\s+DENY\s+IN\s+::1\s*$" && PASSING=1; echo $PASSING
      expected: 1
      verification_type: CHECK_EXACT
      level: minimal
      recommendation_on_failed: >
        FIXME
      see_also: >
        FIXME
  - id: 4
    title: Le filtrage en sortie est conforme à la politique (manuel)
    description: >
      La configuration du filtrage des flux en sortie est conforme à la politique interne de l'entreprise et correspond aux besoins métiers.
    collect_only: true
  - id: 5
    title: Services en écoute
    collection_cmd: ss -4tunlp > services_en_ecoute_ipv4.txt
    collection_cmd_type: CMD_EXEC
    description: >
      Chaque service en écoute sur le réseau doit disposer d'une règle de filtrage permettant de limiter la surface d'attaque.
    collect_only: false
    checks:
    - id: 1
      title: Il existe une règle de filtrage pour service en écoute
      description: >
        FIXME
      type: CMD_EXEC
      cmd: PASSING=$(ss -4tunlp | awk -F' ' '$2 ~ /LISTEN/ {print $5}' | xargs -I{} sh -c 'str={}; port="${str##*:}"; ufw status | grep -Eq "$port(/(tcp|udp))?\s+.*(ALLOW|DENY)" || echo 0' | uniq); { [[ $PASSING == "0" ]] && echo 0 || echo 1; }
      expected: 1
      verification_type: CHECK_EXACT
      level: minimal
      recommendation_on_failed: >
        FIXME
      see_also: >
        FIXME
- id: 3
  name: Configuration de iptables
  checkpoints:
  - id: 1
    title: Activation du service
    description: >
      Le service doit être actif afin d'être efficace.
    collect_only: false
    checks:
    - id: 1
      title: Le pare-feu iptables est installé
      description: >
        FIXME
      type: CMD_EXEC
      cmd: PASSING=0; dpkg -s iptables 2>/dev/null | grep -Eq "Status:\sinstall\sok\sinstalled" && PASSING=1; echo $PASSING
      expected: 1
      verification_type: CHECK_EXACT
      level: minimal
      recommendation_on_failed: >
        FIXME
      see_also: >
        FIXME
    - id: 2
      title: Le pare-feu iptables est actif
      description: >
        FIXME
      type: CMD_EXEC
      cmd: PASSING=0; systemctl show iptables.service -p UnitFileState | grep -q enabled && PASSING=1; echo $PASSING
      expected: 1
      verification_type: CHECK_EXACT
      level: minimal
      recommendation_on_failed: >
        FIXME
      see_also: >
        FIXME
  - id: 2
    title: Politique par défaut
    description: >
      FIXME
    collection_cmd: >
      iptables -L > fw_iptables_list.txt;
      iptables -L -v -n > fw_iptables_list_verbose.txt;
      iptables-save > fw_iptables_save_4.txt;
      ip6tables-save > fw_iptables_save_6.txt
    collection_cmd_type: CMD_EXEC
    collect_only: false
    checks:
    - id: 1
      title: La politique par défaut est à DROP ou REJECT - INPUT
      description: >
        FIXME
      type: CMD_EXEC
      cmd: PASSING=0; iptables -L | grep -Eq "^\s*Chain\s+INPUT\s+\(policy\s+(DROP|REJECT)\).*$" && PASSING=1; echo $PASSING
      expected: 1
      verification_type: CHECK_EXACT
      level: minimal
      recommendation_on_failed: >
        FIXME
      see_also: >
        FIXME
    - id: 2
      title: La politique par défaut est à DROP ou REJECT - FORWARD
      description: >
        FIXME
      type: CMD_EXEC
      cmd: PASSING=0; iptables -L | grep -Eq "^\s*Chain\s+FORWARD\s+\(policy\s+(DROP|REJECT)\).*$" && PASSING=1; echo $PASSING
      expected: 1
      verification_type: CHECK_EXACT
      level: minimal
      recommendation_on_failed: >
        FIXME
      see_also: >
        FIXME
    - id: 3
      title: La politique par défaut est à DROP ou REJECT - OUTPUT
      description: >
        FIXME
      type: CMD_EXEC
      cmd: PASSING=0; iptables -L | grep -Eq "^\s*Chain\s+OUTPUT\s+\(policy\s+(DROP|REJECT)\).*$" && PASSING=1; echo $PASSING
      expected: 1
      verification_type: CHECK_EXACT
      level: minimal
      recommendation_on_failed: >
        FIXME
      see_also: >
        FIXME
  - id: 3
    title: Boucle locale configurée
    description: >
      FIXME
    collect_only: false
    checks:
    - id: 1
      title: La boucle locale accepte le trafic - INPUT
      description: >
        FIXME
      type: CMD_EXEC
      cmd: PASSING=0; iptables -L INPUT -v -n | grep -Eq "^\s*\S+\s+\S+\s+ACCEPT\s+all\s+--\s+lo\s+\*\s+0\.0\.0\.0\/0\s+0\.0\.0\.0\/0\s*(\s*#.*)?$" && PASSING=1; echo $PASSING
      expected: 1
      verification_type: CHECK_EXACT
      level: minimal
      recommendation_on_failed: >
        FIXME
      see_also: >
        FIXME
    - id: 2
      title: La boucle locale accepte le trafic - OUTPUT
      description: >
        FIXME
      type: CMD_EXEC
      cmd: PASSING=0; iptables -L OUTPUT -v -n | grep -Eq "^\s*\S+\s+\S+\s+ACCEPT\s+all\s+--\s+\*\s+lo\s+0\.0\.0\.0\/0\s+0\.0\.0\.0\/0\s*(\s*#.*)?$" && PASSING=1; echo $PASSING
      expected: 1
      verification_type: CHECK_EXACT
      level: minimal
      recommendation_on_failed: >
        FIXME
      see_also: >
        FIXME
    - id: 3
      title: Tout trafic venant d'autres interfaces est refusé
      description: >
        FIXME
      type: CMD_EXEC
      cmd: PASSING=0; iptables -L INPUT -v -n | grep -Eq "^\s*\S+\s+\S+\s+DROP\s+all\s+--\s+\*\s+\*\s+127\.0\.0\.0\/8\s+0\.0\.0\.0\/0\s*(\s*#.*)?$" && PASSING=1; echo $PASSING
      expected: 1
      verification_type: CHECK_EXACT
      level: minimal
      recommendation_on_failed: >
        FIXME
      see_also: >
        FIXME
  - id: 4
    title: Le filtrage en sortie est conforme à la politique (manuel)
    description: >
      La configuration du filtrage des flux en sortie est conforme à la politique interne de l'entreprise et correspond aux besoins métiers.
    collect_only: true
  - id: 5
    title: Il existe une règle pour chaque service en écoute (manuel)
    collection_cmd: ss -4tunlp > services_en_ecoute_ipv4_iptables.txt
    collection_cmd_type: CMD_EXEC
    description: >
      Chaque service en écoute sur le réseau doit disposer d'une règle de filtrage permettant de limiter la surface d'attaque.
    collect_only: true
- id: 4
  name: Configuration de firewalld
  checkpoints:
  - id: 1
    title: Configuration de firewalld (manuel)
    description: >
      FIXME
    collection_cmd: >
      find /etc/firewalld/ -type f -exec ls - ailL {} \; -exec cat {} \; > fw_firewalld_conf.txt;
      firewall-cmd --state > fw_firewalld_status.txt
    collection_cmd_type: CMD_EXEC
    collect_only: false
- id: 5
  name: Configuration de nftables
  checkpoints:
  - id: 1
    title: Configuration de nftables (manuel)
    description: >
      FIXME
    collection_cmd: >
      cat /etc/nftables.conf > fw_nftables_conf.txt;
      find /etc/nftables/ -type f -exec ls - ailL {} \; -exec cat {} \; > fw_nftables_all_conf.txt;
      nft list ruleset > fw_nftables_ruleset.txt
    collection_cmd_type: CMD_EXEC
    collect_only: false
