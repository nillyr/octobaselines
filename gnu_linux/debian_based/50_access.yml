# TODO :
#  - Permissions sur les fichiers (etc/passwd, les dot files des users (ex. : .ssh), /etc/profile.d/ pour le TIMOUT "\-rw-(r|-)--(r|-)--:0:0")

#  - Les home des users à 750 (rwxr-x---)

#  - Configuration de la valeur du umask
#    - https://linuxhint.com/configure-ldap-client-debian/ pour le umask dans LDAP
#    - Les permissions sur les certif ldap

#  - Check les setuid/setguid (voir recommandation R38)

#  - Vérification des droits de modification sur les crons

#  - Configuration selinux/apparmor

- id: 1
  name: Sudo
  checkpoints:
  - id: 1
    title: Installation du paquet sudo
    description: >
      FIXME
    collect_only: false
    checks:
    - id: 1
      title: Le paquet sudo est installé
      description: >
        FIXME
      type: CMD_EXEC
      cmd: PASSING=0; dpkg -s sudo 2>/dev/null | grep -Eq "Status:\sinstall\sok\sinstalled" && PASSING=1; echo $PASSING
      expected: 1
      verification_type: CHECK_EXACT
      severity: info
      level: minimal
      recommendation_on_failed: >
        FIXME
      see_also: >
        https://www.ssi.gouv.fr/uploads/2016/01/linux_configuration-fr-v1.2.pdf#subsection.7.2.2
    - id: 2
      title: Le paquet sudo-ldap est installé
      description: >
        FIXME
      type: CMD_EXEC
      cmd: PASSING=0; dpkg -s sudo-ldap 2>/dev/null | grep -Eq "Status:\sinstall\sok\sinstalled" && PASSING=1; echo $PASSING
      expected: 1
      verification_type: CHECK_EXACT
      severity: info
      level: minimal
      recommendation_on_failed: >
        FIXME
      see_also: >
        https://www.ssi.gouv.fr/uploads/2016/01/linux_configuration-fr-v1.2.pdf#subsection.7.2.2
  - id: 2
    title: Configuration des sudoers
    description: >
      FIXME
    collection_cmd: >
      cat /etc/group > etc_group.txt;
      cat /etc/sudoers > sudoers.txt;
      find /etc/sudoers.d/ -type f -exec ls -ailL {} \; -exec cat {} \; > sudoers_custom.txt
    collection_cmd_type: CMD_EXEC
    collect_only: false
    checks:
    - id: 1
      title: Un groupe habilité à utiliser la commande sudo est spécifié
      description: >
        FIXME
      type: CMD_EXEC
      cmd: PASSING=0; grep -Eq "^[^#]*sudo[^:]*:[^:]*:[^:]*:.+$" /etc/group && PASSING=1; echo $PASSING
      expected: 1
      verification_type: CHECK_EXACT
      severity: high
      level: intermediate
      recommendation_on_failed: >
        FIXME
      see_also: >
        https://www.ssi.gouv.fr/uploads/2016/01/linux_configuration-fr-v1.2.pdf#section*.57
    - id: 2
      title: Aucun utilisateur en dehors du groupe ne peut utiliser la commande sudo
      description: >
        Aucun utilisateur n'est directement spécifié dans le fichier /etc/sudoers (à l'exception du compte root).
      type: CMD_EXEC
      cmd: PASSING=0; [[ -z $(grep -E "^[^%#rootDefaults].*\s+\S+(\(\S+\))?\s*" /etc/sudoers) && -z $(grep -E "^[^%#rootDefaults].*\s+\S+\(\S+\)\s+" /etc/sudoers.d/*) ]] && PASSING=1; echo $PASSING
      expected: 1
      verification_type: CHECK_EXACT
      severity: high
      level: intermediate
      recommendation_on_failed: >
        FIXME
      see_also: >
        https://www.ssi.gouv.fr/uploads/2016/01/linux_configuration-fr-v1.2.pdf#section*.57
    - id: 3
      title: Configuration des directives générales - noexec
      description: >
        FIXME
      type: CMD_EXEC
      cmd: PASSING=0; grep -Eq "^Defaults\s+([^#]+\S+,\s*)*noexec" /etc/sudoers && PASSING=1; echo $PASSING
      expected: 1
      verification_type: CHECK_EXACT
      severity: high
      level: intermediate
      recommendation_on_failed: >
        FIXME
      see_also: >
        https://www.ssi.gouv.fr/uploads/2016/01/linux_configuration-fr-v1.2.pdf#section*.58
    - id: 4
      title: Configuration des directives générales - requiretty
      description: >
        FIXME
      type: CMD_EXEC
      cmd: PASSING=0; grep -Eq "^Defaults\s+([^#]+\S+,\s*)*requiretty" /etc/sudoers && PASSING=1; echo $PASSING
      expected: 1
      verification_type: CHECK_EXACT
      severity: high
      level: intermediate
      recommendation_on_failed: >
        FIXME
      see_also: >
        https://www.ssi.gouv.fr/uploads/2016/01/linux_configuration-fr-v1.2.pdf#section*.58
    - id: 5
      title: Configuration des directives générales - use_pty
      description: >
        FIXME
      type: CMD_EXEC
      cmd: PASSING=0; grep -Eq "^Defaults\s+([^#]+\S+,\s*)*use_pty" /etc/sudoers && PASSING=1; echo $PASSING
      expected: 1
      verification_type: CHECK_EXACT
      severity: high
      level: intermediate
      recommendation_on_failed: >
        FIXME
      see_also: >
        https://www.ssi.gouv.fr/uploads/2016/01/linux_configuration-fr-v1.2.pdf#section*.58
    - id: 6
      title: Configuration des directives générales - umask
      description: >
        FIXME
      type: CMD_EXEC
      cmd: PASSING=0; grep -Eq "^Defaults\s+([^#]+\S+,\s*)*umask=0027" /etc/sudoers && PASSING=1; echo $PASSING
      expected: 1
      verification_type: CHECK_EXACT
      severity: high
      level: intermediate
      recommendation_on_failed: >
        FIXME
      see_also: >
        https://www.ssi.gouv.fr/uploads/2016/01/linux_configuration-fr-v1.2.pdf#section*.58
    - id: 7
      title: Configuration des directives générales - ignore_dot
      description: >
        FIXME
      type: CMD_EXEC
      cmd: PASSING=0; grep -Eq "^Defaults\s+([^#]+\S+,\s*)*ignore_dot" /etc/sudoers && PASSING=1; echo $PASSING
      expected: 1
      verification_type: CHECK_EXACT
      severity: high
      level: intermediate
      recommendation_on_failed: >
        FIXME
      see_also: >
        https://www.ssi.gouv.fr/uploads/2016/01/linux_configuration-fr-v1.2.pdf#section*.58
    - id: 8
      title: Configuration des directives générales - env_reset
      description: >
        FIXME
      type: CMD_EXEC
      cmd: PASSING=0; grep -Eq "^Defaults\s+([^#]+\S+,\s*)*env_reset" /etc/sudoers && PASSING=1; echo $PASSING
      expected: 1
      verification_type: CHECK_EXACT
      severity: high
      level: intermediate
      recommendation_on_failed: >
        FIXME
      see_also: >
        https://www.ssi.gouv.fr/uploads/2016/01/linux_configuration-fr-v1.2.pdf#section*.58
    - id: 9
      title: Configuration des directives générales - passwd_timeout
      description: >
        FIXME
      type: CMD_EXEC
      cmd: PASSING=0; grep -Eq "^Defaults\s+([^#]+\S+,\s*)*passwd_timeout=1" /etc/sudoers && PASSING=1; echo $PASSING
      expected: 1
      verification_type: CHECK_EXACT
      severity: high
      level: intermediate
      recommendation_on_failed: >
        FIXME
      see_also: >
        https://www.ssi.gouv.fr/uploads/2016/01/linux_configuration-fr-v1.2.pdf#section*.58
    - id: 10
      title: Le mot-clé NOPASSWD n'est pas utilisé
      description: >
        FIXME
      type: CMD_EXEC
      cmd: PASSING=0; [[ -z $(grep -E "^[^#].*\s+\S+(\(\S+\))?\s*NOPASSWD" /etc/sudoers) && -z $(grep -E "^[^#].*\s+\S+(\(\S+\))?\s*NOPASSWD" /etc/sudoers.d/*) ]] && PASSING=1; echo $PASSING
      expected: 1
      verification_type: CHECK_EXACT
      severity: high
      level: minimal
      recommendation_on_failed: >
        FIXME
      see_also: >
        https://www.ssi.gouv.fr/uploads/2016/01/linux_configuration-fr-v1.2.pdf#section*.59
    - id: 11
      title: Les spécifications de commandes ne doivent pas faire intervenir de négation
      description: >
        FIXME
      type: CMD_EXEC
      cmd: PASSING=0; [[ -z $(grep -E "^[^#].*\s+\S+(\(\S+\))?\s*\!\S+" /etc/sudoers) && -z $(grep -E "^[^#].*\s+\S+(\(\S+\))?\s*\!\S+" /etc/sudoers.d/*) ]] && PASSING=1; echo $PASSING
      expected: 1
      verification_type: CHECK_EXACT
      severity: high
      level: intermediate
      recommendation_on_failed: >
        FIXME
      see_also: >
        https://www.ssi.gouv.fr/uploads/2016/01/linux_configuration-fr-v1.2.pdf#section*.62
    - id: 12
      title: Le caractère * (wildcard) n'est pas utilisé
      description: >
        FIXME
      type: CMD_EXEC
      cmd: PASSING=0; [[ -z $(grep -E "^[^#].*\s+\S+(\(\S+\))?\s*\*\S*" /etc/sudoers) && -z $(grep -E "^[^#].*\s+\S+(\(\S+\))?\s*\*\S*" /etc/sudoers.d/*) ]] && PASSING=1; echo $PASSING
      expected: 1
      verification_type: CHECK_EXACT
      severity: high
      level: intermediate
      recommendation_on_failed: >
        FIXME
      see_also: >
        https://www.ssi.gouv.fr/uploads/2016/01/linux_configuration-fr-v1.2.pdf#section*.63
