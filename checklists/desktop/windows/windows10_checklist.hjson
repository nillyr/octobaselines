/*
 * @copyright Copyright (c) 2021 Nicolas GRELLETY
 * @license https://opensource.org/licenses/GPL-3.0 GNU GPLv3
 * @link https://github.com/Nillyr/octoreconf-checklists
 * @since 1.0.0
 */
[
  {
    categories: [
        {
        id: 1
        name: Low level
        checkpoints: [
          {
            id: 1
            title: Low level
            description: Checking the boot options and other security settings
            collection_cmd: "bcdedit.exe /enum | Out-File -Encoding utf8 -Append -FilePath boot_options.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: false
            checks: [
                {
                id: 1
                title: Secure Boot is enabled
                description:
                '''
                Secure Boot is a standard that ensures systems boot only to a trusted operating system. Secure Boot is required to support additional security features in Windows 10, including Virtualization Based Security and Credential Guard. If Secure Boot is turned off, these security features will not function.
                '''
                type: AUDIT_POWERSHELL
                cmd: "Confirm-SecureBootUEFI"
                expected: "True"
                verification_type: CHECK_EXACT
                severity: low
                recommendation_on_failed:
                '''
                Enable Secure Boot in the system firmware.
                '''
              },
              {
                id: 2
                title: Data Execution Prevention (DEP)
                description:
                '''
                Data Execution Prevention (DEP) prevents harmful code from running in protected memory locations reserved for Windows and other programs.
                '''
                type: AUDIT_POWERSHELL
                cmd: "bcdedit.exe /enum \"{current}\" | Select-string 'nx'"
                expected: "nx[\\s]*(OptOut|AlwaysOn)"
                verification_type: CHECK_REGEX
                severity: high
                recommendation_on_failed:
                '''
                Configure Data Execution Prevention (DEP) to at least "OptOut" (better: "AlwaysOn").

                Note: BitLocker must be suspended before making changed to the DEP configuration.

                Command as administrator:
                <x>bcdedit.exe /set {current} nx OptOut</x>
                '''
              },
              {
                id: 3
                title: Windows 10 Kernel (Direct Memory Access) DMA Protection is enabled
                description:
                '''
                Kernel DMA Protection to protect PCs against drive-by Direct Memory Access (DMA) attacks using PCI hot plug devices connected to Thunderbolt 3 ports. Drive-by DMA attacks can lead to disclosure of sensitive information residing on a PC, or even injection of malware that allows attackers to bypass the lock screen or control PCs remotely.
                '''
                type: AUDIT_POWERSHELL
                cmd: "reg.exe query \"HKLM\\Software\\Policies\\Microsoft\\Windows\\Kernel DMA Protection\" /v \"DeviceEnumerationPolicy\""
                expected: "\\s*DeviceEnumerationPolicy\\s*REG_DWORD\\s*0"
                verification_type: CHECK_REGEX
                severity: medium
                recommendation_on_failed:
                '''
                Configure the policy value for <x>Computer Configuration >> Administrative Templates >> System >> Kernel DMA Protection >> "Enumeration policy for external devices incompatible with Kernel DMA Protection" to "Enabled" with "Enumeration Policy" set to "Block All"</x>.
                '''
              },
              {
                id: 4
                title: Credential Guard is running on Windows 10 domain-joined systems
                description:
                '''
                <x>FIXME_AUDITOR: THIS IS N/A FOR VDI</x>
                Credential Guard uses virtualization based security to protect information that could be used in credential theft attacks if compromised. This authentication information, which was stored in the Local Security Authority (LSA) in previous versions of Windows, is isolated from the rest of operating system and can only be accessed by privileged system software.
                '''
                type: AUDIT_POWERSHELL
                cmd: "(Get-CimInstance -ClassName Win32_DeviceGuard -Namespace root\\Microsoft\\Windows\\DeviceGuard).RequiredSecurityProperties"
                expected: "1"
                verification_type: CHECK_EXACT
                severity: medium
                recommendation_on_failed:
                '''
                Configure the policy value for <x>Computer Configuration >> Administrative Templates >> System >> Device Guard >> "Turn On Virtualization Based Security" to "Enabled" with "Enabled with UEFI lock" selected for "Credential Guard Configuration:"</x>.
                '''
              }
            ]
          },
          {
            id: 2
            title: Structured Exception Handling Overwrite Protection (SEHOP)
            description:
            '''
            Attackers are constantly looking for vulnerabilities in systems and applications. Structured Exception Handling Overwrite Protection (SEHOP) blocks exploits that use the Structured Exception Handling overwrite technique, a common buffer overflow attack.
            '''
            collection_cmd: "reg.exe query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\Session Manager\\kernel\" | Out-File -Encoding utf8 -Append -FilePath sehop.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: false
            checks: [
              {
                id: 1
                title: SEHOP is turned on
                type: AUDIT_POWERSHELL
                cmd: "reg.exe query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\Session Manager\\kernel\" /v \"DisableExceptionChainValidation\""
                expected: "\\s*DisableExceptionChainValidation\\s*REG_DWORD\\s*0x0"
                verification_type: CHECK_REGEX
                severity: high
                recommendation_on_failed:
                '''
                Configure the policy value for <x>Computer Configuration >> Administrative Templates >> MS Security Guide >> "Enable Structured Exception Handling Overwrite Protection (SEHOP)" to "Enabled"</x>.
                '''
              }
            ]
          },
          {
            id: 3
            title: Bitlocker status
            description: Checking the status of Bitlocker
            collection_cmd: "manage-bde -status | Out-File -Encoding utf8 -Append -FilePath bitlocker_status.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: false
            checks: [
                {
                id: 1
                title: All disks encrypted
                description:
                '''
                <x>FIXME_AUDITOR CHECK FOR ANOTHER TOOLS IF FAILED (CRYHOD/ETC.)</x>
                If data at rest is unencrypted, it is vulnerable to disclosure. Even if the operating system enforces permissions on data access, an adversary can remove non-volatile memory and read it directly, thereby circumventing operating system controls. Encrypting the data ensures that confidentiality is protected even when the operating system is not running.
                '''
                type: AUDIT_POWERSHELL
                cmd: "$($volumes = Get-BitLockerVolume; If ($volumes | Where {$_.ProtectionStatus -ne 'On'}) { 'Some disks are not encrypted' } Else { 'All disks are encrypted' })"
                expected: "All disks are encrypted"
                verification_type: CHECK_EXACT
                severity: medium
                recommendation_on_failed:
                '''
                Enable full disk encryption on all information systems using BitLocker. BitLocker, included in Windows, can be enabled in the Control Panel under "BitLocker Drive Encryption" as well as other management tools.
                '''
              }
            ]
          },
          {
            id: 4
            title: Bitlocker configuration
            description: Verify disk encryption
            collection_cmd: "reg.exe query \"HKLM\\SOFTWARE\\Policies\\Microsoft\\FVE\" | Out-File -Encoding utf8 -Append -FilePath bitlocker_conf.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: false
            checks: [
              {
                id: 1
                title: Bitlocker PIN for pre-boot authentication (UseAdvancedStartup)
                description:
                '''
                If data at rest is unencrypted, it is vulnerable to disclosure. Even if the operating system enforces permissions on data access, an adversary can remove non-volatile memory and read it directly, thereby circumventing operating system controls. Encrypting the data ensures that confidentiality is protected even when the operating system is not running. Pre-boot authentication prevents unauthorized users from accessing encrypted drives.
                '''
                type: AUDIT_POWERSHELL
                cmd: "reg.exe query \"HKLM\\SOFTWARE\\Policies\\Microsoft\\FVE\" /v \"UseAdvancedStartup\""
                expected: "\\s*UseAdvancedStartup\\s*REG_DWORD\\s*0x1"
                verification_type: CHECK_REGEX
                severity: medium
                recommendation_on_failed:
                '''
                Configure the policy value for <x>Computer Configuration >> Administrative Templates >> Windows Components >> BitLocker Drive Encryption >> Operating System Drives "Require additional authentication at startup"</x> to </x>"Enabled"</x> with <x>"Configure TPM Startup PIN:"</x> set to <x>"Require startup PIN with TPM"</x> or with <x>"Configure TPM startup key and PIN:"</x> set to <x>"Require startup key and PIN with TPM"</x>.
                '''
              },
              {
                id: 2
                title: Bitlocker PIN for pre-boot authentication (UseTPMPIN)
                description:
                '''
                If data at rest is unencrypted, it is vulnerable to disclosure. Even if the operating system enforces permissions on data access, an adversary can remove non-volatile memory and read it directly, thereby circumventing operating system controls. Encrypting the data ensures that confidentiality is protected even when the operating system is not running. Pre-boot authentication prevents unauthorized users from accessing encrypted drives.
                '''
                type: AUDIT_POWERSHELL
                cmd: "reg.exe query \"HKLM\\SOFTWARE\\Policies\\Microsoft\\FVE\" /v \"UseTPMPIN\""
                expected: "\\s*UseTPMPIN\\s*REG_DWORD\\s*0x(1|2)"
                verification_type: CHECK_REGEX
                severity: medium
                recommendation_on_failed:
                '''
                Configure the policy value for <x>Computer Configuration >> Administrative Templates >> Windows Components >> BitLocker Drive Encryption >> Operating System Drives "Require additional authentication at startup"</x> to </x>"Enabled"</x> with <x>"Configure TPM Startup PIN:"</x> set to <x>"Require startup PIN with TPM"</x> or with <x>"Configure TPM startup key and PIN:"</x> set to <x>"Require startup key and PIN with TPM"</x>.
                '''
              },
              {
                id: 3
                title: Bitlocker PIN for pre-boot authentication (UseTPMKeyPIN)
                description:
                '''
                If data at rest is unencrypted, it is vulnerable to disclosure. Even if the operating system enforces permissions on data access, an adversary can remove non-volatile memory and read it directly, thereby circumventing operating system controls. Encrypting the data ensures that confidentiality is protected even when the operating system is not running. Pre-boot authentication prevents unauthorized users from accessing encrypted drives.
                '''
                type: AUDIT_POWERSHELL
                cmd: "reg.exe query \"HKLM\\SOFTWARE\\Policies\\Microsoft\\FVE\" /v \"UseTPMKeyPIN\""
                expected: "\\s*UseTPMKeyPIN\\s*REG_DWORD\\s*0x(1|2)"
                verification_type: CHECK_REGEX
                severity: medium
                recommendation_on_failed:
                '''
                Configure the policy value for <x>Computer Configuration >> Administrative Templates >> Windows Components >> BitLocker Drive Encryption >> Operating System Drives "Require additional authentication at startup"</x> to </x>"Enabled"</x> with <x>"Configure TPM Startup PIN:"</x> set to <x>"Require startup PIN with TPM"</x> or with <x>"Configure TPM startup key and PIN:"</x> set to <x>"Require startup key and PIN with TPM"</x>.
                '''
              },
              {
                id: 4
                title: Lenght of Bitlocker PIN (MinimumPIN)
                description:
                '''
                If data at rest is unencrypted, it is vulnerable to disclosure. Even if the operating system enforces permissions on data access, an adversary can remove non-volatile memory and read it directly, thereby circumventing operating system controls. Encrypting the data ensures that confidentiality is protected even when the operating system is not running. Pre-boot authentication prevents unauthorized users from accessing encrypted drives. Increasing the pin length requires a greater number of guesses for an attacker.
                '''
                type: AUDIT_POWERSHELL
                cmd: "reg.exe query \"HKLM\\SOFTWARE\\Policies\\Microsoft\\FVE\" /v \"MinimumPIN\""
                expected: "\\s*MinimumPIN\\s*REG_DWORD\\s*0x((?!0-5)$|([6-9]|[a-fA-F]|[1-9][0-9a-fA-F]+))"
                verification_type: CHECK_REGEX
                severity: medium
                recommendation_on_failed:
                '''
                Configure the policy value for <x>Computer Configuration >> Administrative Templates >> Windows Components >> BitLocker Drive Encryption >> Operating System Drives "Configure minimum PIN length for startup"</x> to <x>"Enabled"</x> with <x>"Minimum characters:"</x> set to "6" or greater.
                '''
              }
            ]
          },
          {
            id: 5
            title: Early Launch Antimalware
            description:
            '''
            Ensure that Early Launch Antimalware - Boot-Start Driver Initialization policy is set to enforce "Good, unknown and bad but critical" (preventing "bad").
            '''
            collection_cmd: "reg.exe query \"HKLM\\SYSTEM\\CurrentControlSet\\Policies\\EarlyLaunch\" /v \"DriverLoadPolicy\" | Out-File -Encoding utf8 -Append -FilePath early_launch.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: false
            checks: [
              {
                id: 1
                title: Driver load policy
                description:
                '''
                By being launched first by the kernel, ELAM (Early Launch Antimalware) is ensured to be launched before any third-party software, and is therefore able to detect malware in the boot process and prevent it from initializing.
                '''
                type: AUDIT_POWERSHELL
                cmd: "reg.exe query \"HKLM\\SYSTEM\\CurrentControlSet\\Policies\\EarlyLaunch\" /v \"DriverLoadPolicy\""
                expected: "\\s*DriverLoadPolicy\\s*REG_DWORD\\s*0x(1|3|8)"
                verification_type: CHECK_REGEX
                severity: medium
                recommendation_on_failed:
                '''
                Ensure that Early Launch Antimalware - Boot-Start Driver Initialization policy is set to enforce "Good, unknown and bad but critical" (preventing "bad").
                '''
              }
            ]
          }
        ]
      },
      {
        id: 2
        name: System
        checkpoints: [
          {
            id: 1
            title: System information
            description: Retrieving information from the system in use
            collection_cmd: "systeminfo.exe | Out-File -Encoding utf8 -Append -FilePath systeminfo.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: true
          },
          {
            id: 2
            title: Version management
            description:
            '''
            This checkpoint verifies the use of an up-to-date and maintained version of Windows 10.
            '''
            collection_cmd: "systeminfo.exe | Out-File -Encoding utf8 -Append -FilePath systeminfo.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: false
            checks: [
              {
                id: 1
                title: Use of Windows 10
                description:
                '''
                Using a version supported by Microsoft allows to get system security updates.
                '''
                type: AUDIT_POWERSHELL
                cmd: "reg.exe query \"HKLM\\Software\\Microsoft\\Windows Nt\\Currentversion\" /v \"ProductName\""
                expected: "Windows\\s10"
                verification_type: CHECK_REGEX
                severity: high
                recommendation_on_failed:
                '''
                We recommand using a supported version of Windows 10 Enterprise.
                '''
              },
              {
                id: 2
                title: Use of the enterprise version
                description:
                '''
                The Enterprise version of Windows 10 allows the activation of many security features.
                '''
                type: AUDIT_POWERSHELL
                cmd: "reg.exe query \"HKLM\\Software\\Microsoft\\Windows Nt\\Currentversion\" /v \"ProductName\""
                expected: "Enterprise|Entreprise"
                verification_type: CHECK_REGEX
                severity: high
                recommendation_on_failed:
                '''
                We recommend using the Enterprise version of Windows 10.
                '''
              }
            ]
          },
          {
            id: 3
            title: Security Updates
            description: Verification of the installation of security updates
            collection_cmd: "WMIC.exe qfe list full /format:csv | Out-File -Encoding utf8 -Append -FilePath updates_list.csv"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: true
          },
          {
            id: 4
            title: Windows Update Settings Part.1
            description: Verification of the installation of security updates
            collection_cmd: "reg.exe query \"HKLM\\Software\\Policies\\Microsoft\\Windows\\WindowsUpdate\" | Out-File -Encoding utf8 -Append -FilePath updates_registry_options.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: false
            checks: [
              {
                id: 1
                title: Secure communications with the update server
                description:
                '''
                When using an update server, it is important to ensure the security of the exchanges. Otherwise, an attacker could install a malicious program that will be installed with SYSTEM rights.
                '''
                type: AUDIT_POWERSHELL
                cmd: "reg.exe query \"HKLM\\Software\\Policies\\Microsoft\\Windows\\WindowsUpdate\" /v \"WUServer\""
                expected: "\\s*WUServer\\s*REG_SZ\\s*(https://|$)"
                verification_type: CHECK_REGEX
                severity: high
                recommendation_on_failed:
                '''
                We recommend to force WSUS deployments to use a secured HTTPS channel.
                '''
                see_also: https://techcommunity.microsoft.com/t5/windows-it-pro-blog/security-best-practices-for-windows-server-update-services-wsus/ba-p/1587536
              }
            ]
          },
          {
            id: 5
            title: Windows Update Settings Part.2
            description: Verification of the installation of security updates
            collection_cmd: "reg.exe query \"HKLM\\Software\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU\" | Out-File -Encoding utf8 -Append -FilePath updates_registry_options.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: true
          },
          {
            id: 6
            title: Inclusion in the domain
            description:
            '''
            Verifies that the workstation is included in the domain so that it can be managed globally.
            '''
            collection_cmd: "reg.exe query \"HKLM\\System\\CurrentControlSet\\Services\\Tcpip\\Parameters\" | Out-File -Encoding utf8 -Append -FilePath domaine_tcpip.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: false
            checks: [
              {
                id: 1
                title: The workstation is included in a domain
                description:
                '''
                The inclusion of a machine in the domain allows to manage it (deployment of group policies, security maintenance, etc.).
                '''
                type: AUDIT_POWERSHELL
                cmd: "(Get-WmiObject -Class Win32_ComputerSystem).PartOfDomain"
                expected: "True"
                verification_type: CHECK_EXACT
                severity: info
                recommendation_on_failed:
                '''
                We recommend adding the machine to the domain.
                '''
              }
            ]
          }
        ]
      },
      {
        id: 3
        name: Peripherals
        checkpoints: [
          {
            id: 1
            title: Logical volumes
            description: Local volumes must be formatted using NTFS.
            collection_cmd: "Get-WmiObject -Namespace root\\cimv2 -Class Win32_LogicalDisk | Select-Object -Property * | Out-File -Encoding utf8 -Append -FilePath logical_disk.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: false
            checks: [
                {
                id: 1
                title: All disks are formatted using NTFS
                description:
                '''
                In order to maintain security and proper access control, the ability to set access permissions and auditing is critical. To support that, the volumes must be formatted using the NTFS file system.
                '''
                type: AUDIT_POWERSHELL
                cmd: "$($volumes = Get-WmiObject -Namespace root\\cimv2 -Class Win32_LogicalDisk | Select-Object -Property MediaType, FileSystem; If ($volumes | Where {$_.MediaType -eq '12' -And $_.FileSystem -ne 'NTFS'}) { 'Some disks not formatted using NTFS.' } Else { 'All disks are formatted using NTFS' })"
                expected: "All disks are formatted using NTFS"
                verification_type: CHECK_EXACT
                severity: high
                recommendation_on_failed:
                '''
                We recommand formatting every local volume using NTFS file system.
                '''
              }
            ]
          },
          {
            id: 2
            title: Peripherals Policy
            description: Autoplay must be disabled for all drives
            collection_cmd: "reg.exe query \"HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\policies\\Explorer\" | Out-File -Encoding utf8 -Append -FilePath peripheral_policy.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: false
            checks: [
              {
                id: 1
                title: Autoplay is disabled for all drives
                description:
                '''
                Allowing <x>autoplay</x> to execute may introduce malicious code to a system. <x>Autoplay</x> begins reading from a drive as soon as you insert media in the drive. As a result, the setup file of programs or music on audio media may start. By default, <x>autoplay</x> is disabled on removable drives, such as the floppy disk drive (but not the CD-ROM drive) and on network drives.
                '''
                type: AUDIT_POWERSHELL
                cmd: "reg.exe query \"HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\policies\\Explorer\" /v \"NoDriveTypeAutoRun\""
                expected: "\\s*NoDriveTypeAutoRun\\s*REG_DWORD\\s*ff"
                verification_type: CHECK_REGEX
                severity: high
                recommendation_on_failed:
                '''
                Configure the policy value for <x>Computer Configuration >> Administrative Templates >> Windows Components >> AutoPlay Policies >> "Turn off AutoPlay"</x> to <x>"Enabled:All Drives"</x>.
                '''
              }
            ]
          }
        ]
      },
      {
        id: 4
        name: Local Users
        checkpoints: [
          {
            id: 1
            title: Whoami
            description: Whoami
            collection_cmd: "whoami /all | Out-File -Encoding utf8 -Append -FilePath whoami.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: true
          },
          {
            id: 2
            title: Local users
            description: List local users of the workstation
            collection_cmd: "Get-WmiObject -Namespace root\\cimv2 -Class Win32_UserAccount | Select-Object -Property * | Out-File -Encoding utf8 -Append -FilePath local_users.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: false
            checks: [
              {
                id: 1
                title: Accounts must be configured to require password expiration
                description:
                '''
                Passwords that do not expire increase exposure with a greater probability of being discovered or cracked.
                '''
                type: AUDIT_POWERSHELL
                cmd: "$($users = Get-WmiObject -Namespace root\\cimv2 -Query \"SELECT * FROM Win32_UserAccount WHERE LocalAccount='True' AND Disabled='False' AND PasswordExpires='False'\" | Measure-Object | Select-Object -Property Count; If ($users | Where { $_.Count -ne '0'}) { 'Failed' } Else { 'Success' })"
                expected: "Success"
                verification_type: CHECK_EXACT
                severity: medium
                recommendation_on_failed:
                '''
                We recommend configuring all passwords to expire.

                Run <x>"Computer Management"</x>.
                Navigate to <x>System Tools >> Local Users and Groups >> Users</x>.
                Double click each active account.
                Ensure <x>"Password never expires"</x> is not checked on all active accounts.
                '''
              },
              {
                id: 2
                title: Local administrator account is disabled
                description:
                '''
                The local administration account (RID 500) must be disabled after the machine is enrolled in the active directory.
                '''
                type: AUDIT_POWERSHELL
                cmd: "$($adm = Get-WmiObject -Namespace root\\cimv2 -Query \"SELECT * FROM Win32_UserAccount WHERE LocalAccount='True' AND SID LIKE '%500'\"; If ($adm | Where { $_.Disabled -eq 'True' }) { 'Success' } Else { 'Failed' })"
                expected: "Success"
                verification_type: CHECK_EXACT
                severity: medium
                recommendation_on_failed:
                '''
                We recommend disabling the local administrator account (RID 500). In the event the access to the recovery console or boot in Safe Mode is needed, the account must be manually re-enabled for the session only with the following command:
                <x>net user administrator /active:yes</x>

                It is important to note that disabling this account may have availability impacts in some cases.

                If this account could not be disabled, we recommend renaming it. Renaming this account to an unidentified name improves the protection of this account and the system. In addition, it makes it more difficult for brute force attacks to be attempted and thus for the account to be locked out.

                However, it is important to note that in case the hash of the account is compromised (lateral propagation). The RID of the latter being invariable (RID 500), the recovery of the name is doable.
                '''
              },
              {
                id: 3
                title: Guest account is disabled
                description:
                '''
                A system faces an increased vulnerability threat if the built-in guest account is not disabled.  This account is a known account that exists on all Windows systems and cannot be deleted.  This account is initialized during the installation of the operating system with no password assigned.
                '''
                type: AUDIT_POWERSHELL
                cmd: "$($guest = Get-WmiObject -Namespace root\\cimv2 -Query \"SELECT * FROM Win32_UserAccount WHERE LocalAccount='True' AND SID LIKE '%501'\"; If ($guest | Where { $_.Disabled -eq 'True' }) { 'Success' } Else { 'Failed' })"
                expected: "Success"
                verification_type: CHECK_EXACT
                severity: medium
                recommendation_on_failed:
                '''
                We recommend disabling the built-in guest account.

                Configure the policy value for <x>Computer Configuration >> Windows Settings >> Security Settings >> Local Policies >> Security Options >> "Accounts: Guest account status"</x> to <x>"Disabled"</x>.
                '''
              }
            ]
          },
          {
            id: 3
            title: Local groups
            description: List local groups of the workstation
            collection_cmd: "Get-WmiObject -Namespace root\\cimv2 -Class Win32_Group -Filter \"LocalAccount='True'\" | Select-Object -Property * | Out-File -Encoding utf8 -Append -FilePath local_groups.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: true
          },
          {
            id: 4
            title: Administrator local groups
            description: Evaluation of the legitimacy of the accounts in the local group of administrators
            collection_cmd: "Get-LocalGroupMember -SID 'S-1-5-32-544' | Out-File -Encoding utf8 -Append -FilePath admin_local_group_members.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: false
            checks: [
              {
                id: 1
                title: EN - Standard user accounts must not be members of the local administrators group
                description:
                '''
                For domain-joined workstations, administrators must belong to a domain workstation administrator group. Restricting highly privileged accounts from the Local Administrators group helps mitigate the risk of privilege escalation resulting from credential theft attacks.

                Standard user accounts must not be members of the local administrators group.
                '''
                type: AUDIT_POWERSHELL
                cmd: "$($admins = Get-WmiObject -Namespace root\\cimv2 -Query \"SELECT * FROM Win32_GroupUser WHERE GroupComponent=`\"Win32_Group.Domain='$env:COMPUTERNAME',Name='Administrators'`\"\"; $admins | Where { $_.PartComponent -like '*Win32_UserAccount.Domain=\"'+$env:userdomain+'\"*' } | Select-Object -Property PartComponent)"
                expected: ""
                verification_type: CHECK_EXACT
                severity: medium
                recommendation_on_failed:
                '''
                Configure the system to include only administrator groups or accounts that are responsible for the system in the local Administrators group.

                For domain-joined workstations, the Domain Admins group must be replaced by a domain workstation administrator group.

                Remove any standard user accounts.
                '''
              },
              {
                id: 2
                title: FR - Standard user accounts must not be members of the local administrators group
                description:
                '''
                For domain-joined workstations, administrators must belong to a domain workstation administrator group. Restricting highly privileged accounts from the Local Administrators group helps mitigate the risk of privilege escalation resulting from credential theft attacks.

                Standard user accounts must not be members of the local administrators group.
                '''
                type: AUDIT_POWERSHELL
                cmd: "$($admins = Get-WmiObject -Namespace root\\cimv2 -Query \"SELECT * FROM Win32_GroupUser WHERE GroupComponent=`\"Win32_Group.Domain='$env:COMPUTERNAME',Name='Administrateurs'`\"\"; $admins | Where { $_.PartComponent -like '*Win32_UserAccount.Domain=\"'+$env:userdomain+'\"*' } | Select-Object -Property PartComponent)"
                expected: ""
                verification_type: CHECK_EXACT
                severity: medium
                recommendation_on_failed:
                '''
                Configure the system to include only administrator groups or accounts that are responsible for the system in the local Administrators group.

                For domain-joined workstations, the Domain Admins group must be replaced by a domain workstation administrator group.

                Remove any standard user accounts.
                '''
              }
            ]
          },
          {
            id: 5
            title: Presence of inactive local accounts
            description:
            '''
            The presence of accounts that were last logged in more than 35 days ago may indicate a problem in the management of user accounts and may represent a security risk.
            '''
            collection_cmd: "([ADSI]('WinNT://{0}' -f $env:computername)).Children | Where { $_.SchemaClassName -eq 'user' } | ForEach {$user = ([ADSI]$_.Path); $lastLogin = $user.Properties.LastLogin.Value; $enabled = ($user.Properties.UserFlags.Value -band 0x2) -ne 0x2; If ($lastLogin -eq $null) {$lastLogin = 'Never'}; Write-Host $user.Name $lastLogin $enabled;} 6> inactive_local_accounts.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: true
          }
        ]
      },
      {
        id: 5
        name: User session
        checkpoints: [
          {
            id: 1
            title: Battery power setting
            description: Checking the power parameters
            collection_cmd: "powercfg.exe -q | Out-File -Encoding utf8 -Append -FilePath powercfg.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: true
          },
          {
            id: 2
            title: Lock screen personalization
            description: Checking the lock screen personalization
            collection_cmd: "reg.exe query \"HKLM\\Software\\Policies\\Microsoft\\Windows\\Personalization\" | Out-File -Encoding utf8 -Append -FilePath lock_screen_personalization.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: false
            checks: [
              {
                id: 1
                title: Display of slide shows on the lock screen
                description:
                '''
                Slide shows that are displayed on the lock screen could display sensitive information to unauthorized personnel. Turning off this feature will limit access to the information to a logged on user.
                '''
                type: AUDIT_POWERSHELL
                cmd: "reg.exe query \"HKLM\\Software\\Policies\\Microsoft\\Windows\\Personalization\" /v \"NoLockScreenSlideshow\""
                expected: "\\s*NoLockScreenSlideshow\\s*REG_DWORD\\s*1"
                verification_type: CHECK_REGEX
                severity: medium
                recommendation_on_failed:
                '''
                We recommand to prevent the display of slide shows that could contain sensitive information to unauthorized personnel.

                Configure the policy value for <x>Computer Configuration >> Administrative Templates >> Control Panel >> Personalization >> "Prevent enabling lock screen slide show"</x> to <x>"Enabled"</x>.
                '''
              },
              {
                id: 2
                title: Camera access from the lock screen is disabled
                description:
                '''
                <x>FIXME_AUDITOR : if the workstation does not have a camera this is N/A</x>
                Enabling camera access from the lock screen could allow for unauthorized use. Requiring logon will ensure the device is only used by authorized personnel.
                '''
                type: AUDIT_POWERSHELL
                cmd: "reg.exe query \"HKLM\\Software\\Policies\\Microsoft\\Windows\\Personalization\" /v \"NoLockScreenCamera\""
                expected: "\\s*NoLockScreenCamera\\s*REG_DWORD\\s*1"
                verification_type: CHECK_REGEX
                severity: medium
                recommendation_on_failed:
                '''
                We recommend not to enabling camera access from the lock screen.

                Configure the policy value for <x>Computer Configuration >> Administrative Templates >> Control Panel >> Personalization >> "Prevent enabling lock screen camera"</x> to <x>"Enabled"</x>.
                '''
              }
            ]
          },
          {
            id: 3
            title: Cached logon session
            description: Caching of logon credentials must be limited
            collection_cmd: "reg.exe query \"HKLM\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\" | Out-File -Encoding utf8 -Append -FilePath winlogon.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: false
            checks: [
              {
                id: 1
                title: Number of cached logon sessions
                description:
                '''
                The default Windows configuration caches the last logon credentials for users who log on interactively to a system. This feature is provided for system availability reasons, such as the user's machine being disconnected from the network or domain controllers being unavailable. Even though the credential cache is well-protected, if a system is attacked, an unauthorized individual may isolate the password to a domain user account using a password-cracking program and gain access to the domain.
                '''
                type: AUDIT_POWERSHELL
                cmd: "reg.exe query \"HKLM\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\" /v \"CachedLogonsCount\""
                expected: "\\s*CachedLogonsCount\\s*REG_SZ\\s*[0..2]"
                verification_type: CHECK_REGEX
                severity: medium
                recommendation_on_failed:
                '''
                We recommand setting the number of cached logons credentials to at most 2.

                Configure the policy value for <x>Computer Configuration >> Windows Settings >> Security Settings >> Local Policies >> Security Options >> "Interactive logon: Number of previous logons to cache (in case domain controller is not available)"</x> to 2 or less.
                '''
              }
            ]
          }
        ]
      },
      {
        id: 6
        name: Policies
        checkpoints: [
          {
            id: 1
            title: GPO
            description: Retrieving Group Policy Objects for analysis
            collection_cmd: "gpresult.exe /H gpo.html"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: true
          },
          {
            id: 2
            title: Security policies
            description: Retrieving security policies for analysis
            collection_cmd: "secedit.exe /export /cfg security_policies.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: false
            checks: [
              {
                id: 1
                title: Reversible password encryption is disabled
                description:
                '''
                Storing passwords using reversible encryption is essentially the same as storing clear-text versions of the passwords. For this reason, this policy must never be enabled.
                '''
                type: AUDIT_POWERSHELL
                cmd: "secedit.exe /export /cfg delete_me_security_policies.txt; Select-String -Path delete_me_security_policies.txt -Pattern \"ClearTextPassword\""
                expected: ".*ClearTextPassword\\s=\\s0"
                verification_type: CHECK_REGEX
                severity: high
                recommendation_on_failed:
                '''
                Configure the policy value for <x>Computer Configuration >> Windows Settings >> Security Settings >> Account Policies >> Password Policy >> "Store passwords using reversible encryption"</x> to <x>"Disabled"</x>.
                '''
              },
              {
                id: 2
                title: The Debug programs user right is only assigned to the Administrators group
                description:
                '''
                Inappropriate granting of user rights can provide system, administrative, and other high level capabilities. Accounts with the "Debug Programs" user right can attach a debugger to any process or to the kernel, providing complete access to sensitive and critical operating system components. This right is given to Administrators in the default configuration.
                '''
                type: AUDIT_POWERSHELL
                cmd: "secedit.exe /export /cfg delete_me_security_policies.txt; Select-String -Path delete_me_security_policies.txt -Pattern \"SeDebugPrivilege\""
                expected: ".*SeDebugPrivilege\\s=\\s.*\\-544"
                verification_type: CHECK_REGEX
                severity: high
                recommendation_on_failed:
                '''
                Configure the policy value for <x>Computer Configuration >> Windows Settings >> Security Settings >> Local Policies >> User Rights Assignment >> "Debug programs"</x> to only include the following groups or accounts: Administrators.
                '''
              },
              {
                id: 3
                title: The Create a token object user right must not be assigned to any groups or accounts
                description:
                '''
                Inappropriate granting of user rights can provide system, administrative, and other high level capabilities. The "Create a token object" user right allows a process to create an access token. This could be used to provide elevated rights and compromise a system.
                '''
                type: AUDIT_POWERSHELL
                cmd: "secedit.exe /export /cfg delete_me_security_policies.txt; Select-String -Path delete_me_security_policies.txt -Pattern \"SeCreateTokenPrivilege\""
                expected: ""
                verification_type: CHECK_EXACT
                severity: high
                recommendation_on_failed:
                '''
                Configure the policy value for <x>Computer Configuration >> Windows Settings >> Security Settings >> Local Policies >> User Rights Assignment >> "Create a token object"</x> to be defined but containing no entries (blank).
                '''
              },
              {
                id: 4
                title: The <x>Act as part of the operating system</x> user right must not be assigned to any groups or accounts
                description:
                '''
                Inappropriate granting of user rights can provide system, administrative, and other high level capabilities.

                Accounts with the <x>"Act as part of the operating system"</x> user right can assume the identity of any user and gain access to resources that user is authorized to access.  Any accounts with this right can take complete control of a system.
                '''
                type: AUDIT_POWERSHELL
                cmd: "secedit.exe /export /cfg delete_me_security_policies.txt; Select-String -Path delete_me_security_policies.txt -Pattern \"SeTcbPrivilege\""
                expected: ""
                verification_type: CHECK_EXACT
                severity: high
                recommendation_on_failed:
                '''
                Configure the policy value for <x>Computer Configuration >> Windows Settings >> Security Settings >> Local Policies >> User Rights Assignment >> "Act as part of the operating system"</x> to be defined but containing no entries (blank).
                '''
              }
            ]
          }
        ]
      },
      {
        id: 7
        name: Passwords
        checkpoints: [
          {
            id: 1
            title: Local password policy
            description: Local password policy
            collection_cmd: "net accounts | Out-File -Encoding utf8 -Append -FilePath local_passpol.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: true
          },
          {
            id: 2
            title: Domain password policy
            description: Domain password policy
            collection_cmd: "net accounts /domain | Out-File -Encoding utf8 -Append -FilePath domain_passpol.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: true
          },
          {
            id: 3
            title: LAPS
            description: Verifies that LAPS is installed on the workstation
            collection_cmd: "Get-ChildItem 'C:\\Program Files\\LAPS\\CSE\\Admpwd.dll' | Out-File -Encoding utf8 -Append -FilePath laps.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: true
          },
          {
            id: 4
            title: WDigest Authentication
            description:
            '''
            When the WDigest Authentication protocol is enabled, plain text passwords are stored in the Local Security Authority Subsystem Service (LSASS).
            '''
            collection_cmd: "reg.exe query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\Wdigest\" | Out-File -Encoding utf8 -Append -FilePath wdigest.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: false
            checks: [
              {
                id: 1
                title: WDigest Authentication is disabled
                description:
                '''
                When the WDigest Authentication protocol is enabled, plain text passwords are stored in the Local Security Authority Subsystem Service (LSASS) exposing them to theft. WDigest is disabled by default in Windows 10.
                '''
                type: AUDIT_POWERSHELL
                cmd: "reg.exe query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\Wdigest\" /v \"UseLogonCredential\""
                expected: "\\s*UseLogonCredential\\s*REG_DWORD\\s*0x0"
                verification_type: CHECK_REGEX
                severity: medium
                recommendation_on_failed:
                '''
                We recommend enforcing this setting.

                Configure the policy value for <x>Computer Configuration >> Administrative Templates >> MS Security Guide >> "WDigest Authentication"</x> to <x>"Disabled"</x>.
                '''
              }
            ]
          },
          {
            id: 5
            title: LM and NTLM hash
            description:
            '''
            Verification of the feasibility of a cryptanalysis of password fingerprints.
            '''
            collection_cmd: "reg.exe query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\Lsa\" | Out-File -Encoding utf8 -Append -FilePath lsa.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: false
            checks: [
              {
                id: 1
                title: Storage of the LAN Manager hash of passwords is prevented
                description:
                '''
                The LAN Manager hash uses a weak encryption algorithm and there are several tools available that use this hash to retrieve account passwords. This setting controls whether or not a LAN Manager hash of the password is stored in the SAM the next time the password is changed.
                '''
                type: AUDIT_POWERSHELL
                cmd: "reg.exe query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\Lsa\" /v \"NoLMHash\""
                expected: "\\s*NoLMHash\\s*REG_DWORD\\s*0x1"
                verification_type: CHECK_REGEX
                severity: high
                recommendation_on_failed:
                '''
                Configure the policy value for <x>Computer Configuration >> Windows Settings >> Security Settings >> Local Policies >> Security Options >> "Network security: Do not store LAN Manager hash value on next password change"</x> to <x>"Enabled"</x>.
                '''
              },
              {
                id: 2
                title: LanMan authentication level
                description:
                '''
                The Kerberos v5 authentication protocol is the default for authentication of users who are logging on to domain accounts. NTLM, which is less secure, is retained in later Windows versions for compatibility with clients and servers that are running earlier versions of Windows or applications that still use it. It is also used to authenticate logons to stand-alone computers that are running later versions.
                '''
                type: AUDIT_POWERSHELL
                cmd: "reg.exe query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\Lsa\" /v \"LmCompatibilityLevel\""
                expected: "\\s*LmCompatibilityLevel\\s*REG_DWORD\\s*0x5"
                verification_type: CHECK_REGEX
                severity: high
                recommendation_on_failed:
                '''
                Configure the policy value for <x>Computer Configuration >> Windows Settings >> Security Settings >> Local Policies >> Security Options >> "Network security: LAN Manager authentication level"</x> to <x>"Send NTLMv2 response only. Refuse LM & NTLM"</x>.
                '''
              }
            ]
          },
          {
            id: 6
            title: Outgoing secure channel traffic
            description:
            '''
            Requests sent on the secure channel are authenticated, and sensitive information (such as passwords) is encrypted, but not all information is encrypted.
            '''
            collection_cmd: "reg.exe query \"HKLM\\System\\CurrentControlSet\\Services\\Netlogon\\Parameters\" | Out-File -Encoding utf8 -Append -FilePath secure_channel.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: false
            checks: [
              {
                id: 1
                title: Outgoing secure channel traffic must be encrypted when possible
                description:
                '''
                Requests sent on the secure channel are authenticated, and sensitive information (such as passwords) is encrypted, but not all information is encrypted. If this policy is enabled, outgoing secure channel traffic will be encrypted.
                '''
                type: AUDIT_POWERSHELL
                cmd: "reg.exe query \"HKLM\\System\\CurrentControlSet\\Services\\Netlogon\\Parameters\" /v \"SealSecureChannel\""
                expected: "\\s*SealSecureChannel\\s*REG_DWORD\\s*0x1"
                verification_type: CHECK_REGEX
                severity: medium
                recommendation_on_failed:
                '''
                Configure the policy value for <x>Computer Configuration >> Windows Settings >> Security Settings >> Local Policies >> Security Options >> "Domain member: Digitally encrypt secure channel data (when possible)"</x> to <x>"Enabled"</x>.
                '''
              },
              {
                id: 2
                title: Outgoing secure channel traffic must be encrypted or signed
                description:
                '''
                Requests sent on the secure channel are authenticated, and sensitive information (such as passwords) is encrypted, but not all information is encrypted. If this policy is enabled, outgoing secure channel traffic will be encrypted and signed.
                '''
                type: AUDIT_POWERSHELL
                cmd: "reg.exe query \"HKLM\\System\\CurrentControlSet\\Services\\Netlogon\\Parameters\" /v \"RequireSignOrSeal\""
                expected: "\\s*RequireSignOrSeal\\s*REG_DWORD\\s*0x1"
                verification_type: CHECK_REGEX
                severity: medium
                recommendation_on_failed:
                '''
                Configure the policy value for <x>Computer Configuration >> Windows Settings >> Security Settings >> Local Policies >> Security Options >> "Domain member: Digitally encrypt or sign secure channel data (always)"</x> to <x>"Enabled"</x>.
                '''
              }
            ]
          }
        ]
      },
      {
        id: 8
        name: Permissions
        checkpoints: [
          {
            id: 1
            title: Anonymous permissions
            description:
            '''
            Verification of user and share enumeration rights by anonymous users.
            '''
            collection_cmd: "reg.exe query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\Lsa\" | Out-File -Encoding utf8 -Append -FilePath lsa.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: false
            checks: [
              {
                id: 1
                title: Anonymous enumeration of SAM accounts is not allowed
                description:
                '''
                Anonymous enumeration of SAM accounts allows anonymous log on users (null session connections) to list all accounts names, thus providing a list of potential points to attack the system.
                '''
                type: AUDIT_POWERSHELL
                cmd: "reg.exe query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\Lsa\" /v \"RestrictAnonymousSAM\""
                expected: "\\s*RestrictAnonymousSAM\\s*REG_DWORD\\s*0x1"
                verification_type: CHECK_REGEX
                severity: high
                recommendation_on_failed:
                '''
                Configure the policy value for <x>Computer Configuration >> Windows Settings >> Security Settings >> Local Policies >> Security Options >> "Network access: Do not allow anonymous enumeration of SAM accounts"</x> to <x>"Enabled"</x>.
                '''
              },
              {
                id: 2
                title: Anonymous enumeration of shares is restricted
                description:
                '''
                Allowing anonymous logon users (null session connections) to list all account names and enumerate all shared resources can provide a map of potential points to attack the system.
                '''
                type: AUDIT_POWERSHELL
                cmd: "reg.exe query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\Lsa\" /v \"RestrictAnonymous\""
                expected: "\\s*RestrictAnonymous\\s*REG_DWORD\\s*0x1"
                verification_type: CHECK_REGEX
                severity: high
                recommendation_on_failed:
                '''
                Configure the policy value for <x>Computer Configuration >> Windows Settings >> Security Settings >> Local Policies >> Security Options >> "Network access: Do not allow anonymous enumeration of SAM accounts and shares"</x> to <x>"Enabled"</x>.
                '''
              },
              {
                id: 3
                title: Anonymous users do not have the same rights as the Everyone group
                description:
                '''
                Access by anonymous users must be restricted. If this setting is enabled, then anonymous users have the same rights and permissions as the built-in Everyone group. Anonymous users must not have these permissions or rights.
                '''
                type: AUDIT_POWERSHELL
                cmd: "reg.exe query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\Lsa\" /v \"EveryoneIncludesAnonymous\""
                expected: "\\s*EveryoneIncludesAnonymous\\s*REG_DWORD\\s*0x0"
                verification_type: CHECK_REGEX
                severity: medium
                recommendation_on_failed:
                '''
                Configure the policy value for <x>Computer Configuration >> Windows Settings >> Security Settings >> Local Policies >> Security Options >> "Network access: Let Everyone permissions apply to anonymous users"</x> to <x>"Disabled"</x>.
                '''
              }
            ]
          },
          {
            id: 2
            title: Application Logs permissions
            description:
            '''
            Checking the permissions of the Application.evtx file.
            '''
            collection_cmd: "$($f = $env:systemroot + '\\System32\\winevt\\Logs\\Application.evtx'; icacls $f) | Out-File -Encoding utf8 -Append -FilePath application-log-file-perm.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: false
            checks: [
              {
                id: 1
                title: The Application event log must prevent access by non-privileged accounts
                description:
                '''
                Maintaining an audit trail of system activity logs can help identify configuration errors, troubleshoot service disruptions, and analyze compromises that have occurred, as well as detect attacks. Audit logs are necessary to provide a trail of evidence in case the system or network is compromised. The Application event log may be  susceptible to tampering if proper permissions are not applied.
                '''
                type: AUDIT_POWERSHELL
                cmd: "$($f=$env:systemroot + '\\System32\\winevt\\Logs\\Application.evtx'; $acls = (icacls $f); $status = 'Passed'; ForEach ($acl in $acls) { If(!$acl) { continue } ElseIf ($acl -like '*NT AUTHORITY\\SYSTEM:*(F)' -Or $acl -like '*AUTORITE NT\\Syst*me:*(F)') { continue } ElseIf ($acl -like '*BUILTIN\\Administrators:*(F)' -Or $acl -like '*BUILTIN\\Administrateurs:*(F)') { continue } ElseIf ($acl -like '*NT SERVICE\\EventLog:*(F)') { continue } ElseIf ($acl -like 'Successfully processed*' -Or $acl -like '*fichiers correctement*') { continue } $status = 'Failed' }; $acls; '' ; $status)"
                expected: "Passed"
                verification_type: CHECK_REGEX
                severity: high
                recommendation_on_failed:
                '''
                Ensure the permissions on the Application event log (Application.evtx) are configured to prevent standard user accounts or groups from having access. The following permissions satisfy this requirement:

                * Eventlog - Full Control (F)
                * SYSTEM - Full Control (F)
                * Administrators - Full Control (F)
                '''
              }
            ]
          },
        {
            id: 3
            title: Security Logs permissions
            description:
            '''
            Checking the permissions of the Security.evtx file.
            '''
            collection_cmd: "$($f = $env:systemroot + '\\System32\\winevt\\Logs\\Security.evtx'; icacls $f) | Out-File -Encoding utf8 -Append -FilePath security-log-file-perm.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: false
            checks: [
              {
                id: 1
                title: The Security event log must prevent access by non-privileged accounts
                description:
                '''
                Maintaining an audit trail of system activity logs can help identify configuration errors, troubleshoot service disruptions, and analyze compromises that have occurred, as well as detect attacks. Audit logs are necessary to provide a trail of evidence in case the system or network is compromised. The Security event log may disclose sensitive information or be susceptible to tampering if proper permissions are not applied.
                '''
                type: AUDIT_POWERSHELL
                cmd: "$($f=$env:systemroot + '\\System32\\winevt\\Logs\\Security.evtx'; $acls = (icacls $f); $status = 'Passed'; ForEach ($acl in $acls) { If(!$acl) { continue } ElseIf ($acl -like '*NT AUTHORITY\\SYSTEM:*(F)' -Or $acl -like '*AUTORITE NT\\Syst*me:*(F)') { continue } ElseIf ($acl -like '*BUILTIN\\Administrators:*(F)' -Or $acl -like '*BUILTIN\\Administrateurs:*(F)') { continue } ElseIf ($acl -like '*NT SERVICE\\EventLog:*(F)') { continue } ElseIf ($acl -like 'Successfully processed*' -Or $acl -like '*fichiers correctement*') { continue } $status = 'Failed' }; $acls; '' ; $status)"
                expected: "Passed"
                verification_type: CHECK_REGEX
                severity: high
                recommendation_on_failed:
                '''
                Ensure the permissions on the Security event log (Security.evtx) are configured to prevent standard user accounts or groups from having access. The following permissions satisfy this requirement:

                * Eventlog - Full Control (F)
                * SYSTEM - Full Control (F)
                * Administrators - Full Control (F)
                '''
              }
            ]
          },
          {
            id: 4
            title: System Logs permissions
            description:
            '''
            Checking the permissions of the System.evtx file.
            '''
            collection_cmd: "$($f = $env:systemroot + '\\System32\\winevt\\Logs\\System.evtx'; icacls $f) | Out-File -Encoding utf8 -Append -FilePath system-log-file-perm.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: false
            checks: [
              {
                id: 1
                title: The System event log must prevent access by non-privileged accounts
                description:
                '''
                Maintaining an audit trail of system activity logs can help identify configuration errors, troubleshoot service disruptions, and analyze compromises that have occurred, as well as detect attacks. Audit logs are necessary to provide a trail of evidence in case the system or network is compromised. The System event log may be susceptible to tampering if proper permissions are not applied.
                '''
                type: AUDIT_POWERSHELL
                cmd: "$($f=$env:systemroot + '\\System32\\winevt\\Logs\\System.evtx'; $acls = (icacls $f); $status = 'Passed'; ForEach ($acl in $acls) { If(!$acl) { continue } ElseIf ($acl -like '*NT AUTHORITY\\SYSTEM:*(F)' -Or $acl -like '*AUTORITE NT\\Syst*me:*(F)') { continue } ElseIf ($acl -like '*BUILTIN\\Administrators:*(F)' -Or $acl -like '*BUILTIN\\Administrateurs:*(F)') { continue } ElseIf ($acl -like '*NT SERVICE\\EventLog:*(F)') { continue } ElseIf ($acl -like 'Successfully processed*' -Or $acl -like '*fichiers correctement*') { continue } $status = 'Failed' }; $acls; '' ; $status)"
                expected: "Passed"
                verification_type: CHECK_REGEX
                severity: high
                recommendation_on_failed:
                '''
                Ensure the permissions on the System event log (System.evtx) are configured to prevent standard user accounts or groups from having access. The following permissions satisfy this requirement:

                * Eventlog - Full Control (F)
                * SYSTEM - Full Control (F)
                * Administrators - Full Control (F)
                '''
              }
            ]
          },
          {
            id: 5
            title: <x>HiveNightmare CVE-2021-36934</x>
            description:
            '''
            Since <x>Windows 10 build 1809</x>, the Access Control Lists (ACLs) for <x>%windir%\System32\config</x> have been granting read access to non-admin users.
            '''
            collection_cmd: "$($base = $env:systemroot + '\\System32\\config\\'; $sam = $base + 'SAM'; $security = $base + 'SECURITY'; $system = $base + 'SYSTEM'; icacls $sam; icacls $security; icacls $system) | Out-File -Encoding utf8 -Append -FilePath hivenightmare.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: false
            checks: [
              {
                id: 1
                title: <x>HiveNightmare (SAM)</x>
                description:
                '''
                Since <x>Windows 10 build 1809</x>, the Access Control Lists (ACLs) for <x>%windir%\System32\config</x> have been granting read access to non-admin users.

                An attacker with the ability to execute code on a target host could exploit this vulnerability to elevate their privileges to SYSTEM.
                '''
                type: AUDIT_POWERSHELL
                cmd: "$($f=$env:systemroot + '\\System32\\config\\SAM'; $acls = (icacls $f); $status = 'Passed'; ForEach ($acl in $acls) { If(!$acl) { continue } ElseIf ($acl -like '*NT AUTHORITY\\SYSTEM:*(F)' -Or $acl -like '*AUTORITE NT\\Syst*me:*(F)') { continue } ElseIf ($acl -like '*BUILTIN\\Administrators:*(F)' -Or $acl -like '*BUILTIN\\Administrateurs:*(F)') { continue } ElseIf ($acl -like 'Successfully processed*' -Or $acl -like '*fichiers correctement*') { continue } $status = 'Failed' }; $acls; '' ; $status)"
                expected: "Passed"
                verification_type: CHECK_REGEX
                severity: high
                recommendation_on_failed:
                '''
                We recommend installing the security patch and manually deleting all snapshots of system files, including the SAM database.

                It is important to note that installing the security patch alone is not sufficient.
                '''
                see_also: https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-36934
              },
              {
                id: 2
                title: <x>HiveNightmare (SECURITY)</x>
                description:
                '''
                Since <x>Windows 10 build 1809</x>, the Access Control Lists (ACLs) for <x>%windir%\System32\config</x> have been granting read access to non-admin users.

                An attacker with the ability to execute code on a target host could exploit this vulnerability to elevate their privileges to SYSTEM.
                '''
                type: AUDIT_POWERSHELL
                cmd: "$($f=$env:systemroot + '\\System32\\config\\SECURITY'; $acls = (icacls $f); $status = 'Passed'; ForEach ($acl in $acls) { If(!$acl) { continue } ElseIf ($acl -like '*NT AUTHORITY\\SYSTEM:*(F)' -Or $acl -like '*AUTORITE NT\\Syst*me:*(F)') { continue } ElseIf ($acl -like '*BUILTIN\\Administrators:*(F)' -Or $acl -like '*BUILTIN\\Administrateurs:*(F)') { continue } ElseIf ($acl -like 'Successfully processed*' -Or $acl -like '*fichiers correctement*') { continue } $status = 'Failed' }; $acls; '' ; $status)"
                expected: "Passed"
                verification_type: CHECK_REGEX
                severity: high
                recommendation_on_failed:
                '''
                We recommend installing the security patch and manually deleting all snapshots of system files, including the SAM database.

                It is important to note that installing the security patch alone is not sufficient.
                '''
                see_also: https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-36934
              },
              {
                id: 3
                title: <x>HiveNightmare (SYSTEM)</x>
                description:
                '''
                Since <x>Windows 10 build 1809</x>, the Access Control Lists (ACLs) for <x>%windir%\System32\config</x> have been granting read access to non-admin users.

                An attacker with the ability to execute code on a target host could exploit this vulnerability to elevate their privileges to SYSTEM.
                '''
                type: AUDIT_POWERSHELL
                cmd: "$($f=$env:systemroot + '\\System32\\config\\SYSTEM'; $acls = (icacls $f); $status = 'Passed'; ForEach ($acl in $acls) { If(!$acl) { continue } ElseIf ($acl -like '*NT AUTHORITY\\SYSTEM:*(F)' -Or $acl -like '*AUTORITE NT\\Syst*me:*(F)') { continue } ElseIf ($acl -like '*BUILTIN\\Administrators:*(F)' -Or $acl -like '*BUILTIN\\Administrateurs:*(F)') { continue } ElseIf ($acl -like 'Successfully processed*' -Or $acl -like '*fichiers correctement*') { continue } $status = 'Failed' }; $acls; '' ; $status)"
                expected: "Passed"
                verification_type: CHECK_REGEX
                severity: high
                recommendation_on_failed:
                '''
                We recommend installing the security patch and manually deleting all snapshots of system files, including the SAM database.

                It is important to note that installing the security patch alone is not sufficient.
                '''
                see_also: https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-36934
              }
            ]
          },
          {
            id: 6
            title: The Windows Installer Always install with elevated privileges must be disabled
            description:
            '''
            Standard user accounts must not be granted elevated privileges.
            '''
            collection_cmd: "reg.exe query \"HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\Installer\" /v \"AlwaysInstallElevated\" | Out-File -Encoding utf8 -Append -FilePath always_install_elevated.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: false
            checks: [
              {
                id: 1
                title: AlwaysInstallElevated is not enabled
                description:
                '''
                Standard user accounts must not be granted elevated privileges. Enabling Windows Installer to elevate privileges when installing applications can allow malicious persons and applications to gain full control of a system.
                '''
                type: AUDIT_POWERSHELL
                cmd: "reg.exe query \"HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\Installer\" /v \"AlwaysInstallElevated\""
                expected: "\\s*AlwaysInstallElevated\\s*REG_DWORD\\s*0x0"
                verification_type: CHECK_REGEX
                severity: high
                recommendation_on_failed:
                '''
                Configure the policy value for <x>Computer Configuration >> Administrative Templates >> Windows Components >> Windows Installer >> "Always install with elevated privileges"</x> to <x>"Disabled"</x>.
                '''
              }
            ]
          },
          {
            id: 7
            title: <x>Services ACLs</x>
            description:
            '''
            Verification of the ACLs for the different services.
            '''
            collection_cmd: "$($services = Get-WmiObject -Namespace root\\cimv2 -Class Win32_service | Select-Object -Property Name, PathName; ForEach ($service in $services) { icacls $service.PathName }) | Out-File -Encoding utf8 -Append -FilePath updates_list.csv"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: true
          },
        ]
      },
      {
        id: 9
        name: Software - Services - Tasks
        checkpoints: [
          {
            id: 1
            title: Installed products
            description:
            '''
            Verification of the legitimacy of the installed programs as well as the presence of known vulnerability in the versions used.
            '''
            collection_cmd: "wmic.exe product list full /format:csv | Out-File -Encoding utf8 -Append -FilePath products.csv"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: false
            checks: [
              {
                id: 1
                title: Internet Information System (IIS) or its subcomponents is not installed
                description:
                '''
                Installation of Internet Information System (IIS) may allow unauthorized internet services to be hosted. Websites must only be hosted on servers that have been designed for that purpose and can be adequately secured.
                '''
                type: AUDIT_POWERSHELL
                cmd: "Get-WindowsOptionalFeature -online | where {$_.FeatureName -eq \"IIS-WebServer\" -and $_.State -eq \"Enabled\"} | format-list"
                expected: ""
                verification_type: CHECK_EXACT
                severity: high
                recommendation_on_failed:
                '''
                Uninstall <x>"Internet Information Services"</x> or <x>"Internet Information Services Hostable Web Core"</x> from the system.
                '''
              }
            ]
          },
          {
            id: 2
            title: Services
            description:
            '''
            Verification of the legitimacy of active services in relation to business needs.
            '''
            collection_cmd: "Get-WmiObject -Namespace root\\cimv2 -Class Win32_service | Select-Object -Property * | Out-File -Encoding utf8 -Append -FilePath service.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: true
          },
          {
            id: 3
            title: Tasks list
            description:
            '''
            Verification of the legitimacy of active processes in relation to business needs.
            '''
            collection_cmd: "tasklist.exe | Out-File -Encoding utf8 -Append -FilePath tasklist.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: true
          },
          {
            id: 4
            title: Scheduled tasks
            description:
            '''
            Verification of the legitimacy of active scheduled tasks in relation to business needs.
            '''
            collection_cmd: "schtasks.exe /query /V /FO CSV | ConvertFrom-Csv | Select-Object @{ label=\"Name\"; expression={ split-path $_.taskname -Leaf } },@{ label=\"Nom\"; expression={ split-path $_.\"Nom de la tche\" -Leaf } },Author,Auteur,\"run as user\",\"Excuter en tant qu'utilisateur\",\"task to run\",\"Tche  excuter\" | Export-CSV -NoTypeInformation -Path scheduled-task.csv"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: true
          }
        ]
      },
      {
        id: 10
        name: Network
        checkpoints: [
          {
            id: 1
            title: Network configuration
            description: Displays all current TCP/IP network configuration values
            collection_cmd: "ipconfig.exe /all | Out-File -Encoding utf8 -Append -FilePath ipconfig.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: true
          },
          {
            id: 2
            title: Network shares
            description: List network shares
            collection_cmd: "net.exe share | Out-File -Encoding utf8 -Append -FilePath share.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: true
          },
          {
            id: 3
            title: Network connections
            description: Displays all active connections
            collection_cmd: "netstat.exe -anb | Out-File -Encoding utf8 -Append -FilePath netstat.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: true
          },
          {
            id: 4
            title: Time synchronization
            description: Displays the NTP configuration
            collection_cmd: "w32tm.exe /query /status | Out-File -Encoding utf8 -Append -FilePath ntp.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: true
          },
          {
            id: 5
            title: Proxy settings
            description: Displays the proxy configuration
            collection_cmd: "reg.exe query \"HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\" | Out-File -Encoding utf8 -Append -FilePath proxy.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: true
          },
          {
            id: 6
            title: Proxy settings (WPAD)
            description: Displays the proxy configuration
            collection_cmd: "reg.exe query \"HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\Wpad\" | Out-File -Encoding utf8 -Append -FilePath proxy_wpad.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: true
          },
          {
            id: 7
            title: SMB Client
            description: Displays the SMB configuration - Client side
            collection_cmd: "reg.exe query \"HKLM\\System\\Currentcontrolset\\Services\\Lanmanworkstation\\Parameters\" | Out-File -Encoding utf8 -Append -FilePath smb_client.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: false
            checks: [
              {
                id: 1
                title: The Windows SMB client perform SMB packet signing
                description:
                '''
                The server message block (SMB) protocol provides the basis for many network operations. Digitally signed SMB packets aid in preventing man-in-the-middle attacks. If this policy is enabled, the SMB client will only communicate with an SMB server that performs SMB packet signing.
                '''
                type: AUDIT_POWERSHELL
                cmd: "reg.exe query \"HKLM\\System\\Currentcontrolset\\Services\\Lanmanworkstation\\Parameters\" /v \"RequireSecuritySignature\""
                expected: "\\s*RequireSecuritySignature\\s*REG_DWORD\\s*0x1"
                verification_type: CHECK_REGEX
                severity: medium
                recommendation_on_failed:
                '''
                Configure the policy value for <x>Computer Configuration >> Windows Settings >> Security Settings >> Local Policies >> Security Options >> "Microsoft network client: Digitally sign communications (always)"</x> to <x>"Enabled"</x>.
                '''
              },
              {
                id: 2
                title: Unencrypted passwords are not sent to third-party SMB Servers
                description:
                '''
                Some non-Microsoft SMB servers only support unencrypted (plain text) password authentication. Sending plain text passwords across the network, when authenticating to an SMB server, reduces the overall security of the environment. Check with the vendor of the SMB server to see if there is a way to support encrypted password authentication.
                '''
                type: AUDIT_POWERSHELL
                cmd: "reg.exe query \"HKLM\\System\\Currentcontrolset\\Services\\Lanmanworkstation\\Parameters\" /v \"EnablePlainTextPassword\""
                expected: "\\s*EnablePlainTextPassword\\s*REG_DWORD\\s*0x0"
                verification_type: CHECK_REGEX
                severity: medium
                recommendation_on_failed:
                '''
                Configure the policy value for <x>Computer Configuration >> Windows Settings >> Security Settings >> Local Policies >> Security Options >> "Microsoft network client: Send unencrypted password to third-party SMB servers"</x> to <x>"Disabled"</x>.
                '''
              },
              {
                id: 3
                title: SMBv1 protocol is disabled on the SMB client
                description:
                '''
                SMBv1 is a legacy protocol that uses the MD5 algorithm as part of SMB. MD5 is known to be vulnerable to a number of attacks such as collision and preimage attacks as well as not being FIPS compliant.
                '''
                type: AUDIT_POWERSHELL
                cmd: "reg.exe query \"HKLM\\System\\Currentcontrolset\\Services\\Mrxsmb10\" /v \"Start\""
                expected: "\\s*Start\\s*REG_DWORD\\s*0x4"
                verification_type: CHECK_REGEX
                severity: medium
                recommendation_on_failed:
                '''
                We recommend disabling SMBv1 support.

                Note: Disabling SMBv1 support may prevent access to file or print sharing resources with systems or devices that only support SMBv1. File shares and print services hosted on Windows Server 2003 are an example, however Windows Server 2003 is no longer a supported operating system. Some older Network Attached Storage (NAS) devices may only support SMBv1.
                '''
              },
              {
                id: 4
                title: SMBv1 protocol is disabled on the system
                description:
                '''
                SMBv1 is a legacy protocol that uses the MD5 algorithm as part of SMB. MD5 is known to be vulnerable to a number of attacks such as collision and preimage attacks as well as not being FIPS compliant.
                '''
                type: AUDIT_POWERSHELL
                cmd: "Get-WindowsOptionalFeature -Online -FeatureName SMB1Protocol | Select-Object State | FL"
                expected: "State\\s+:\\s+Disabled"
                verification_type: CHECK_REGEX
                severity: medium
                recommendation_on_failed:
                '''
                Disable the SMBv1 protocol.

                Run 'Windows PowerShell' with elevated privileges (run as administrator).

                Enter the following:
                <x>Disable-WindowsOptionalFeature -Online -FeatureName SMB1Protocol</x>

                Note: Disabling SMBv1 support may prevent access to file or print sharing resources with systems or devices that only support SMBv1. File shares and print services hosted on Windows Server 2003 are an example, however Windows Server 2003 is no longer a supported operating system. Some older Network Attached Storage (NAS) devices may only support SMBv1.
                '''
              }
            ]
          },
          {
            id: 8
            title: SMB Server
            description: Displays the SMB configuration - Server side
            collection_cmd: "reg.exe query \"HKLM\\System\\Currentcontrolset\\Services\\Lanmanserver\\Parameters\" | Out-File -Encoding utf8 -Append -FilePath smb_server.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: false
            checks: [
              {
                id: 1
                title: The Windows SMB server perform SMB packet signing
                description:
                '''
                The server message block (SMB) protocol provides the basis for many network operations.  Digitally signed SMB packets aid in preventing man-in-the-middle attacks. If this policy is enabled, the SMB server will only communicate with an SMB client that performs SMB packet signing.
                '''
                type: AUDIT_POWERSHELL
                cmd: "reg.exe query \"HKLM\\System\\Currentcontrolset\\Services\\Lanmanserver\\Parameters\" /v \"RequireSecuritySignature\""
                expected: "\\s*RequireSecuritySignature\\s*REG_DWORD\\s*0x1"
                verification_type: CHECK_REGEX
                severity: medium
                recommendation_on_failed:
                '''
                Configure the policy value for <x>Computer Configuration >> Windows Settings >> Security Settings >> Local Policies >> Security Options >> "Microsoft network server: Digitally sign communications (always)"</x> to <x>"Enabled"</x>.
                '''
              },
              {
                id: 2
                title: Anonymous access to Named Pipes and Shares is restricted
                description:
                '''
                Allowing anonymous access to named pipes or shares provides the potential for unauthorized system access. This setting restricts access to those defined in "Network access: Named Pipes that can be accessed anonymously" and "Network access: Shares that can be accessed anonymously", both of which must be blank under other requirements.
                '''
                type: AUDIT_POWERSHELL
                cmd: "reg.exe query \"HKLM\\System\\Currentcontrolset\\Services\\Lanmanserver\\Parameters\" /v \"RestrictNullSessAccess\""
                expected: "\\s*RestrictNullSessAccess\\s*REG_DWORD\\s*0x1"
                verification_type: CHECK_REGEX
                severity: medium
                recommendation_on_failed:
                '''
                Configure the policy value for <x>Computer Configuration >> Windows Settings >> Security Settings >> Local Policies >> Security Options >> "Network access: Restrict anonymous access to Named Pipes and Shares"</x> to <x>"Enabled"</x>.
                '''
              },
              {
                id: 3
                title: SMBv1 protocol is disabled
                description:
                '''
                SMBv1 is a legacy protocol that uses the MD5 algorithm as part of SMB. MD5 is known to be vulnerable to a number of attacks such as collision and preimage attacks as well as not being FIPS compliant.
                '''
                type: AUDIT_POWERSHELL
                cmd: "reg.exe query \"HKLM\\System\\Currentcontrolset\\Services\\Lanmanserver\\Parameters\" /v \"SMB1\""
                expected: "\\s*SMB1\\s*REG_DWORD\\s*0x0"
                verification_type: CHECK_REGEX
                severity: medium
                recommendation_on_failed:
                '''
                Configure the policy value for <x>Computer Configuration >> Administrative Templates >> MS Security Guide >> "Configure SMBv1 Server"</x> to <x>"Disabled"</x>.

                Note: Disabling SMBv1 support may prevent access to file or print sharing resources with systems or devices that only support SMBv1. File shares and print services hosted on Windows Server 2003 are an example, however Windows Server 2003 is no longer a supported operating system. Some older network attached devices may only support SMBv1.
                '''
              }
            ]
          }
        ]
      },
      {
        id: 11
        name: Firewall
        checkpoints: [
          {
            id: 1
            title: Firewall is enabled
            description: Checks that the system firewall is active
            collection_cmd: "netsh.exe advfirewall show allprofiles | Out-File -Encoding utf8 -Append -FilePath firewall_profile.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: false
            checks: [
              {
                id: 1
                title: All profiles are enabled
                description:
                '''
                An operating system without a firewall is more exposed to attacks from the local network.
                '''
                type: AUDIT_POWERSHELL
                cmd: "$($profiles = Get-NetFirewallProfile | Select Enabled; If ($profiles | where {$_.Enabled -eq 'False'}) { 'False' } Else { 'True' })"
                expected: "True"
                verification_type: CHECK_EXACT
                severity: medium
                recommendation_on_failed:
                '''
                We recommend enabling the operating system firewall. Even when compartmentalization is defined (use of <x>VLANs</x>, filtering rules, etc.), the use of a local firewall allows to limit the exposure of the system to attacks coming from the same subnet.
                '''
              }
            ]
          },
          {
            id: 2
            title: Inbound Rules
            description: Dumps the active inbound rules for analyzis
            collection_cmd: "Get-NetFirewallRule | where-object {$_.direction -eq 'Inbound' -And $_.enabled -eq 'True'} | Out-File -Encoding utf8 -Append -FilePath inbound_rules.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: true
          }
        ]
      },
      {
        id: 12
        name: Logging
        checkpoints: [
          {
            id: 1
            title: Audit policy
            description: Dumps the audit policy for analyzis
            collection_cmd: "auditpol.exe /get /category:* | Out-File -Encoding utf8 -Append -FilePath audit_policy.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: true
          },
          {
            id: 2
            title: Application event log
            description: Dumps the application event log for analyzis
            collection_cmd: "wevtutil.exe get-log Application | Out-File -Encoding utf8 -Append -FilePath log_application.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: false
            checks: [
              {
                id: 1
                title: Application event log size
                description:
                '''
                <x>FIXME_AUDITOR: If the system is configured to send audit records directly to an audit server, this is NA</x>
                Inadequate log size will cause the log to fill up quickly. This may prevent audit events from being recorded properly and require frequent attention by administrative personnel.
                '''
                type: AUDIT_POWERSHELL
                cmd: "reg.exe query \"HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\EventLog\\Application\" /v \"MaxSize\""
                expected: "\\s*MaxSize\\s*REG_DWORD\\s*(?![0-3][0-2][0-7][0-6][0-7]$)([0-9]{5,11})"
                verification_type: CHECK_REGEX
                severity: medium
                recommendation_on_failed:
                '''
                Configure the policy value for <x>Computer Configuration >> Administrative Templates >> Windows Components >> Event Log Service >> Application >> "Specify the maximum log file size (KB)"</x> to <x>"Enabled"</x> with a <x>"Maximum Log Size (KB)"</x> of "32768" or greater.
                '''
              }
            ]
          },
          {
            id: 3
            title: Security event log
            description: Dumps the application event log for analyzis
            collection_cmd: "wevtutil.exe get-log Security | Out-File -Encoding utf8 -Append -FilePath log_security.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: false
            checks: [
              {
                id: 1
                title: Security event log size
                description:
                '''
                <x>FIXME_AUDITOR: If the system is configured to send audit records directly to an audit server, this is NA</x>
                Inadequate log size will cause the log to fill up quickly.  This may prevent audit events from being recorded properly and require frequent attention by administrative personnel.
                '''
                type: AUDIT_POWERSHELL
                cmd: "reg.exe query \"HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\EventLog\\Security\" /v \"MaxSize\""
                expected: "\\s*MaxSize\\s*REG_DWORD\\s*(?![0-1]0[0-2][0-3][0-9]{3}$)([0-9]{7,11})"
                verification_type: CHECK_REGEX
                severity: medium
                recommendation_on_failed:
                '''
                Configure the policy value for <x>Computer Configuration >> Administrative Templates >> Windows Components >> Event Log Service >> Security >> "Specify the maximum log file size (KB)"</x> to <x>"Enabled"</x> with a <x>"Maximum Log Size (KB)"</x> of "1024000" or greater.
                '''
              }
            ]
          },
          {
            id: 4
            title: System event log
            description: Dumps the application event log for analyzis
            collection_cmd: "wevtutil.exe get-log System | Out-File -Encoding utf8 -Append -FilePath log_system.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: false
            checks: [
              {
                id: 1
                title: System event log size
                description:
                '''
                <x>FIXME_AUDITOR: If the system is configured to send audit records directly to an audit server, this is NA</x>
                Inadequate log size will cause the log to fill up quickly.  This may prevent audit events from being recorded properly and require frequent attention by administrative personnel.
                '''
                type: AUDIT_POWERSHELL
                cmd: "reg.exe query \"HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\EventLog\\System\" /v \"MaxSize\""
                expected: "\\s*MaxSize\\s*REG_DWORD\\s*(?![0-3][0-2][0-7][0-6][0-7]$)([0-9]{5,11})"
                verification_type: CHECK_REGEX
                severity: medium
                recommendation_on_failed:
                '''
                Configure the policy value for <x>Computer Configuration >> Administrative Templates >> Windows Components >> Event Log Service >> System >> "Specify the maximum log file size (KB)"</x> to <x>"Enabled"</x> with a <x>"Maximum Log Size (KB)"</x> of "32768" or greater.
                '''
              }
            ]
          }
        ]
      },
      {
        id: 13
        name: Software configuration
        checkpoints: [
          {
            id: 1
            title: WinRM Client
            description: Displays the WinRM configuration - Client side
            collection_cmd: "reg.exe query \"HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\WinRM\\Client\" | Out-File -Encoding utf8 -Append -FilePath winrm_client.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: false
            checks: [
              {
                id: 1
                title: WinRM client do not use Basic authentication
                description:
                '''
                Basic authentication uses plain text passwords that could be used to compromise a system.
                '''
                type: AUDIT_POWERSHELL
                cmd: "reg.exe query \"HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\WinRM\\Client\" /v \"AllowBasic\""
                expected: "\\s*AllowBasic\\s*REG_DWORD\\s*0x0"
                verification_type: CHECK_REGEX
                severity: high
                recommendation_on_failed:
                '''
                Configure the policy value for <x>Computer Configuration >> Administrative Templates >> Windows Components >> Windows Remote Management (WinRM) >> WinRM Client >> "Allow Basic authentication"</x> to <x>"Disabled"</x>.
                '''
              }
            ]
          },
          {
            id: 2
            title: WinRM Service
            description: Displays the WinRM configuration - Service side
            collection_cmd: "reg.exe query \"HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\WinRM\\Service\" | Out-File -Encoding utf8 -Append -FilePath winrm_client.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: false
            checks: [
              {
                id: 1
                title: WinRM service do not use Basic authentication
                description:
                '''
                Basic authentication uses plain text passwords that could be used to compromise a system.
                '''
                type: AUDIT_POWERSHELL
                cmd: "reg.exe query \"HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\WinRM\\Service\" /v \"AllowBasic\""
                expected: "\\s*AllowBasic\\s*REG_DWORD\\s*0x0"
                verification_type: CHECK_REGEX
                severity: high
                recommendation_on_failed:
                '''
                Configure the policy value for <x>Computer Configuration >> Administrative Templates >> Windows Components >> Windows Remote Management (WinRM) >> WinRM Service >> "Allow Basic authentication"</x> to <x>"Disabled"</x>.
                '''
              }
            ]
          },
          {
            id: 3
            title: Remote Desktop
            description: Displays the Remote Desktop configuration
            collection_cmd: "reg.exe query \"HKLM\\Software\\Policies\\Microsoft\\Windows Nt\\Terminal Services\" | Out-File -Encoding utf8 -Append -FilePath remote_desktop.txt"
            collection_cmd_type: AUDIT_POWERSHELL
            collect_only: false
            checks: [
              {
                id: 1
                title: Solicited Remote Assistance is not allowed
                description:
                '''
                Remote assistance allows another user to view or take control of the local session of a user. Solicited assistance is help that is specifically requested by the local user. This may allow unauthorized parties access to the resources on the computer.
                '''
                type: AUDIT_POWERSHELL
                cmd: "reg.exe query \"HKLM\\Software\\Policies\\Microsoft\\Windows Nt\\Terminal Services\" /v \"fAllowToGetHelp\""
                expected: "\\s*fAllowToGetHelp\\s*REG_DWORD\\s*0x0"
                verification_type: CHECK_REGEX
                severity: high
                recommendation_on_failed:
                '''
                Configure the policy value for <x>Computer Configuration >> Administrative Templates >> System >> Remote Assistance >> "Configure Solicited Remote Assistance"</x> to <x>"Disabled"</x>.
                '''
              },
              {
                id: 2
                title: Passwords are not saved in the Remote Desktop Client
                description:
                '''
                Saving passwords in the Remote Desktop Client could allow an unauthorized user to establish a remote desktop session to another system. The system must be configured to prevent users from saving passwords in the Remote Desktop Client.
                '''
                type: AUDIT_POWERSHELL
                cmd: "reg.exe query \"HKLM\\Software\\Policies\\Microsoft\\Windows Nt\\Terminal Services\" /v \"DisablePasswordSaving\""
                expected: "\\s*DisablePasswordSaving\\s*REG_DWORD\\s*0x1"
                verification_type: CHECK_REGEX
                severity: medium
                recommendation_on_failed:
                '''
                Configure the policy value for <x>Computer Configuration >> Administrative Templates >> Windows Components >> Remote Desktop Services >> Remote Desktop Connection Client >> "Do not allow passwords to be saved"</x> to <x>"Enabled"</x>.
                '''
              },
              {
                id: 3
                title: Local drives are prevented from sharing with Remote Desktop Session Hosts
                description:
                '''
                Preventing users from sharing the local drives on their client computers to Remote Session Hosts that they access helps reduce possible exposure of sensitive data.
                '''
                type: AUDIT_POWERSHELL
                cmd: "reg.exe query \"HKLM\\Software\\Policies\\Microsoft\\Windows Nt\\Terminal Services\" /v \"fDisableCdm\""
                expected: "\\s*fDisableCdm\\s*REG_DWORD\\s*0x1"
                verification_type: CHECK_REGEX
                severity: medium
                recommendation_on_failed:
                '''
                Configure the policy value for <x>Computer Configuration >> Administrative Templates >> Windows Components >> Remote Desktop Services >> Remote Desktop Session Host >> Device and Resource Redirection >> "Do not allow drive redirection"</x> to <x>"Enabled"</x>.
                '''
              },
              {
                id: 4
                title: Remote Desktop Services always prompt a client for passwords upon connection
                description:
                '''
                This setting controls the ability of users to supply passwords automatically as part of their remote desktop connection. Disabling this setting would allow anyone to use the stored credentials in a connection item to connect to the terminal server.
                '''
                type: AUDIT_POWERSHELL
                cmd: "reg.exe query \"HKLM\\Software\\Policies\\Microsoft\\Windows Nt\\Terminal Services\" /v \"fPromptForPassword\""
                expected: "\\s*fPromptForPassword\\s*REG_DWORD\\s*0x1"
                verification_type: CHECK_REGEX
                severity: medium
                recommendation_on_failed:
                '''
                Configure the policy value for <x>Computer Configuration >> Administrative Templates >> Windows Components >> Remote Desktop Services >> Remote Desktop Session Host >> Security >> "Always prompt for password upon connection"</x> to <x>"Enabled"</x>.
                '''
              },
              {
                id: 5
                title: The Remote Desktop Session Host require secure RPC communications
                description:
                '''
                Allowing unsecure RPC communication exposes the system to man in the middle attacks and data disclosure attacks. A man in the middle attack occurs when an intruder captures packets between a client and server and modifies them before allowing the packets to be exchanged. Usually the attacker will modify the information in the packets in an attempt to cause either the client or server to reveal sensitive information.
                '''
                type: AUDIT_POWERSHELL
                cmd: "reg.exe query \"HKLM\\Software\\Policies\\Microsoft\\Windows Nt\\Terminal Services\" /v \"fEncryptRPCTraffic\""
                expected: "\\s*fEncryptRPCTraffic\\s*REG_DWORD\\s*0x1"
                verification_type: CHECK_REGEX
                severity: medium
                recommendation_on_failed:
                '''
                Configure the policy value for <x>Computer Configuration >> Administrative Templates >> Windows Components >> Remote Desktop Services >> Remote Desktop Session Host >> Security "Require secure RPC communication"</x> to <x>"Enabled"</x>.
                '''
              },
              {
                id: 6
                title: Remote Desktop Services is configured with the client connection encryption set to the required level
                description:
                '''
                Remote connections must be encrypted to prevent interception of data or sensitive information. Selecting "High Level" will ensure encryption of Remote Desktop Services sessions in both directions.
                '''
                type: AUDIT_POWERSHELL
                cmd: "reg.exe query \"HKLM\\Software\\Policies\\Microsoft\\Windows Nt\\Terminal Services\" /v \"MinEncryptionLevel\""
                expected: "\\s*MinEncryptionLevel\\s*REG_DWORD\\s*0x3"
                verification_type: CHECK_REGEX
                severity: medium
                recommendation_on_failed:
                '''
                Configure the policy value for <x>Computer Configuration >> Administrative Templates >> Windows Components >> Remote Desktop Services >> Remote Desktop Session Host >> Security >> "Set client connection encryption level" to "Enabled"</x> and <x>"High Level"</x>.
                '''
              }
            ]
          }
        ]
      }
    ]
  }
]
